<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Structure and Interpretation of Computer Programs (SICP)</title>
<!-- 2015-04-14 Tue 14:41 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Peter Danenberg" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Structure and Interpretation of Computer Programs (SICP)</h1>
<p>
We’re running an <a href="http://mitpress.mit.edu/sicp/full-text/book/book.html">SICP</a> reading group on Mondays from 5:30 to 7:00 at
<a href="https://map.googleplex.com/?q=type:confroom%2520location_id:US-MTV-2000-3-306">MTV-2000-3-Rancho San Antonio</a>!
</p>

<p>
<a href="https://www.google.com/calendar/event?action=TEMPLATE&tmeid=dm12dWxwMXNhYXU1dTFmcTJwbThmYWRvczhfMjAxNDA2MjRUMDAzMDAwWiBnb29nbGUuY29tX2VwNmRyYnFkbmV0Mmg3djc0MzU0M2RlY2cwQGc&tmsrc=google.com_ep6drbqdnet2h7v743543decg0%2540group.calendar.google.com">Add us to your calendar</a>, <a href="https://groups.google.com/a/google.com/forum/#!forum/sicp-reading-group">subscribe to the group</a> (for Googlers) or
<a href="http://csrg.org">visit the meetup</a> (for everyone).
</p>

<iframe src= "https://www.google.com/calendar/embed?showTitle=0&amp;showNav=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;mode=AGENDA&amp;height=256&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=google.com_ep6drbqdnet2h7v743543decg0%40group.calendar.google.com&amp;color=%2342104A&amp;ctz=America%2FLos_Angeles" style= " border-width:0 " width= "512" height= "256" frameborder= "0" scrolling= "no"></iframe>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Chapter 1</a>
<ul>
<li><a href="#sec-1-1">1.1. <span class="done DONE">DONE</span> 1.1</a></li>
<li><a href="#sec-1-2">1.2. <span class="done DONE">DONE</span> 1.2</a></li>
<li><a href="#sec-1-3">1.3. <span class="done DONE">DONE</span> 1.3</a></li>
<li><a href="#sec-1-4">1.4. <span class="done DONE">DONE</span> 1.4</a></li>
<li><a href="#sec-1-5">1.5. <span class="done DONE">DONE</span> 1.5</a></li>
<li><a href="#sec-1-6">1.6. <span class="done DONE">DONE</span> 1.6</a></li>
<li><a href="#sec-1-7">1.7. <span class="done DONE">DONE</span> 1.7</a></li>
<li><a href="#sec-1-8">1.8. <span class="done DONE">DONE</span> 1.8</a></li>
<li><a href="#sec-1-9">1.9. <span class="done DONE">DONE</span> 1.9</a></li>
<li><a href="#sec-1-10">1.10. <span class="done DONE">DONE</span> 1.10</a></li>
<li><a href="#sec-1-11">1.11. <span class="done DONE">DONE</span> 1.11</a></li>
<li><a href="#sec-1-12">1.12. <span class="done DONE">DONE</span> 1.12</a></li>
<li><a href="#sec-1-13">1.13. <span class="done DONE">DONE</span> 1.13</a></li>
<li><a href="#sec-1-14">1.14. <span class="done DONE">DONE</span> 1.14</a></li>
<li><a href="#sec-1-15">1.15. <span class="done DONE">DONE</span> 1.15</a></li>
<li><a href="#sec-1-16">1.16. <span class="done DONE">DONE</span> 1.16</a></li>
<li><a href="#sec-1-17">1.17. <span class="done DONE">DONE</span> 1.17</a></li>
<li><a href="#sec-1-18">1.18. <span class="done DONE">DONE</span> 1.18</a></li>
<li><a href="#sec-1-19">1.19. <span class="done DONE">DONE</span> 1.19</a></li>
<li><a href="#sec-1-20">1.20. <span class="done DONE">DONE</span> 1.20</a></li>
<li><a href="#sec-1-21">1.21. <span class="todo TODO">TODO</span> 1.21</a></li>
<li><a href="#sec-1-22">1.22. <span class="todo TODO">TODO</span> 1.22</a></li>
<li><a href="#sec-1-23">1.23. <span class="todo TODO">TODO</span> 1.23</a></li>
<li><a href="#sec-1-24">1.24. <span class="todo TODO">TODO</span> 1.24</a></li>
<li><a href="#sec-1-25">1.25. <span class="todo TODO">TODO</span> 1.25</a></li>
<li><a href="#sec-1-26">1.26. <span class="todo TODO">TODO</span> 1.26</a></li>
<li><a href="#sec-1-27">1.27. <span class="todo TODO">TODO</span> 1.27</a></li>
<li><a href="#sec-1-28">1.28. <span class="todo TODO">TODO</span> 1.28</a></li>
<li><a href="#sec-1-29">1.29. <span class="done DONE">DONE</span> 1.29</a></li>
<li><a href="#sec-1-30">1.30. <span class="done DONE">DONE</span> 1.30</a></li>
<li><a href="#sec-1-31">1.31. <span class="done DONE">DONE</span> 1.31</a></li>
<li><a href="#sec-1-32">1.32. <span class="done DONE">DONE</span> 1.32</a></li>
<li><a href="#sec-1-33">1.33. <span class="done DONE">DONE</span> 1.33</a></li>
<li><a href="#sec-1-34">1.34. <span class="done DONE">DONE</span> 1.34</a></li>
<li><a href="#sec-1-35">1.35. <span class="done DONE">DONE</span> 1.35</a></li>
<li><a href="#sec-1-36">1.36. <span class="done DONE">DONE</span> 1.36</a></li>
<li><a href="#sec-1-37">1.37. <span class="done DONE">DONE</span> 1.37</a></li>
<li><a href="#sec-1-38">1.38. <span class="done DONE">DONE</span> 1.38</a></li>
<li><a href="#sec-1-39">1.39. <span class="done DONE">DONE</span> 1.39</a></li>
<li><a href="#sec-1-40">1.40. <span class="done DONE">DONE</span> 1.40</a></li>
<li><a href="#sec-1-41">1.41. <span class="done DONE">DONE</span> 1.41</a></li>
<li><a href="#sec-1-42">1.42. <span class="done DONE">DONE</span> 1.42</a></li>
<li><a href="#sec-1-43">1.43. <span class="done DONE">DONE</span> 1.43</a></li>
<li><a href="#sec-1-44">1.44. <span class="done DONE">DONE</span> 1.44</a></li>
<li><a href="#sec-1-45">1.45. <span class="done DONE">DONE</span> 1.45</a></li>
<li><a href="#sec-1-46">1.46. <span class="done DONE">DONE</span> 1.46</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Chapter 2</a>
<ul>
<li><a href="#sec-2-1">2.1. <span class="done DONE">DONE</span> 2.1</a></li>
<li><a href="#sec-2-2">2.2. <span class="done DONE">DONE</span> 2.2</a></li>
<li><a href="#sec-2-3">2.3. <span class="done DONE">DONE</span> 2.3</a></li>
<li><a href="#sec-2-4">2.4. <span class="done DONE">DONE</span> 2.4</a></li>
<li><a href="#sec-2-5">2.5. <span class="done DONE">DONE</span> 2.5</a></li>
<li><a href="#sec-2-6">2.6. <span class="done DONE">DONE</span> 2.6</a></li>
<li><a href="#sec-2-7">2.7. <span class="done DONE">DONE</span> 2.7</a></li>
<li><a href="#sec-2-8">2.8. <span class="done DONE">DONE</span> 2.8</a></li>
<li><a href="#sec-2-9">2.9. <span class="done DONE">DONE</span> 2.9</a></li>
<li><a href="#sec-2-10">2.10. <span class="done DONE">DONE</span> 2.10</a></li>
<li><a href="#sec-2-11">2.11. <span class="done DONE">DONE</span> 2.11</a></li>
<li><a href="#sec-2-12">2.12. <span class="done DONE">DONE</span> 2.12</a></li>
<li><a href="#sec-2-13">2.13. <span class="done DONE">DONE</span> 2.13</a></li>
<li><a href="#sec-2-14">2.14. <span class="done DONE">DONE</span> 2.14</a></li>
<li><a href="#sec-2-15">2.15. <span class="done DONE">DONE</span> 2.15</a></li>
<li><a href="#sec-2-16">2.16. <span class="done DONE">DONE</span> 2.16</a></li>
<li><a href="#sec-2-17">2.17. <span class="done DONE">DONE</span> 2.17</a></li>
<li><a href="#sec-2-18">2.18. <span class="done DONE">DONE</span> 2.18</a></li>
<li><a href="#sec-2-19">2.19. <span class="done DONE">DONE</span> 2.19</a></li>
<li><a href="#sec-2-20">2.20. <span class="done DONE">DONE</span> 2.20</a></li>
<li><a href="#sec-2-21">2.21. <span class="done DONE">DONE</span> 2.21</a></li>
<li><a href="#sec-2-22">2.22. <span class="done DONE">DONE</span> 2.22</a></li>
<li><a href="#sec-2-23">2.23. <span class="done DONE">DONE</span> 2.23</a></li>
<li><a href="#sec-2-24">2.24. <span class="done DONE">DONE</span> 2.24</a></li>
<li><a href="#sec-2-25">2.25. <span class="done DONE">DONE</span> 2.25</a></li>
<li><a href="#sec-2-26">2.26. <span class="done DONE">DONE</span> 2.26</a></li>
<li><a href="#sec-2-27">2.27. <span class="done DONE">DONE</span> 2.27</a></li>
<li><a href="#sec-2-28">2.28. <span class="done DONE">DONE</span> 2.28</a></li>
<li><a href="#sec-2-29">2.29. <span class="done DONE">DONE</span> 2.29</a></li>
<li><a href="#sec-2-30">2.30. <span class="done DONE">DONE</span> 2.30</a></li>
<li><a href="#sec-2-31">2.31. <span class="done DONE">DONE</span> 2.31</a></li>
<li><a href="#sec-2-32">2.32. <span class="done DONE">DONE</span> 2.32</a></li>
<li><a href="#sec-2-33">2.33. <span class="done DONE">DONE</span> 2.33</a></li>
<li><a href="#sec-2-34">2.34. <span class="done DONE">DONE</span> 2.34</a></li>
<li><a href="#sec-2-35">2.35. <span class="done DONE">DONE</span> 2.35</a></li>
<li><a href="#sec-2-36">2.36. <span class="done DONE">DONE</span> 2.36</a></li>
<li><a href="#sec-2-37">2.37. <span class="done DONE">DONE</span> 2.37</a></li>
<li><a href="#sec-2-38">2.38. <span class="done DONE">DONE</span> 2.38</a></li>
<li><a href="#sec-2-39">2.39. <span class="done DONE">DONE</span> 2.39</a></li>
<li><a href="#sec-2-40">2.40. <span class="done DONE">DONE</span> 2.40</a></li>
<li><a href="#sec-2-41">2.41. <span class="done DONE">DONE</span> 2.41</a></li>
<li><a href="#sec-2-42">2.42. <span class="done DONE">DONE</span> 2.42</a></li>
<li><a href="#sec-2-43">2.43. <span class="done DONE">DONE</span> 2.43</a></li>
<li><a href="#sec-2-44">2.44. <span class="done DONE">DONE</span> 2.44</a></li>
<li><a href="#sec-2-45">2.45. <span class="done DONE">DONE</span> 2.45</a></li>
<li><a href="#sec-2-46">2.46. <span class="done DONE">DONE</span> 2.46</a></li>
<li><a href="#sec-2-47">2.47. <span class="done DONE">DONE</span> 2.47</a></li>
<li><a href="#sec-2-48">2.48. <span class="done DONE">DONE</span> 2.48</a></li>
<li><a href="#sec-2-49">2.49. <span class="done DONE">DONE</span> 2.49</a></li>
<li><a href="#sec-2-50">2.50. <span class="done DONE">DONE</span> 2.50</a></li>
<li><a href="#sec-2-51">2.51. <span class="done DONE">DONE</span> 2.51</a></li>
<li><a href="#sec-2-52">2.52. <span class="done DONE">DONE</span> 2.52</a></li>
<li><a href="#sec-2-53">2.53. <span class="done DONE">DONE</span> 2.53</a></li>
<li><a href="#sec-2-54">2.54. <span class="done DONE">DONE</span> 2.54</a></li>
<li><a href="#sec-2-55">2.55. <span class="done DONE">DONE</span> 2.55</a></li>
<li><a href="#sec-2-56">2.56. <span class="done DONE">DONE</span> 2.56</a></li>
<li><a href="#sec-2-57">2.57. <span class="done DONE">DONE</span> 2.57</a></li>
<li><a href="#sec-2-58">2.58. <span class="done DONE">DONE</span> 2.58</a></li>
<li><a href="#sec-2-59">2.59. <span class="done DONE">DONE</span> 2.59</a></li>
<li><a href="#sec-2-60">2.60. <span class="done DONE">DONE</span> 2.60</a></li>
<li><a href="#sec-2-61">2.61. <span class="done DONE">DONE</span> 2.61</a></li>
<li><a href="#sec-2-62">2.62. <span class="done DONE">DONE</span> 2.62</a></li>
<li><a href="#sec-2-63">2.63. <span class="done DONE">DONE</span> 2.63</a></li>
<li><a href="#sec-2-64">2.64. <span class="done DONE">DONE</span> 2.64</a></li>
<li><a href="#sec-2-65">2.65. <span class="done DONE">DONE</span> 2.65</a></li>
<li><a href="#sec-2-66">2.66. <span class="done DONE">DONE</span> 2.66</a></li>
<li><a href="#sec-2-67">2.67. <span class="done DONE">DONE</span> 2.67</a></li>
<li><a href="#sec-2-68">2.68. <span class="done DONE">DONE</span> 2.68</a></li>
<li><a href="#sec-2-69">2.69. <span class="done DONE">DONE</span> 2.69</a></li>
<li><a href="#sec-2-70">2.70. <span class="done DONE">DONE</span> 2.70</a></li>
<li><a href="#sec-2-71">2.71. <span class="done DONE">DONE</span> 2.71</a></li>
<li><a href="#sec-2-72">2.72. <span class="done DONE">DONE</span> 2.72</a></li>
<li><a href="#sec-2-73">2.73. <span class="done DONE">DONE</span> 2.73</a></li>
<li><a href="#sec-2-74">2.74. <span class="done DONE">DONE</span> 2.74</a></li>
<li><a href="#sec-2-75">2.75. <span class="done DONE">DONE</span> 2.75</a></li>
<li><a href="#sec-2-76">2.76. <span class="done DONE">DONE</span> 2.76</a></li>
<li><a href="#sec-2-77">2.77. <span class="done DONE">DONE</span> 2.77</a></li>
<li><a href="#sec-2-78">2.78. <span class="done DONE">DONE</span> 2.78</a></li>
<li><a href="#sec-2-79">2.79. <span class="done DONE">DONE</span> 2.79</a></li>
<li><a href="#sec-2-80">2.80. <span class="done DONE">DONE</span> 2.80</a></li>
<li><a href="#sec-2-81">2.81. <span class="done DONE">DONE</span> 2.81</a></li>
<li><a href="#sec-2-82">2.82. <span class="done DONE">DONE</span> 2.82</a></li>
<li><a href="#sec-2-83">2.83. <span class="done DONE">DONE</span> 2.83</a></li>
<li><a href="#sec-2-84">2.84. <span class="done DONE">DONE</span> 2.84</a></li>
<li><a href="#sec-2-85">2.85. <span class="done DONE">DONE</span> 2.85</a></li>
<li><a href="#sec-2-86">2.86. <span class="done DONE">DONE</span> 2.86</a></li>
<li><a href="#sec-2-87">2.87. <span class="done DONE">DONE</span> 2.87</a></li>
<li><a href="#sec-2-88">2.88. <span class="done DONE">DONE</span> 2.88</a></li>
<li><a href="#sec-2-89">2.89. <span class="done DONE">DONE</span> 2.89</a></li>
<li><a href="#sec-2-90">2.90. <span class="done DONE">DONE</span> 2.90</a></li>
<li><a href="#sec-2-91">2.91. <span class="done DONE">DONE</span> 2.91</a></li>
<li><a href="#sec-2-92">2.92. <span class="todo TODO">TODO</span> 2.92</a></li>
<li><a href="#sec-2-93">2.93. <span class="done DONE">DONE</span> 2.93</a></li>
<li><a href="#sec-2-94">2.94. <span class="done DONE">DONE</span> 2.94</a></li>
<li><a href="#sec-2-95">2.95. <span class="done DONE">DONE</span> 2.95</a></li>
<li><a href="#sec-2-96">2.96. <span class="done DONE">DONE</span> 2.96</a></li>
<li><a href="#sec-2-97">2.97. <span class="done DONE">DONE</span> 2.97</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Chapter 3</a>
<ul>
<li><a href="#sec-3-1">3.1. <span class="done DONE">DONE</span> 3.1</a></li>
<li><a href="#sec-3-2">3.2. <span class="done DONE">DONE</span> 3.2</a></li>
<li><a href="#sec-3-3">3.3. <span class="done DONE">DONE</span> 3.3</a></li>
<li><a href="#sec-3-4">3.4. <span class="done DONE">DONE</span> 3.4</a></li>
<li><a href="#sec-3-5">3.5. <span class="done DONE">DONE</span> 3.5</a></li>
<li><a href="#sec-3-6">3.6. <span class="done DONE">DONE</span> 3.6</a></li>
<li><a href="#sec-3-7">3.7. <span class="done DONE">DONE</span> 3.7</a></li>
<li><a href="#sec-3-8">3.8. <span class="done DONE">DONE</span> 3.8</a></li>
<li><a href="#sec-3-9">3.9. <span class="done DONE">DONE</span> 3.9</a></li>
<li><a href="#sec-3-10">3.10. <span class="done DONE">DONE</span> 3.10</a></li>
<li><a href="#sec-3-11">3.11. <span class="done DONE">DONE</span> 3.11</a></li>
<li><a href="#sec-3-12">3.12. <span class="done DONE">DONE</span> 3.12</a></li>
<li><a href="#sec-3-13">3.13. <span class="done DONE">DONE</span> 3.13</a></li>
<li><a href="#sec-3-14">3.14. <span class="done DONE">DONE</span> 3.14</a></li>
<li><a href="#sec-3-15">3.15. <span class="done DONE">DONE</span> 3.15</a></li>
<li><a href="#sec-3-16">3.16. <span class="done DONE">DONE</span> 3.16</a></li>
<li><a href="#sec-3-17">3.17. <span class="done DONE">DONE</span> 3.17</a></li>
<li><a href="#sec-3-18">3.18. <span class="done DONE">DONE</span> 3.18</a></li>
<li><a href="#sec-3-19">3.19. <span class="done DONE">DONE</span> 3.19</a></li>
<li><a href="#sec-3-20">3.20. <span class="done DONE">DONE</span> 3.20</a></li>
<li><a href="#sec-3-21">3.21. <span class="done DONE">DONE</span> 3.21</a></li>
<li><a href="#sec-3-22">3.22. <span class="done DONE">DONE</span> 3.22</a></li>
<li><a href="#sec-3-23">3.23. <span class="done DONE">DONE</span> 3.23</a></li>
<li><a href="#sec-3-24">3.24. <span class="done DONE">DONE</span> 3.24</a></li>
<li><a href="#sec-3-25">3.25. <span class="done DONE">DONE</span> 3.25</a></li>
<li><a href="#sec-3-26">3.26. <span class="done DONE">DONE</span> 3.26</a></li>
<li><a href="#sec-3-27">3.27. <span class="done DONE">DONE</span> 3.27</a></li>
<li><a href="#sec-3-28">3.28. <span class="done DONE">DONE</span> 3.28</a></li>
<li><a href="#sec-3-29">3.29. <span class="done DONE">DONE</span> 3.29</a></li>
<li><a href="#sec-3-30">3.30. <span class="done DONE">DONE</span> 3.30</a></li>
<li><a href="#sec-3-31">3.31. <span class="todo TODO">TODO</span> 3.31</a></li>
<li><a href="#sec-3-32">3.32. <span class="todo TODO">TODO</span> 3.32</a></li>
<li><a href="#sec-3-33">3.33. <span class="done DONE">DONE</span> 3.33</a></li>
<li><a href="#sec-3-34">3.34. <span class="done DONE">DONE</span> 3.34</a></li>
<li><a href="#sec-3-35">3.35. <span class="done DONE">DONE</span> 3.35</a></li>
<li><a href="#sec-3-36">3.36. <span class="done DONE">DONE</span> 3.36</a></li>
<li><a href="#sec-3-37">3.37. <span class="done DONE">DONE</span> 3.37</a></li>
<li><a href="#sec-3-38">3.38. <span class="done DONE">DONE</span> 3.38</a></li>
<li><a href="#sec-3-39">3.39. <span class="done DONE">DONE</span> 3.39</a></li>
<li><a href="#sec-3-40">3.40. <span class="done DONE">DONE</span> 3.40</a></li>
<li><a href="#sec-3-41">3.41. <span class="todo TODO">TODO</span> 3.41</a></li>
<li><a href="#sec-3-42">3.42. <span class="done DONE">DONE</span> 3.42</a></li>
<li><a href="#sec-3-43">3.43. <span class="done DONE">DONE</span> 3.43</a></li>
<li><a href="#sec-3-44">3.44. <span class="done DONE">DONE</span> 3.44</a></li>
<li><a href="#sec-3-45">3.45. <span class="done DONE">DONE</span> 3.45</a></li>
<li><a href="#sec-3-46">3.46. <span class="done DONE">DONE</span> 3.46</a></li>
<li><a href="#sec-3-47">3.47. <span class="done DONE">DONE</span> 3.47</a></li>
<li><a href="#sec-3-48">3.48. <span class="done DONE">DONE</span> 3.48</a></li>
<li><a href="#sec-3-49">3.49. <span class="done DONE">DONE</span> 3.49</a></li>
<li><a href="#sec-3-50">3.50. <span class="done DONE">DONE</span> 3.50</a></li>
<li><a href="#sec-3-51">3.51. <span class="done DONE">DONE</span> 3.51</a></li>
<li><a href="#sec-3-52">3.52. <span class="done DONE">DONE</span> 3.52</a></li>
<li><a href="#sec-3-53">3.53. <span class="done DONE">DONE</span> 3.53</a></li>
<li><a href="#sec-3-54">3.54. <span class="done DONE">DONE</span> 3.54</a></li>
<li><a href="#sec-3-55">3.55. <span class="done DONE">DONE</span> 3.55</a></li>
<li><a href="#sec-3-56">3.56. <span class="done DONE">DONE</span> 3.56</a></li>
<li><a href="#sec-3-57">3.57. <span class="done DONE">DONE</span> 3.57</a></li>
<li><a href="#sec-3-58">3.58. <span class="done DONE">DONE</span> 3.58</a></li>
<li><a href="#sec-3-59">3.59. <span class="done DONE">DONE</span> 3.59</a></li>
<li><a href="#sec-3-60">3.60. <span class="done DONE">DONE</span> 3.60</a></li>
<li><a href="#sec-3-61">3.61. <span class="done DONE">DONE</span> 3.61</a></li>
<li><a href="#sec-3-62">3.62. <span class="done DONE">DONE</span> 3.62</a></li>
<li><a href="#sec-3-63">3.63. <span class="done DONE">DONE</span> 3.63</a></li>
<li><a href="#sec-3-64">3.64. <span class="done DONE">DONE</span> 3.64</a></li>
<li><a href="#sec-3-65">3.65. <span class="done DONE">DONE</span> 3.65</a></li>
<li><a href="#sec-3-66">3.66. <span class="todo TODO">TODO</span> 3.66</a></li>
<li><a href="#sec-3-67">3.67. <span class="done DONE">DONE</span> 3.67</a></li>
<li><a href="#sec-3-68">3.68. <span class="done DONE">DONE</span> 3.68</a></li>
<li><a href="#sec-3-69">3.69. <span class="done DONE">DONE</span> 3.69</a></li>
<li><a href="#sec-3-70">3.70. <span class="done DONE">DONE</span> 3.70</a></li>
<li><a href="#sec-3-71">3.71. <span class="done DONE">DONE</span> 3.71</a></li>
<li><a href="#sec-3-72">3.72. <span class="done DONE">DONE</span> 3.72</a></li>
<li><a href="#sec-3-73">3.73. <span class="done DONE">DONE</span> 3.73</a></li>
<li><a href="#sec-3-74">3.74. <span class="done DONE">DONE</span> 3.74</a></li>
<li><a href="#sec-3-75">3.75. <span class="done DONE">DONE</span> 3.75</a></li>
<li><a href="#sec-3-76">3.76. <span class="done DONE">DONE</span> 3.76</a></li>
<li><a href="#sec-3-77">3.77. <span class="done DONE">DONE</span> 3.77</a></li>
<li><a href="#sec-3-78">3.78. <span class="done DONE">DONE</span> 3.78</a></li>
<li><a href="#sec-3-79">3.79. <span class="done DONE">DONE</span> 3.79</a></li>
<li><a href="#sec-3-80">3.80. <span class="done DONE">DONE</span> 3.80</a></li>
<li><a href="#sec-3-81">3.81. <span class="done DONE">DONE</span> 3.81</a></li>
<li><a href="#sec-3-82">3.82. <span class="done DONE">DONE</span> 3.82</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Chapter 4</a>
<ul>
<li><a href="#sec-4-1">4.1. <span class="done DONE">DONE</span> 4.1</a></li>
<li><a href="#sec-4-2">4.2. <span class="done DONE">DONE</span> 4.2</a></li>
<li><a href="#sec-4-3">4.3. <span class="done DONE">DONE</span> 4.3</a></li>
<li><a href="#sec-4-4">4.4. <span class="done DONE">DONE</span> 4.4</a></li>
<li><a href="#sec-4-5">4.5. <span class="done DONE">DONE</span> 4.5</a></li>
<li><a href="#sec-4-6">4.6. <span class="done DONE">DONE</span> 4.6</a></li>
<li><a href="#sec-4-7">4.7. <span class="done DONE">DONE</span> 4.7</a></li>
<li><a href="#sec-4-8">4.8. <span class="done DONE">DONE</span> 4.8</a></li>
<li><a href="#sec-4-9">4.9. <span class="done DONE">DONE</span> 4.9</a></li>
<li><a href="#sec-4-10">4.10. <span class="done DONE">DONE</span> 4.10</a></li>
<li><a href="#sec-4-11">4.11. <span class="done DONE">DONE</span> 4.11</a></li>
<li><a href="#sec-4-12">4.12. <span class="done DONE">DONE</span> 4.12</a></li>
<li><a href="#sec-4-13">4.13. <span class="done DONE">DONE</span> 4.13</a></li>
<li><a href="#sec-4-14">4.14. <span class="done DONE">DONE</span> 4.14</a></li>
<li><a href="#sec-4-15">4.15. <span class="done DONE">DONE</span> 4.15</a></li>
<li><a href="#sec-4-16">4.16. <span class="done DONE">DONE</span> 4.16</a></li>
<li><a href="#sec-4-17">4.17. <span class="done DONE">DONE</span> 4.17</a></li>
<li><a href="#sec-4-18">4.18. <span class="done DONE">DONE</span> 4.18</a></li>
<li><a href="#sec-4-19">4.19. <span class="done DONE">DONE</span> 4.19</a></li>
<li><a href="#sec-4-20">4.20. <span class="done DONE">DONE</span> 4.20</a></li>
<li><a href="#sec-4-21">4.21. <span class="done DONE">DONE</span> 4.21</a></li>
<li><a href="#sec-4-22">4.22. <span class="done DONE">DONE</span> 4.22</a></li>
<li><a href="#sec-4-23">4.23. <span class="done DONE">DONE</span> 4.23</a></li>
<li><a href="#sec-4-24">4.24. <span class="todo TODO">TODO</span> 4.24</a></li>
<li><a href="#sec-4-25">4.25. <span class="done DONE">DONE</span> 4.25</a></li>
<li><a href="#sec-4-26">4.26. <span class="done DONE">DONE</span> 4.26</a></li>
<li><a href="#sec-4-27">4.27. <span class="done DONE">DONE</span> 4.27</a></li>
<li><a href="#sec-4-28">4.28. <span class="done DONE">DONE</span> 4.28</a></li>
<li><a href="#sec-4-29">4.29. <span class="done DONE">DONE</span> 4.29</a></li>
<li><a href="#sec-4-30">4.30. <span class="done DONE">DONE</span> 4.30</a></li>
<li><a href="#sec-4-31">4.31. <span class="todo TODO">TODO</span> 4.31</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Notes</a>
<ul>
<li><a href="#sec-5-1">5.1. 1</a></li>
<li><a href="#sec-5-2">5.2. 2</a></li>
<li><a href="#sec-5-3">5.3. 3</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Chapter 1</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> 1.1</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(test 10 10)
(test 12 (+ 5 3 4))
(test 8 (- 9 1))
(test 3 (/ 6 2))
(test 6 (+ (* 2 4) (- 4 6)))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">a</span> 3)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">b</span> (+ a 1))
(test 19 (+ a b (* a b)))
(test #f (= a b))
(test 4
      (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">and</span> (&gt; b a) (&lt; b (* a b)))
          b
          a))
(test 16
      (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= a 4) 6)
            ((= b 4) (+ 6 7 a))
            (<span style="color: #00ffff; font-weight: bold;">else</span> 25)))
(test 6
      (+ 2 (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; b a) b a)))
(test 16
      (* (<span style="color: #00ffff; font-weight: bold;">cond</span> ((&gt; a b) a)
               ((&lt; a b) b)
               (<span style="color: #00ffff; font-weight: bold;">else</span> -1))
         (+ a 1)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> 1.2</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-scheme">(/ (+ 5 4 (- 2 (- 3 (+ 6 (/ 4 5)))))
   (* 3 (- 5 2) (- 7 2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> <span class="done DONE">DONE</span> 1.3</h3>
<div class="outline-text-3" id="text-1-3">
<p>
This feels a little cheap using sort:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use data-structures test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-of-squares</span> x y)
  (+ (square x x) (square y y)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-of-largest-two-squares</span> a b c)
  (apply sum-of-squares (cdr (sort (list a b c) &lt;))))

(test 13 (sum-of-largest-two-squares 1 2 3))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> <span class="done DONE">DONE</span> 1.4</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<code>(if (&gt; b 0) + -)</code> evaluates to either the procedure <code>+</code> or <code>-</code>,
which is then applied to the operands <code>(a b)</code>.
</p>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> <span class="done DONE">DONE</span> 1.5</h3>
<div class="outline-text-3" id="text-1-5">
<p>
This is how you might emulate normal order evaluation using thunks:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">normal-test</span> x y)
  ((<span style="color: #00ffff; font-weight: bold;">if</span> (= (x) 0)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> () 0)
       y)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p</span>) (p))

(test 0 (normal-test (<span style="color: #00ffff; font-weight: bold;">lambda</span> () 0) p))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> <span class="done DONE">DONE</span> 1.6</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Since <code>new-if</code> is applicative, it evaluates the next <code>sqrt-iter</code>
regardless of whether <code>good-enough?</code> is true; this results in
infinite recursion.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">improve</span> guess x)
  (average guess (/ x guess)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-iter</span> guess x)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (good-enough? (square guess) x)
      guess
      (sqrt-iter (improve guess x) x)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sqrt-newton</span>
  (case-lambda
   ((x) (sqrt-newton sqrt-iter x))
   ((sqrt-iter x) (sqrt-iter 1.0 x))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"sqrt.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">new-if</span> predicate then-clause else-clause)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> (predicate then-clause)
        (<span style="color: #00ffff; font-weight: bold;">else</span> else-clause)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-iter/new-if</span> guess x)
  (new-if (good-enough? (square guess) x)
          guess
          (sqrt-iter/new-if (improve guess x) x)))

(parameterize ((current-test-epsilon 0.0001)
               (epsilon 0.01))
  (test <span style="color: #00ff00;">"Iterative square-root"</span> 3.0 (sqrt-newton 9)))

(test-assert
 <span style="color: #00ff00;">"Iterative square-root with applicative conditional"</span>
 (not (terminates? (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (sqrt-newton sqrt-iter/new-if 9)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> <span class="done DONE">DONE</span> 1.7</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Due to compounded rounding-errors, 0.001 is already off by about
30%:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(load <span style="color: #00ff00;">"sqrt.scm"</span>)

(test
 <span style="color: #00ff00;">"Na&#239;ve Newton-square-root off by 30% for 0.001"</span>
 0.304295
 (/ (abs (- (sqrt-newton 0.001)
            (sqrt 0.001)))
    (sqrt 0.001)))
</pre>
</div>

<p>
Whereas the delta-based square-root is still pretty good, even at
0.00001:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">epsilon</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">good-enough?</span> old-guess guess)
  (&lt; (abs (- old-guess guess)) (epsilon)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">average</span> x y) (/ (+ x y) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">improve</span> guess x)
  (average guess (/ x guess)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-iter</span> old-guess guess x)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (good-enough? old-guess guess)
      guess
      (sqrt-iter guess (improve guess x) x)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-newton-delta</span> x) (sqrt-iter 0.0 1.0 x))

(test <span style="color: #00ff00;">"Square-root with delta-based `good-enough?'"</span>
      3.0
      (sqrt-newton-delta 9))

(test
 <span style="color: #00ff00;">"Square-root-Newton-delta is pretty good."</span>
 (sqrt 0.00001)
 (sqrt-newton-delta 0.00001))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> <span class="done DONE">DONE</span> 1.8</h3>
<div class="outline-text-3" id="text-1-8">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">epsilon</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">good-enough?</span> old-guess guess)
  (&lt; (abs (- old-guess guess)) (epsilon)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">average</span> x y) (/ (+ x y) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">improve-square</span> guess x)
  (average guess (/ x guess)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">improve-cube</span> guess x)
  (/ (+ (/ x (square guess)) (* 2 guess)) 3))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-iter</span> old-guess guess x improve)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (good-enough? old-guess guess)
      guess
      (sqrt-iter guess (improve guess x) x improve)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-newton-delta</span> x) (sqrt-iter 0.0 1.0 x improve-square))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cbrt-newton-delta</span> x) (sqrt-iter 0.0 1.0 x improve-cube))

(test <span style="color: #00ff00;">"Delta-based cube-root"</span>
      3.0
      (cbrt-newton-delta 27))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> <span class="done DONE">DONE</span> 1.9</h3>
<div class="outline-text-3" id="text-1-9">
<p>
This is a recursive process:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(+ 4 5)
(inc (+ 3 5))
(inc (inc (+ 2 5)))
(inc (inc (inc (+ 1 5))))
(inc (inc (inc (inc (+ 0 5)))))
(inc (inc (inc (inc 5))))
(inc (inc (inc 6)))
(inc (inc 7))
(inc 8)
9
</pre>
</div>

<p>
This is an iterative process:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(+ 4 5)
(+ 3 6)
(+ 2 7)
(+ 1 8)
(+ 0 9)
9
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10"><span class="section-number-3">1.10</span> <span class="done DONE">DONE</span> 1.10</h3>
<div class="outline-text-3" id="text-1-10">
<p>
\(f(n) = 2n\); \(g(n) = 2^n\); and \(h(n) = 2 ^ {2 ^ {... ^ {n - 1}}}\).
</p>
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">A</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= y 0) 0)
        ((= x 0) (* 2 y))
        ((= y 1) 2)
        (<span style="color: #00ffff; font-weight: bold;">else</span> (A (- x 1)
                 (A x (- y 1))))))

(test 1024 (A 1 10))
(test 65536 (A 2 4))
(test 65536 (A 3 3))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> n) (A 0 n))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f-prime</span> n) (* 2 n))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">g</span> n) (A 1 n))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">g-prime</span> n)
   (expt 2 n))

 (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">h</span> n) (A 2 n))
 (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">h-prime</span> n)
   (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 1)
       2
       (expt 2 (h-prime (- n 1)))))

 (test <span style="color: #00ff00;">"f(n) = f'(n)"</span> (f 10) (f-prime 10))
 (test <span style="color: #00ff00;">"g(n) = g'(n)"</span> (g 10) (g-prime 10))
 (test <span style="color: #00ff00;">"h(n) = h'(n)"</span> (h 4) (h-prime 4))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11"><span class="section-number-3">1.11</span> <span class="done DONE">DONE</span> 1.11</h3>
<div class="outline-text-3" id="text-1-11">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (&lt; n 3)
      n
      (+ (f (- n 1))
         (* 2 (f (- n 2)))
         (* 3 (f (- n 3))))))

(test <span style="color: #00ff00;">"Recursive f"</span> 796 (f 9))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> n)
  (f-iter 2 1 0 (- n 2)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f-iter</span> a b c n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? n)
      a
      (f-iter (+ a (* 2 b) (* 3 c))
              a
              b
              (- n 1))))

(test <span style="color: #00ff00;">"Iterative f"</span> 796 (f 9))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12"><span class="section-number-3">1.12</span> <span class="done DONE">DONE</span> 1.12</h3>
<div class="outline-text-3" id="text-1-12">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pascal</span> row element)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">or</span> (zero? element)
             (= row element))
         1)
        ((negative? row) 0)
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (+ (pascal (- row 1)
                    (- element 1))
            (pascal (- row 1)
                    element)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pascal-row</span> row)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((element 0)
             (elements '()))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; element row)
        elements
        (iter (+ element 1)
              (cons (pascal row element) elements)))))

(test 2 (pascal 2 1))
(test 3 (pascal 3 1))
(test '(1 3 3 1) (pascal-row 3))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13"><span class="section-number-3">1.13</span> <span class="done DONE">DONE</span> 1.13</h3>
<div class="outline-text-3" id="text-1-13">
<p>
Prove that the base case holds:
</p>

\begin{align}
Fib(0) = (\phi^0 - \psi^0) = 0
\end{align}

<p>
Assume \(Fib(k)\) holds; then show that \(Fib(k + 1)\) holds:
</p>

\begin{align}
Fib(k + 1) = \frac{\phi^{k + 1} - \psi^{k + 1}}{\sqrt{5}}
\end{align}

<p>
And because \(Fib(k + 1) = Fib(k) + Fib(k - 1)\):
</p>

\begin{align}
Fib(k) + Fib(k - 1) &= \frac{\phi^{k + 1} - \psi^{k + 1}}{\sqrt{5}} \\

\frac{\phi^{k} - \psi^{k}}{\sqrt{5}} + \frac{\phi^{k - 1} -
\psi^{k - 1}}{\sqrt{5}} &= \frac{\phi^{k + 1} - \psi^{k + 1}}{\sqrt{5}} \\

\phi^{k} - \psi^{k} + \phi^{k - 1} - \psi^{k - 1} &= \phi^{k + 1} - \psi^{k + 1} \\

\phi^{k} + \phi^{k - 1} - \phi^{k + 1} &= \psi^{k} + \psi^{k - 1} -
\psi^{k + 1} \\

\phi^{k}(1 + \frac{1}{\phi} - \phi) &= \psi^{k}(1 + \frac{1}{\psi} -
\psi)

\end{align}

<p>
Because \(1 + \frac{1}{\phi} = \phi\) and, similarly, \(1 + \frac{1}{\psi} =
  \psi\):
</p>

\begin{align}
\phi^{k}(0) &= \psi^{k}(0) \\

0 &= 0
\end{align}
</div>
</div>
<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14"><span class="section-number-3">1.14</span> <span class="done DONE">DONE</span> 1.14</h3>
<div class="outline-text-3" id="text-1-14">
<p>
Although most of these possibilities are pruned away by the
algorithm, worst case: has to try a complete \(k\)-ary tree (where \(k
  = 5\)) of length \(n\), where \(n\) is the longest change (i.e. \(n\)
pennies); it only has to store \(n\) calls, however, to the depth of
the tree.
</p>


<div class="figure">
<p><img src="1.14.png" alt="1.14.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15"><span class="section-number-3">1.15</span> <span class="done DONE">DONE</span> 1.15</h3>
<div class="outline-text-3" id="text-1-15">
<p>
Number of steps is roughly the cubed-root of \(n\) (\(\sqrt[3]{n}\));
space is the same, too.
</p>

<p>
Some relationship to precision, too:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cube</span> x) (* x x x))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p</span> x) (- (* 3 x) (* 4 (cube x))))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sine</span> angle)
  (count (+ (count) 1))
  (<span style="color: #00ffff; font-weight: bold;">if</span> (not (&gt; (abs angle) 0.1))
      angle
      (p (sine (/ angle 3.0)))))

(parameterize ((count 0))
  (sine 12.15)
  (test 6 (count)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-16" class="outline-3">
<h3 id="sec-1-16"><span class="section-number-3">1.16</span> <span class="done DONE">DONE</span> 1.16</h3>
<div class="outline-text-3" id="text-1-16">
<p>
The process works by taking advantage of squares when it can, and
reduces odds to twos when it must:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> n) (* n n))

<span style="color: #ffff00;">;; </span><span style="color: #ff0000; font-weight: bold;">TODO</span><span style="color: #ffff00;">: I'm uncomfortable with these special cases here; a better</span>
<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">way?</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-expt</span> b n)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((zero? n) 1)
        ((= n 1) b)
        (<span style="color: #00ffff; font-weight: bold;">else</span> (fast-expt-iter b n 1))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-expt-iter</span> b n a)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= n 1) a)
        ((even? n)
         (fast-expt-iter b (/ n 2) (* (square b) a)))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (fast-expt-iter b (- n 1) (* b a)))))

(test 1 (fast-expt 2 0))
(test 2 (fast-expt 2 1))
(test 4 (fast-expt 2 2))
(test 8 (fast-expt 2 3))
(test 16 (fast-expt 2 4))
(test 32 (fast-expt 2 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-17" class="outline-3">
<h3 id="sec-1-17"><span class="section-number-3">1.17</span> <span class="done DONE">DONE</span> 1.17</h3>
<div class="outline-text-3" id="text-1-17">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">double</span> n) (* n 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">halve</span> n) (/ n 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-*</span> a b)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((zero? b) 0)
        ((even? b) (double (fast-* a (halve b))))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (+ a (fast-* a (- b 1))))))

(test 20 (fast-* 4 5))
(test 56 (fast-* 8 7))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-18" class="outline-3">
<h3 id="sec-1-18"><span class="section-number-3">1.18</span> <span class="done DONE">DONE</span> 1.18</h3>
<div class="outline-text-3" id="text-1-18">
<p>
The invariant is \(c + ab\); the trick, however, is that doubling \(a\)
and halving \(b\) is a noöp with respect to \(c\):
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">double</span> n) (* n 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">halve</span> n) (/ n 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-*</span> a b)
  (fast-*-iter a b 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-*-iter</span> a b c)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= b 0) c)
        ((even? b) (fast-*-iter (double a) (halve b) c))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (fast-*-iter a (- b 1) (+ c a)))))

(test 20 (fast-* 4 5))
(test 56 (fast-* 7 8))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-19" class="outline-3">
<h3 id="sec-1-19"><span class="section-number-3">1.19</span> <span class="done DONE">DONE</span> 1.19</h3>
<div class="outline-text-3" id="text-1-19">
<p>
See <a href="http://ldc.usb.ve/~mosquera/Algoritmos/AlgoritmosI/Teoria/ene-mar-2008/Kaldewaij%2520-%2520Prentice%2520Hall%2520-%2520Programming.%2520The%2520Derivation%2520of%2520Algorithms.pdf">Kaldewaij, 1990</a> [<a href="papers/kaldewaij-programming.pdf">local</a>], page 88; where \(p^\prime = p^2 + q^2\)
and \(q^\prime = pq + qp + q^2\):
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> n) (* n n))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fib</span> n)
  (fib-iter 1 0 0 1 n))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fib-iter</span> a b p q count)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= count 0) b)
        ((even? count)
         (fib-iter a
                   b
                   (+ (square p) (square q))
                   (+ (* 2 (* p q))
                      (square q))
                   (/ count 2)))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (fib-iter (+ (* b q) (* a q) (* a p))
                        (+ (* b p) (* a q))
                        p
                        q
                        (- count 1)))))

(test 55 (fib 10))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-20" class="outline-3">
<h3 id="sec-1-20"><span class="section-number-3">1.20</span> <span class="done DONE">DONE</span> 1.20</h3>
<div class="outline-text-3" id="text-1-20">
<p>
<code>remainder</code> is called 4 times:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(gcd 206 40)
(gcd 40 (remainder 206 40))
(gcd 40 6)
(gcd 6 (remainder 40 6))
(gcd 6 4)
(gcd 4 (remainder 6 4))
(gcd 2 2)
(gcd 2 (remainder 2 2))
(gcd 2 0)
(display <span style="color: #00ff00;">"hello, org"</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remainder-count</span> a b)
  (count (+ (count) 1))
  (remainder a b))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd</span> a b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
      a
      (gcd b (remainder-count a b))))

(parameterize ((count 0))
  (gcd 206 40)
  (test 4 (count)))
</pre>
</div>

<p>
Using applicative, it’s called also called 4 times before
divide-by-zero on the fifth call:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remainder-count</span> a b)
  (count (+ (count) 1))
  (remainder a b))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">new-if</span> predicate then-clause else-clause)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> (predicate then-clause)
        (<span style="color: #00ffff; font-weight: bold;">else</span> else-clause)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd</span> a b)
  (new-if (= b 0)
      a
      (gcd b (remainder-count a b))))

(trace remainder-count)

(parameterize ((count 0))
  (gcd 206 40)
  (test 4 (count)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-21" class="outline-3">
<h3 id="sec-1-21"><span class="section-number-3">1.21</span> <span class="todo TODO">TODO</span> 1.21</h3>
</div>
<div id="outline-container-sec-1-22" class="outline-3">
<h3 id="sec-1-22"><span class="section-number-3">1.22</span> <span class="todo TODO">TODO</span> 1.22</h3>
</div>
<div id="outline-container-sec-1-23" class="outline-3">
<h3 id="sec-1-23"><span class="section-number-3">1.23</span> <span class="todo TODO">TODO</span> 1.23</h3>
</div>
<div id="outline-container-sec-1-24" class="outline-3">
<h3 id="sec-1-24"><span class="section-number-3">1.24</span> <span class="todo TODO">TODO</span> 1.24</h3>
</div>
<div id="outline-container-sec-1-25" class="outline-3">
<h3 id="sec-1-25"><span class="section-number-3">1.25</span> <span class="todo TODO">TODO</span> 1.25</h3>
</div>
<div id="outline-container-sec-1-26" class="outline-3">
<h3 id="sec-1-26"><span class="section-number-3">1.26</span> <span class="todo TODO">TODO</span> 1.26</h3>
</div>
<div id="outline-container-sec-1-27" class="outline-3">
<h3 id="sec-1-27"><span class="section-number-3">1.27</span> <span class="todo TODO">TODO</span> 1.27</h3>
</div>
<div id="outline-container-sec-1-28" class="outline-3">
<h3 id="sec-1-28"><span class="section-number-3">1.28</span> <span class="todo TODO">TODO</span> 1.28</h3>
</div>
<div id="outline-container-sec-1-29" class="outline-3">
<h3 id="sec-1-29"><span class="section-number-3">1.29</span> <span class="done DONE">DONE</span> 1.29</h3>
<div class="outline-text-3" id="text-1-29">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cube</span> x) (* x x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum</span> term a next b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
      0
      (+ (term a)
         (sum term (next a) next b))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integral</span> f a b dx)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-dx</span> x) (+ x dx))
  (* (sum f (+ a (/ dx 2.0)) add-dx b) dx))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">simpsons-rule</span> f a b n)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((h (/ (- b a) n)))
    (* (/ h 3)
       (sum (<span style="color: #00ffff; font-weight: bold;">lambda</span> (k)
              (<span style="color: #00ffff; font-weight: bold;">let</span> ((coefficient
                     (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">or</span> (zero? k) (= k n)) 1)
                           ((odd? k ) 4)
                           (<span style="color: #00ffff; font-weight: bold;">else</span> 2))))
                (* coefficient (f (+ a (* k h))))))
            0
            inc
            n))))

(test
 <span style="color: #00ff00;">"Simpson's rule is correct for cube, 0, 1; even at n = 100."</span>
 0.25
 (simpsons-rule cube 0 1 100))

(test
 <span style="color: #00ff00;">"Simpson's rule differs from the na&#239;ve integral a little."</span>
 0.000000124999999268072
 (abs
  (- (simpsons-rule cube 0 1 1000)
     (integral cube 0 1 0.001))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-30" class="outline-3">
<h3 id="sec-1-30"><span class="section-number-3">1.30</span> <span class="done DONE">DONE</span> 1.30</h3>
<div class="outline-text-3" id="text-1-30">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cube</span> x) (* x x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-cubes</span> a b)
  (sum cube a inc b))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum</span> term a next b)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((a a)
             (result 0))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
        result
        (iter (next a) (+ result (term a))))))

(test <span style="color: #00ff00;">"Iterative sum"</span>
      3025
      (sum-cubes 1 10))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-31" class="outline-3">
<h3 id="sec-1-31"><span class="section-number-3">1.31</span> <span class="done DONE">DONE</span> 1.31</h3>
<div class="outline-text-3" id="text-1-31">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product</span> term a next b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
      1
      (* (term a) (product term (next a) next b))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">factorial</span> n)
  (product identity 1 inc n))

(test 120 (factorial 5))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pi</span> n)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">numerator-term</span> i)
    (* (ceiling (/ (+ i 2) 2)) 2))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">denominator-term</span> i)
    (+ 1 (* (floor (/ (+ i 2) 2)) 2)))
  (* 4 (/ (product numerator-term 0 inc n)
          (product denominator-term  0 inc n))))

(parameterize ((current-test-epsilon 0.1))
  (test 3.1 (pi 100)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product</span> term a next b)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((a a)
             (result 1))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
        result
        (iter (next a) (* result (term a))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">factorial</span> n)
  (product identity 1 inc n))

(test 120 (factorial 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-32" class="outline-3">
<h3 id="sec-1-32"><span class="section-number-3">1.32</span> <span class="done DONE">DONE</span> 1.32</h3>
<div class="outline-text-3" id="text-1-32">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">accumulate</span> combiner null-value term a next b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
      null-value
      (combiner (term a)
                (accumulate combiner
                            null-value
                            term
                            (next a)
                            next
                            b))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum</span> term a next b)
  (accumulate + 0 term a next b))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product</span> term a next b)
  (accumulate * 1 term a next b))

(test 15 (sum identity 0 inc 5))
(test 120 (product identity 1 inc 5))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">accumulate</span> combiner null-value term a next b)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((a a)
             (result null-value))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
        result
        (iter (next a)
              (combiner result (term a))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum</span> term a next b)
  (accumulate + 0 term a next b))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product</span> term a next b)
  (accumulate * 1 term a next b))

(test 15 (sum identity 0 inc 5))
(test 120 (product identity 1 inc 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-33" class="outline-3">
<h3 id="sec-1-33"><span class="section-number-3">1.33</span> <span class="done DONE">DONE</span> 1.33</h3>
<div class="outline-text-3" id="text-1-33">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">filtered-accumulate</span> predicate?
                             combiner
                             null-value
                             term
                             a
                             next
                             b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; a b)
      null-value
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((term-a (term a)))
        (<span style="color: #00ffff; font-weight: bold;">if</span> (predicate? term-a)
            (combiner term-a
                      (filtered-accumulate predicate?
                                           combiner
                                           null-value
                                           term
                                           (next a)
                                           next
                                           b))
            (filtered-accumulate predicate?
                                 combiner
                                 null-value
                                 term
                                 (next a)
                                 next
                                 b)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"filtered-accumulate.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">expmod</span> base exp m)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= exp 0) 1)
        ((even? exp)
         (remainder
          (square (expmod base (/ exp 2) m))
          m))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (remainder
          (* base (expmod base (- exp 1) m))
          m))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fermat-test</span> n)
     (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">try-it</span> a)
       (= (expmod a n n) a))
     (try-it (+ 1 (random (- n 1)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fast-prime?</span> n times)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= times 0) #t)
        ((fermat-test n) (fast-prime? n (- times 1)))
        (<span style="color: #00ffff; font-weight: bold;">else</span> #f)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-primes</span> a b)
  (filtered-accumulate (cute fast-prime? &lt;&gt; 100)
                       +
                       0
                       identity
                       a
                       add1
                       b))

(test 17 (sum-primes 2 10))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd</span> a b)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
      a
      (gcd b (remainder a b))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-coprimes</span> n)
  (filtered-accumulate (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (= (gcd i n) 1))
                       +
                       0
                       identity
                       0
                       add1
                       (- n 1)))

(test 20 (sum-coprimes 10))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-34" class="outline-3">
<h3 id="sec-1-34"><span class="section-number-3">1.34</span> <span class="done DONE">DONE</span> 1.34</h3>
<div class="outline-text-3" id="text-1-34">
<p>
<code>(f f)</code> reduces to <code>(f 2)</code> which in turn reduces to <code>(2 2)</code>: it
tries to apply 2 as a procedure and fails.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> g) (g 2))

(test-error (f f))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-35" class="outline-3">
<h3 id="sec-1-35"><span class="section-number-3">1.35</span> <span class="done DONE">DONE</span> 1.35</h3>
<div class="outline-text-3" id="text-1-35">
<p>
Since \(\phi = 1 + \frac{1}{\phi}\), we are looking for the fixed
point of the function \(x \mapsto 1 + \frac{1}{x}\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tolerance</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point f first-guess)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">close-enough?</span> v1 v2)
    (&lt; (abs (- v1 v2))
       (tolerance)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">try</span> guess)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((next (f guess)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (close-enough? guess next)
          next
          (try next))))
  (try first-guess))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"</span><span style="color: #ff0000; font-weight: bold;">fix</span><span style="color: #00ff00;">ed-point.scm"</span>)

(test 1.61803 (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (+ 1 (/ 1 x))) 1.6))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-36" class="outline-3">
<h3 id="sec-1-36"><span class="section-number-3">1.36</span> <span class="done DONE">DONE</span> 1.36</h3>
<div class="outline-text-3" id="text-1-36">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tolerance</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point f first-guess)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">close-enough?</span> v1 v2)
    (&lt; (abs (- v1 v2))
       (tolerance)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">try</span> guess)
    (count (+ (count) 1))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((next (f guess)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (close-enough? guess next)
          next
          (try next))))
  (try first-guess))

(parameterize ((count 0))
  (test 4.5555 (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (/ (log 1000) (log x))) 4))
  (test 29 (count)))

(parameterize ((count 0))
  (test 4.5555 (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (/ (+ x (/ (log 1000) (log x))) 2)) 4))
  (test 7 (count)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-37" class="outline-3">
<h3 id="sec-1-37"><span class="section-number-3">1.37</span> <span class="done DONE">DONE</span> 1.37</h3>
<div class="outline-text-3" id="text-1-37">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Off by one?</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cont-frac</span> n d k)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">i is necessary to evaluate the terms in order.</span>
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((i 0))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= i k)
        (/ (n i) (d i))
        (/ (n i) (+ (d i) (iter (+ i 1)))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"cont-frac.scm"</span>)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">The phi conjugate</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">phi</span> 0.618033989)

(test
 <span style="color: #00ff00;">"k must be 11 to converge on Phi to within 0.00001."</span>
 11
 (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((k 0))
   (<span style="color: #00ffff; font-weight: bold;">let</span> ((cont-frac-phi (cont-frac (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) 1.0) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) 1.0) k)))
     (<span style="color: #00ffff; font-weight: bold;">if</span> (&lt; (abs (- phi cont-frac-phi)) 0.00001)
         k
         (iter (+ k 1))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cont-frac</span> n d k)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((result (/ (n 0) (d 0)))
             (i k))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? i)
        result
        (iter (/ (n i) (+ (d i) result))
              (- i 1)))))

(test 0.61803 (cont-frac (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) 1.0) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) 1.0) 13))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-38" class="outline-3">
<h3 id="sec-1-38"><span class="section-number-3">1.38</span> <span class="done DONE">DONE</span> 1.38</h3>
<div class="outline-text-3" id="text-1-38">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"cont-frac.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">e</span> 2.71828182846)

(test (- e 2)
      (cont-frac (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) 1.0)
                 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? (modulo (+ i 2) 3))
                            (+ 2 (floor (* 2 (/ i 3))))
                            1.0))
                 7))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-39" class="outline-3">
<h3 id="sec-1-39"><span class="section-number-3">1.39</span> <span class="done DONE">DONE</span> 1.39</h3>
<div class="outline-text-3" id="text-1-39">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"cont-frac.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">pi</span> 3.14159265359)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tan-cf</span> x)
  (cont-frac (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? i) x (- (square x))))
             (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (- (* 2 (+ i 1)) 1))
             3))

(test (tan (/ pi 4)) (tan-cf (/ pi 4)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-40" class="outline-3">
<h3 id="sec-1-40"><span class="section-number-3">1.40</span> <span class="done DONE">DONE</span> 1.40</h3>
<div class="outline-text-3" id="text-1-40">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"</span><span style="color: #ff0000; font-weight: bold;">fix</span><span style="color: #00ff00;">ed-point.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dx</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv</span> g)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (/ (- (g (+ x (dx))) (g x)) (dx))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">newton-transform</span> g)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (- x (/ (g x) ((deriv g) x)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">newtons-method</span> g guess)
  (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point (newton-transform g) guess))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cube</span> x) (* x x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cubic</span> a b c)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (+ (cube x)
            (* a (square x))
            (* b x)
            c)))

(test 2.0 (newtons-method (cubic 3 -6 -8) 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-41" class="outline-3">
<h3 id="sec-1-41"><span class="section-number-3">1.41</span> <span class="done DONE">DONE</span> 1.41</h3>
<div class="outline-text-3" id="text-1-41">
<p>
The \(2^4\) (as opposed to \(2^3\)) occurs because you get something
like \(double^2(double^2(x))\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">inc</span> n) (+ n 1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">double</span> g) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (g (g x))))

(test 21 (((double (double double)) inc) 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-42" class="outline-3">
<h3 id="sec-1-42"><span class="section-number-3">1.42</span> <span class="done DONE">DONE</span> 1.42</h3>
<div class="outline-text-3" id="text-1-42">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">compose</span> f g) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (f (g x))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"compose.scm"</span>)

(test 49 ((compose square inc) 6))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-43" class="outline-3">
<h3 id="sec-1-43"><span class="section-number-3">1.43</span> <span class="done DONE">DONE</span> 1.43</h3>
<div class="outline-text-3" id="text-1-43">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"compose.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">repeated</span> f n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? n)
      identity
      (compose f (repeated f (- n 1)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"repeated.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(test 625 ((repeated square 2) 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-44" class="outline-3">
<h3 id="sec-1-44"><span class="section-number-3">1.44</span> <span class="done DONE">DONE</span> 1.44</h3>
<div class="outline-text-3" id="text-1-44">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"repeated.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dx</span> (make-parameter 0.1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">smooth</span> f)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
    (/ (+ (f (- x (dx)))
          (f x)
          (f (+ x (dx))))
       3)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">n-fold-smooth</span> f n)
  (repeated (smooth f) n))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">pi/2</span> (/ 3.14159265359 2))

(test 0.99667 ((smooth sin) pi/2))
(test 0.83687 ((n-fold-smooth sin 2) pi/2))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-45" class="outline-3">
<h3 id="sec-1-45"><span class="section-number-3">1.45</span> <span class="done DONE">DONE</span> 1.45</h3>
<div class="outline-text-3" id="text-1-45">
<p>
It appears as though you have to average-dampen \(\lfloor \log_2 n
  \rfloor\) times for the \(n^{th}\) root. Why?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"</span><span style="color: #ff0000; font-weight: bold;">fix</span><span style="color: #00ff00;">ed-point.scm"</span>)
(include <span style="color: #00ff00;">"repeated.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">average</span> x y) (/ (+ x y) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">average-damp</span> f)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (average x (f x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point-of-transform g transform guess)
  (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point (transform g) guess))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt</span> x)
  (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point-of-transform
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (y) (/ x y))
   average-damp
   1.0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">nth-root</span> x n)
  (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point-of-transform
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (y) (/ x (expt y (- n 1))))
   (repeated average-damp (floor (/ (log n) (log 2))))
   1.0))

(test 2.0 (nth-root 16 4))
(test 2.0 (nth-root 32 5))
(test 2.0 (nth-root 64 6))
(test 2.0 (nth-root 128 7))
(test 2.0 (nth-root 256 8))
(test 2.0 (nth-root 65536 16))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-46" class="outline-3">
<h3 id="sec-1-46"><span class="section-number-3">1.46</span> <span class="done DONE">DONE</span> 1.46</h3>
<div class="outline-text-3" id="text-1-46">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">iterative-improve</span> good-enough? improve)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (guess)
    (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((guess guess))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (good-enough? guess)
          guess
          (iter (improve guess))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">epsilon</span> (make-parameter 0.00001))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">average</span> x y) (/ (+ x y) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-iter</span> guess x)
  ((iterative-improve
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (guess)
      (&lt; (abs (- (square guess) x)) (epsilon)))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (guess)
      (average guess (/ x guess))))
   guess))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt</span> x) (sqrt-iter 1.0 x))

(test 2.0 (sqrt 4))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point f guess)
  ((iterative-improve
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (guess)
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This results in the application of f twice, unfortunately.</span>
      (&lt; (abs (- guess (f guess))) (epsilon)))
    f)
   guess))

(test 0.73909 (<span style="color: #ff0000; font-weight: bold;">fix</span>ed-point cos 1.0))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Chapter 2</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> <span class="done DONE">DONE</span> 2.1</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-scheme">(use (only sicp xor) test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-rat</span> n d)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((g (gcd n d)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((n (/ n g))
          (d (/ d g)))
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((n (<span style="color: #00ffff; font-weight: bold;">if</span> (xor (negative? n)
                        (negative? d))
                   (- (abs n))
                   (abs n)))
            (d (abs d)))
        (cons n d)))))

(test '(2 . 1) (make-rat 8 4))
(test '(2 . 1) (make-rat -8 -4))
(test '(-2 . 1) (make-rat 8 -4))
(test '(-2 . 1) (make-rat -8 4))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> <span class="done DONE">DONE</span> 2.2</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-segment</span> cons)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">start-segment</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">end-segment</span> cdr)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-point</span> cons)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x-point</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y-point</span> cdr)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"segment.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">midpoint-segment</span> segment)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((start (start-segment segment))
        (end (end-segment segment)))
    (make-point (average (x-point start)
                         (x-point end))
                (average (y-point start)
                         (y-point end)))))

(test
 (make-point 1 1)
 (midpoint-segment (make-segment (make-point 0 0)
                                 (make-point 2 2))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> <span class="done DONE">DONE</span> 2.3</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"segment.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">length</span> p1 p2)
  (sqrt (+ (square (- (x-point p2)
                      (x-point p1)))
           (square (- (y-point p2)
                      (y-point p1))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-segment-rect</span> s1 s2)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
    (<span style="color: #00ffff; font-weight: bold;">case</span> message
      ((length)
       (length (start-segment s1)
               (end-segment s1)))
      ((width)
       (length (start-segment s2)
               (end-segment s2))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-point-rect</span> p1 p2 p3)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
    (<span style="color: #00ffff; font-weight: bold;">case</span> message
      ((length) (length p1 p2))
      ((width) (length p2 p3)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">perimeter</span> rect)
  (* 2 (+ (rect 'length)
          (rect 'width))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">area</span> rect)
  (* (rect 'length) (rect 'width)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((r1 (make-segment-rect (make-segment (make-point 0 0)
                                           (make-point 2 0))
                             (make-segment (make-point 0 0)
                                           (make-point 0 3))))
      (r2 (make-point-rect (make-point 2 0)
                           (make-point 0 0)
                           (make-point 0 3))))
  (test 10.0 (perimeter r1))
  (test (perimeter r1) (perimeter r2))
  (test 6.0 (area r1))
  (test (area r1) (area r2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> <span class="done DONE">DONE</span> 2.4</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cons</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (m) (m x y)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">car</span> z)
  (z (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p q) p)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cdr</span> z)
  (z (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p q) q)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((pair (cons 1 2)))
  (test 1 (car pair))
  (test 2 (cdr pair)))
</pre>
</div>

<p>
Via the substitution model:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(cdr pair)
(cdr (cons 1 2))
(cdr (<span style="color: #00ffff; font-weight: bold;">lambda</span> (m) (m 1 2)))
((<span style="color: #00ffff; font-weight: bold;">lambda</span> (m) (m 1 2))
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p q) q))
((<span style="color: #00ffff; font-weight: bold;">lambda</span> (p q) q) 1 2)
2
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> <span class="done DONE">DONE</span> 2.5</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Is there a cleverer way to do this that’s not \(O(n)\) for accessing
<code>car</code> and <code>cdr</code>?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">divides?</span> n d) (zero? (modulo n d)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">multiplicity</span> n d)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((n n)
             (m 0))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (divides? n d)
        (iter (/ n d) (+ m 1))
        m)))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Strange things happen if we don't prefix these.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">n-cons</span> a b)
  (* (expt 2 a) (expt 3 b)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">n-car</span> n)
  (multiplicity n 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">n-cdr</span> n)
  (multiplicity n 3))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((pair (n-cons 3 4)))
  (test 3 (n-car pair))
  (test 4 (n-cdr pair)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> <span class="done DONE">DONE</span> 2.6</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Addition relies on the property that \(f^{m + n}(x) = f^m(f^n(x))\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">zero</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (f) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) x)))

((zero identity) 0)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-1</span> n)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (f) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (f ((n f) x)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">one</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (f) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (f x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">two</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (f) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (f (f x)))))

(test
 ((one inc) 0)
 (((add-1 zero) inc) 0))

(test
 ((two inc) 0)
 (((add-1 (add-1 zero)) inc) 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add</span> m n)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (f) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (f ((m (n f)) x)))))

(test 3 (((add one two) inc) 0))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><span class="section-number-3">2.7</span> <span class="done DONE">DONE</span> 2.7</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-interval</span> x y)
  (make-interval (+ (lower-bound x) (lower-bound y))
                 (+ (upper-bound x) (upper-bound y))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-interval</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (* (lower-bound x) (lower-bound y)))
        (p2 (* (lower-bound x) (upper-bound y)))
        (p3 (* (upper-bound x) (lower-bound y)))
        (p4 (* (upper-bound x) (upper-bound y))))
    (make-interval (min p1 p2 p3 p4)
                   (max p1 p2 p3 p4))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-interval</span> x y)
  (mul-interval
   x
   (make-interval (/ 1.0 (upper-bound y))
                  (/ 1.0 (lower-bound y)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-interval</span> cons)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">lower-bound</span> car)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">upper-bound</span> cdr)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval.scm"</span>)

(test '(3 . 3)
      (add-interval (make-interval 1 1)
                    (make-interval 2 2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8"><span class="section-number-3">2.8</span> <span class="done DONE">DONE</span> 2.8</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-interval</span> x y)
  (make-interval (- (lower-bound x) (lower-bound y))
                 (- (upper-bound x) (upper-bound y))))

(test '(1 . 1)
      (sub-interval (make-interval 2 2)
                    (make-interval 1 1)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9"><span class="section-number-3">2.9</span> <span class="done DONE">DONE</span> 2.9</h3>
<div class="outline-text-3" id="text-2-9">
<p>
With respect to addition:
</p>

\begin{align}
w(n_1) + w(n_2) &= w(n_1 + n_2) \\
\frac{u_1 - l_1}{2} + \frac{u_2 - l_2}{2} &= \frac{(u_1 + u_2) - (l_1 + l_2)}{2}
\end{align}

<p>
but, in general, with respect to multiplication:
</p>

\begin{align}
w(n_1)w(n_2) &\neq w(n_1n_2) \\
\frac{u_1 - l_1}{2}\cdot\frac{u_2 - l_2}{2} &\neq
\frac{\max_{u_1l_1, u_1l_2, u_2l_1, u_2l_2} - \min_{u_1l_1, u_1l_2, u_2l_1, u_2l_2}}{2}
\end{align}

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">width</span> n)
  (/ (- (upper-bound n) (lower-bound n))
     2))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((n0 (make-interval 0 1))
      (n1 (make-interval 1 0)))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((w0 (* (width n0)
               (width n1)))
        (w1 (width (mul-interval n0 n1))))
    (test-assert (not (= w0 w1)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-10" class="outline-3">
<h3 id="sec-2-10"><span class="section-number-3">2.10</span> <span class="done DONE">DONE</span> 2.10</h3>
<div class="outline-text-3" id="text-2-10">
<p>
This doesn’t check the endpoints for division by zero but merely
checks the span.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-interval</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (xor (positive? (upper-bound y))
           (positive? (lower-bound y)))
      (error <span style="color: #00ff00;">"It's not clear what it means to divide by an interval that spans zero."</span>)
      (mul-interval
       x
       (make-interval (/ 1.0 (upper-bound y))
                      (/ 1.0 (lower-bound y))))))

(test '(0.0 . 0.0)
      (div-interval (make-interval 0 0) (make-interval 1 1)))

(test-error (div-interval (make-interval 0 0)
                          (make-interval -1 1)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-11" class="outline-3">
<h3 id="sec-2-11"><span class="section-number-3">2.11</span> <span class="done DONE">DONE</span> 2.11</h3>
<div class="outline-text-3" id="text-2-11">
<p>
Let’s break it into nine cases according to which each interval is
either positive, negative or threshold-crossing.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">positive-interval?</span> x)
  (<span style="color: #00ffff; font-weight: bold;">and</span> (positive? (lower-bound x))
       (positive? (upper-bound x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">negative-interval?</span> x)
  (<span style="color: #00ffff; font-weight: bold;">and</span> (negative? (lower-bound x))
       (negative? (upper-bound x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mixed-interval?</span> x)
  (xor (positive? (lower-bound x))
       (positive? (upper-bound x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-interval-cases</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((x-negative? (negative-interval? x))
        (y-negative? (negative-interval? y))
        (x-positive? (positive-interval? x))
        (y-positive? (positive-interval? y))
        (x-mixed? (mixed-interval? x))
        (y-mixed? (mixed-interval? y))
        (x-lower (lower-bound x))
        (x-upper (upper-bound x))
        (y-lower (lower-bound y))
        (y-upper (upper-bound y)))
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">and</span> x-negative? y-negative?)
           (make-interval (* x-upper y-upper)
                          (* x-lower y-lower)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-negative? y-positive?)
           (make-interval (* x-lower y-upper)
                          (* x-upper y-lower)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-negative? y-mixed?)
           (make-interval (* x-lower y-upper)
                          (* x-lower y-lower)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-positive? y-negative?)
           (make-interval (* x-upper y-lower)
                          (* x-lower y-upper)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-positive? y-positive?)
           (make-interval (* x-lower y-lower)
                          (* x-upper y-upper)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-positive? y-mixed?)
           (make-interval (* x-upper y-lower)
                          (* x-upper y-upper)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-mixed? y-negative?)
           (make-interval (* x-upper y-lower)
                          (* x-lower y-lower)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-mixed? y-positive?)
           (make-interval (* x-lower y-upper)
                          (* x-upper y-upper)))
          ((<span style="color: #00ffff; font-weight: bold;">and</span> x-mixed? y-mixed?)
           (make-interval (min (* x-lower y-upper)
                               (* x-upper y-lower))
                          (max (* x-upper y-upper)
                               (* x-lower y-lower)))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((negative (make-interval -5 -3))
      (mixed (make-interval -1 7))
      (positive (make-interval 11 13)))
  (test (mul-interval negative negative)
        (mul-interval-cases negative negative))
  (test (mul-interval negative positive)
        (mul-interval-cases negative positive))
  (test (mul-interval negative mixed)
        (mul-interval-cases negative mixed))
  (test (mul-interval positive negative)
        (mul-interval-cases positive negative))
  (test (mul-interval positive positive)
        (mul-interval-cases positive positive))
  (test (mul-interval positive mixed)
        (mul-interval-cases positive mixed))
  (test (mul-interval negative negative)
        (mul-interval-cases negative negative))
  (test (mul-interval mixed positive)
        (mul-interval-cases mixed positive))
  (test (mul-interval mixed mixed)
        (mul-interval-cases mixed mixed)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-12" class="outline-3">
<h3 id="sec-2-12"><span class="section-number-3">2.12</span> <span class="done DONE">DONE</span> 2.12</h3>
<div class="outline-text-3" id="text-2-12">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"interval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-center-width</span> c w)
  (make-interval (- c w) (+ c w)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">center</span> i)
  (/ (+ (lower-bound i) (upper-bound i)) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">width</span> i)
  (/ (- (upper-bound i) (lower-bound i)) 2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-center-percent</span> c p)
  (make-center-width c (* p c)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">percent</span> i)
  (/ (width i) (center i)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval-percent.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((i (make-center-percent 6.8 0.1)))
  (test 6.8 (center i))
  (test 0.68 (width i))
  (test 6.12 (lower-bound i))
  (test 7.48 (upper-bound i))
  (test 0.1 (percent i)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-13" class="outline-3">
<h3 id="sec-2-13"><span class="section-number-3">2.13</span> <span class="done DONE">DONE</span> 2.13</h3>
<div class="outline-text-3" id="text-2-13">
<p>
It’s possible to add the percentage tolerance to get an approximate
product-tolerance. Given that (where \(p\) is the percent; \(w\),
width; \(c\), center; \(u\), upper-bound; and \(l\), lower-bound):
</p>

\begin{align}
p(x) &= \frac{w(x)}{c(x)} \\
&= \frac{u - l}{u + l}
\end{align}

<p>
and that \(x_1x_2 = [l_1l_2, u_1u_2]\) for positive intervals, we
assert:
</p>

\begin{align}
p(x_1) + p(x_2) &\approx p(x_1x_2) \\
\frac{u_1 - l_1}{u_1 + l_1} + \frac{u_2 - l_2}{u_2 + l_2} &\approx
\frac{u_1u_2 - l_1l_2}{u_1u_2 + l_1l_2}
\end{align}

<p>
and for small percentage tolerances (i.e. where \(u_1\) is
sufficiently close to \(l_1\) and \(u_2\) is sufficiently close to
\(l_2\)):
</p>

\begin{align}
\frac{u - u}{u} &\approx \frac{u^2 - u^2}{2u^2} \\
0 &\approx 0
\end{align}

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval-percent.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((p 0.1)
       (i (make-center-percent 6.8 p)))
  (parameterize ((current-test-epsilon 0.01))
    (test (+ p p) (percent (mul-interval i i)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-14" class="outline-3">
<h3 id="sec-2-14"><span class="section-number-3">2.14</span> <span class="done DONE">DONE</span> 2.14</h3>
<div class="outline-text-3" id="text-2-14">
<p>
The first formula for parallel resistors gives much looser bounds:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"interval-percent.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">par1</span> r1 r2)
  (div-interval (mul-interval r1 r2)
                (add-interval r1 r2)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">par2</span> r1 r2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((one (make-interval 1 1)))
    (div-interval
     one (add-interval (div-interval one r1)
                       (div-interval one r2)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((r (make-center-percent 6.8 0.1)))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (par1 r r))
        (p2 (par2 r r)))
    (test 3.5374 (center p1))
    (test 0.292233 (percent p1))
    (test 3.4 (center p2))
    (test 0.1 (percent p2))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-15" class="outline-3">
<h3 id="sec-2-15"><span class="section-number-3">2.15</span> <span class="done DONE">DONE</span> 2.15</h3>
<div class="outline-text-3" id="text-2-15">
<p>
Operations involving intervals reduce precision (i.e. increase error
bounds); Alyssa is therefore correct that <code>par2</code> is “better” in the
sense that it produces tighter bounds.
</p>
</div>
</div>
<div id="outline-container-sec-2-16" class="outline-3">
<h3 id="sec-2-16"><span class="section-number-3">2.16</span> <span class="done DONE">DONE</span> 2.16</h3>
<div class="outline-text-3" id="text-2-16">
<p>
As in <a href="#sec-2-15">problem 2.15</a>, operations involving intervals reduce precision;
equivalent algebraic expressions with nevertheless fewer operations
involving intervals might have better precision.
</p>

<p>
An interval-arithmetic package that reduces equations to their
simplest form before computing on intervals would not have this
shortcoming.
</p>
</div>

<div id="outline-container-sec-2-16-1" class="outline-4">
<h4 id="sec-2-16-1"><span class="section-number-4">2.16.1</span> <span class="todo TODO">TODO</span> Implement simplification</h4>
</div>
</div>
<div id="outline-container-sec-2-17" class="outline-3">
<h3 id="sec-2-17"><span class="section-number-3">2.17</span> <span class="done DONE">DONE</span> 2.17</h3>
<div class="outline-text-3" id="text-2-17">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">last-pair</span> list)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr list))
      list
      (last-pair (cdr list))))

(test '(34) (last-pair (list 23 72 149 34)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-18" class="outline-3">
<h3 id="sec-2-18"><span class="section-number-3">2.18</span> <span class="done DONE">DONE</span> 2.18</h3>
<div class="outline-text-3" id="text-2-18">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">reverse</span> list)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((reverse '())
             (list list))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? list)
        reverse
        (iter (cons (car list) reverse)
              (cdr list)))))

(test '(25 16 9 4 1)
      (reverse (list 1 4 9 16 25)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-19" class="outline-3">
<h3 id="sec-2-19"><span class="section-number-3">2.19</span> <span class="done DONE">DONE</span> 2.19</h3>
<div class="outline-text-3" id="text-2-19">
<p>
The order of <code>coin-values</code> shouldn’t affect <code>cc</code>, since it tries
every permutation.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">first-denomination</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">except-first-denomination</span> cdr)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">no-more?</span> null?)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cc</span> amount coin-values)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= amount 0) 1)
        ((<span style="color: #00ffff; font-weight: bold;">or</span> (&lt; amount 0) (no-more? coin-values)) 0)
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (+ (cc amount
                (except-first-denomination
                 coin-values))
            (cc (- amount
                   (first-denomination
                    coin-values))
                coin-values)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">us-coins</span> (list 50 25 10 5 1))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">uk-coins</span> (list 100 50 20 10 5 2 1 0.5))

(test 292 (cc 100 us-coins))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-20" class="outline-3">
<h3 id="sec-2-20"><span class="section-number-3">2.20</span> <span class="done DONE">DONE</span> 2.20</h3>
<div class="outline-text-3" id="text-2-20">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">filter</span> predicate? list)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? list)
      '()
      (<span style="color: #00ffff; font-weight: bold;">if</span> (predicate? (car list))
          (cons (car list) (filter predicate? (cdr list)))
          (filter predicate? (cdr list)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-parity</span> . numbers)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (even? (car numbers))
      (filter even? numbers)
      (filter odd? numbers)))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Non-branching alternative</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-parity</span> a . rest)
  (cons a (filter (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (= (remainder a 2) (remainder n 2))) rest)))

(test '(1 3 5 7) (same-parity 1 2 3 4 5 6 7))
(test '(2 4 6) (same-parity 2 3 4 5 6 7))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-21" class="outline-3">
<h3 id="sec-2-21"><span class="section-number-3">2.21</span> <span class="done DONE">DONE</span> 2.21</h3>
<div class="outline-text-3" id="text-2-21">
<div class="org-src-container">

<pre class="src src-scheme">(use (only sicp nil square) test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-list</span> items)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? items)
      nil
      (cons (square (car items)) (square-list (cdr items)))))

(test '(1 4 9 16) (square-list (list 1 2 3 4)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-list</span> items)
  (<span style="color: #00ffff; font-weight: bold;">map</span> square items))

(test '(1 4 9 16) (square-list (list 1 2 3 4)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-22" class="outline-3">
<h3 id="sec-2-22"><span class="section-number-3">2.22</span> <span class="done DONE">DONE</span> 2.22</h3>
<div class="outline-text-3" id="text-2-22">
<p>
The first solution reverses the answers since it conses the elements
to the front of the list in front-to-back order.
</p>

<p>
The second solution doesn’t work since it doesn’t produce the proper
sequence of nested conses to form a list.
</p>
</div>
</div>
<div id="outline-container-sec-2-23" class="outline-3">
<h3 id="sec-2-23"><span class="section-number-3">2.23</span> <span class="done DONE">DONE</span> 2.23</h3>
<div class="outline-text-3" id="text-2-23">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">for-each</span> f list)
  (unless (null? list)
    (<span style="color: #00ffff; font-weight: bold;">begin</span>
      (f (car list))
      (<span style="color: #00ffff; font-weight: bold;">for-each</span> f (cdr list)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((x '()))
  (<span style="color: #00ffff; font-weight: bold;">for-each</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (set! x (cons i x))) '(1 2 3))
  (test x '(3 2 1)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-24" class="outline-3">
<h3 id="sec-2-24"><span class="section-number-3">2.24</span> <span class="done DONE">DONE</span> 2.24</h3>
<div class="outline-text-3" id="text-2-24">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(test '(1 (2 (3 4))) (list 1 (list 2 (list 3 4))))
</pre>
</div>


<div class="figure">
<p><img src="./2.23-box-and-pointer.jpg" alt="2.23-box-and-pointer.jpg" />
</p>
<p><span class="figure-number">Figure 2:</span> Box-and-pointer diagram</p>
</div>


<div class="figure">
<p><img src="2.23-tree.png" alt="2.23-tree.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-25" class="outline-3">
<h3 id="sec-2-25"><span class="section-number-3">2.25</span> <span class="done DONE">DONE</span> 2.25</h3>
<div class="outline-text-3" id="text-2-25">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(test 7 (car (cdaddr '(1 3 (5 7) 9))))
(test 7 (caar '((7))))
(test 7 (cadadr (cadadr (cadadr '(1 (2 (3 (4 (5 (6 7))))))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-26" class="outline-3">
<h3 id="sec-2-26"><span class="section-number-3">2.26</span> <span class="done DONE">DONE</span> 2.26</h3>
<div class="outline-text-3" id="text-2-26">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> (list 1 2 3))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (list 4 5 6))

(test '(1 2 3 4 5 6) (append x y))
(test '((1 2 3) 4 5 6) (cons x y))
(test '((1 2 3) (4 5 6)) (list x y))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-27" class="outline-3">
<h3 id="sec-2-27"><span class="section-number-3">2.27</span> <span class="done DONE">DONE</span> 2.27</h3>
<div class="outline-text-3" id="text-2-27">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deep-reverse</span> list)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((list list)
             (reverse '()))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? list)
        reverse
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((first (car list)))
          (iter (cdr list)
                (cons (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? first)
                          (deep-reverse first)
                          first)
                      reverse))))))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Or using higher-order functions.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deep-reverse</span> list)
  (reverse (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (element)
                  (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? element)
                      (deep-reverse element)
                      element))
                list)))

(test '(((7 6 5) 4 3) (2 1))
      (deep-reverse '((1 2) (3 4 (5 6 7)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-28" class="outline-3">
<h3 id="sec-2-28"><span class="section-number-3">2.28</span> <span class="done DONE">DONE</span> 2.28</h3>
<div class="outline-text-3" id="text-2-28">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fringe</span> list)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((list list)
             (leaves '()))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? list)
        leaves
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((first (car list)))
          (iter (cdr list)
                (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? first)
                    (append (fringe first) leaves)
                    (cons first leaves)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> '((1 2) (3 4)))
(test '(4 3 2 1) (fringe x))
(test '(4 3 2 1 4 3 2 1) (fringe (list x x)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-29" class="outline-3">
<h3 id="sec-2-29"><span class="section-number-3">2.29</span> <span class="done DONE">DONE</span> 2.29</h3>
<div class="outline-text-3" id="text-2-29">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-mobile</span> left right)
  (list left right))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-branch</span> length structure)
  (list length structure))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">left-branch</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">right-branch</span> cadr)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">branch-length</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">branch-structure</span> cadr)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">total-weight</span> mobile)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((left-structure (branch-structure (left-branch mobile)))
        (right-structure (branch-structure (right-branch mobile))))
    (+ (<span style="color: #00ffff; font-weight: bold;">if</span> (number? left-structure)
           left-structure
           (total-weight left-structure))
       (<span style="color: #00ffff; font-weight: bold;">if</span> (number? right-structure)
           right-structure
           (total-weight right-structure)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">mobile</span>
  (make-mobile (make-branch
                2
                (make-mobile
                 (make-branch
                  2
                  (make-mobile
                   (make-branch 3 16)
                   (make-branch 2 20)))
                 (make-branch 4 20)))
               (make-branch 5 102.4)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">torque</span> branch)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((structure (branch-structure branch)))
    (* (branch-length branch)
       (<span style="color: #00ffff; font-weight: bold;">if</span> (number? structure)
           structure
           (+ (torque (left-branch structure))
              (torque (right-branch structure)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">balanced?</span> mobile)
  (= (torque (left-branch mobile))
     (torque (right-branch mobile))))

(test 158.4 (total-weight mobile))

(test-assert (balanced? mobile))
</pre>
</div>


<div class="figure">
<p><img src="./2.29-mobile.jpg" alt="2.29-mobile.jpg" />
</p>
<p><span class="figure-number">Figure 4:</span> Mobile</p>
</div>

<p>
In order to accomodate <code>cons</code> vs. <code>list</code>, we only need to modify the
accessors <code>right-branch</code>, <code>branch-structure</code> to use <code>cdr</code> instead of
<code>cadr</code>.
</p>
</div>
</div>
<div id="outline-container-sec-2-30" class="outline-3">
<h3 id="sec-2-30"><span class="section-number-3">2.30</span> <span class="done DONE">DONE</span> 2.30</h3>
<div class="outline-text-3" id="text-2-30">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-tree-direct</span> tree)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? tree) nil)
        ((not (pair? tree)) (square tree))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (cons (square-tree-direct (car tree))
                    (square-tree-direct (cdr tree))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-tree-map</span> tree)
  (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (sub-tree)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? sub-tree)
             (square-tree-map sub-tree)
             (square sub-tree)))
       tree))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree</span> (list 1 (list 2 (list 3 4) 5) (list 6 7)))

(test '(1 (4 (9 16) 25) (36 49)) (square-tree-direct tree))
(test '(1 (4 (9 16) 25) (36 49)) (square-tree-map tree))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-31" class="outline-3">
<h3 id="sec-2-31"><span class="section-number-3">2.31</span> <span class="done DONE">DONE</span> 2.31</h3>
<div class="outline-text-3" id="text-2-31">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tree-map</span> f tree)
  (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (sub-tree)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? sub-tree)
             (tree-map f sub-tree)
             (f sub-tree)))
       tree))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-tree</span> tree) (tree-map square tree))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree</span> (list 1 (list 2 (list 3 4) 5) (list 6 7)))

(test '(1 (4 (9 16) 25) (36 49)) (square-tree tree))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-32" class="outline-3">
<h3 id="sec-2-32"><span class="section-number-3">2.32</span> <span class="done DONE">DONE</span> 2.32</h3>
<div class="outline-text-3" id="text-2-32">
<p>
It recursively descends to <code>(null? s)</code>, the base case, where it
seeds the unwinding with <code>(())</code>; and, as it unwinds the recursion,
it has already generated all subsets of the last \(n\) elements: all
that is required is to <code>cons</code> the \(n - 1^{st}\) element to all
subsets of the last \(n\) elements.
</p>

<p>
To see that this is the case, look at the zeroeth case, where it has
generated the empty set; look also at the first case, where it has
taken the <code>car</code> of <code>s</code>, e.g. <code>3</code>, and appended it to <code>()</code>, yielding
<code>(3)</code>.
</p>

<p>
The next step will <code>cons</code> <code>2</code> to <code>()</code> and <code>(3)</code>, append it to the
previously unwound subsets <code>(() (3))</code>, yielding <code>(() (3) (2) (2
  3))</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">subsets</span> s)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? s)
      (list nil)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((rest (subsets (cdr s))))
        (append rest (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (subset) (cons (car s) subset)) rest)))))

(test '(() (3) (2) (2 3) (1) (1 3) (1 2) (1 2 3)) (subsets '(1 2 3)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-33" class="outline-3">
<h3 id="sec-2-33"><span class="section-number-3">2.33</span> <span class="done DONE">DONE</span> 2.33</h3>
<div class="outline-text-3" id="text-2-33">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">map</span> p sequence)
  (accumulate (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (cons (p x) y)) nil sequence))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">list</span> '(1 2 3))

(test '(1 4 9) (<span style="color: #00ffff; font-weight: bold;">map</span> square list))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">append</span> seq1 seq2)
  (accumulate cons seq1 seq2))

(test '(1 2 3 1 2 3) (append list list))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">length</span> sequence)
  (accumulate (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (+ y 1)) 0 sequence))

(test 3 (length list))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-34" class="outline-3">
<h3 id="sec-2-34"><span class="section-number-3">2.34</span> <span class="done DONE">DONE</span> 2.34</h3>
<div class="outline-text-3" id="text-2-34">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">horner-eval</span> x coefficient-sequence)
  (accumulate (<span style="color: #00ffff; font-weight: bold;">lambda</span> (this-coeff higher-terms) (+ (* higher-terms x) this-coeff))
              0
              coefficient-sequence))

(test 79 (horner-eval 2 (list 1 3 0 5 0 1)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-35" class="outline-3">
<h3 id="sec-2-35"><span class="section-number-3">2.35</span> <span class="done DONE">DONE</span> 2.35</h3>
<div class="outline-text-3" id="text-2-35">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">count-leaves</span> t)
  (accumulate + 0 (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (subtree)
                         (<span style="color: #00ffff; font-weight: bold;">if</span> (pair? subtree)
                             (count-leaves subtree)
                             (<span style="color: #00ffff; font-weight: bold;">if</span> (null? subtree) 0 1)))
                       t)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> (cons (list 1 2 '()) (list 3 4)))

(test 4 (count-leaves x))
(test 8 (count-leaves (list x x)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-36" class="outline-3">
<h3 id="sec-2-36"><span class="section-number-3">2.36</span> <span class="done DONE">DONE</span> 2.36</h3>
<div class="outline-text-3" id="text-2-36">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">accumulate-n</span> op init seqs)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (car seqs))
      nil
      (cons (accumulate op init (<span style="color: #00ffff; font-weight: bold;">map</span> car seqs))
            (accumulate-n op init (<span style="color: #00ffff; font-weight: bold;">map</span> cdr seqs)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"accumulate-n.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">s</span> '((1 2 3) (4 5 6) (7 8 9) (10 11 12)))

(test '(22 26 30) (accumulate-n + 0 s))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-37" class="outline-3">
<h3 id="sec-2-37"><span class="section-number-3">2.37</span> <span class="done DONE">DONE</span> 2.37</h3>
<div class="outline-text-3" id="text-2-37">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"accumulate-n.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">m</span> '((1 -1 2) (0 -3 1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">v</span> '(2 1 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">dot-product</span> v w)
  (accumulate + 0 (<span style="color: #00ffff; font-weight: bold;">map</span> * v w)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">matrix-*-vector</span> m v)
  (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (w) (dot-product v w)) m))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">transpose</span> mat)
  (accumulate-n cons '() mat))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">matrix-*-matrix</span> m n)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((cols (transpose n)))
    (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (w) (matrix-*-vector cols w)) m)))

(test '(1 -3) (matrix-*-vector m v))

(test '((1 0) (-1 -3) (2 1)) (transpose m))

(test '((6 5) (5 10)) (matrix-*-matrix m (transpose m)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-38" class="outline-3">
<h3 id="sec-2-38"><span class="section-number-3">2.38</span> <span class="done DONE">DONE</span> 2.38</h3>
<div class="outline-text-3" id="text-2-38">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">fold-right</span> accumulate)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fold-left</span> op initial sequence)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">iter</span> result rest)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? rest)
        result
        (iter (op result (car rest))
              (cdr rest))))
  (iter initial sequence))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"fold.scm"</span>)

(test (/ 3 2) (fold-right / 1 (list 1 2 3)))
(test (/ 1 6) (fold-left / 1 (list 1 2 3)))
(test '(1 (2 (3 ()))) (fold-right list nil (list 1 2 3)))
(test '(((() 1) 2) 3) (fold-left list nil (list 1 2 3)))
</pre>
</div>

<p>
<code>op</code> needs to be commutative for <code>fold-right</code> and <code>fold-left</code> to
produce the same result.
</p>
</div>
</div>
<div id="outline-container-sec-2-39" class="outline-3">
<h3 id="sec-2-39"><span class="section-number-3">2.39</span> <span class="done DONE">DONE</span> 2.39</h3>
<div class="outline-text-3" id="text-2-39">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"fold.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">l</span> '(1 2 3))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">reverse</span> sequence)
  (fold-right (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (append y (list x))) nil sequence))

(test '(3 2 1) (reverse l))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">reverse</span> sequence)
  (fold-left (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (cons y x)) nil sequence))

(test '(3 2 1) (reverse l))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-40" class="outline-3">
<h3 id="sec-2-40"><span class="section-number-3">2.40</span> <span class="done DONE">DONE</span> 2.40</h3>
<div class="outline-text-3" id="text-2-40">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">unique-pairs</span> n)
  (flatmap
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i)
     (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (j) (list i j))
          (enumerate-interval 1 (- i 1))))
   (enumerate-interval 1 n)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(include <span style="color: #00ff00;">"unique-pairs.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">prime-sum?</span> pair)
  (prime? (+ (car pair) (cadr pair))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-pair-sum</span> pair)
  (list (car pair) (cadr pair) (+ (car pair) (cadr pair))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">prime-sum-pairs</span> n)
  (<span style="color: #00ffff; font-weight: bold;">map</span> make-pair-sum (filter prime-sum? (unique-pairs n))))

(test '((2 1 3) (3 2 5) (4 1 5) (4 3 7) (5 2 7) (6 1 7) (6 5 11))
      (prime-sum-pairs 6))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-41" class="outline-3">
<h3 id="sec-2-41"><span class="section-number-3">2.41</span> <span class="done DONE">DONE</span> 2.41</h3>
<div class="outline-text-3" id="text-2-41">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(include <span style="color: #00ff00;">"unique-pairs.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">unique-triples</span> n)
  (flatmap
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i)
     (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (j) (cons i j)) (unique-pairs (- i 1))))
   (enumerate-interval 1 n)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-to?</span> s)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (triple)
    (= s (apply + triple))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum-to-triples</span> n s)
  (filter (sum-to? s) (unique-triples n)))

(test '((5 4 3) (6 4 2) (6 5 1)) (sum-to-triples 6 12))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-42" class="outline-3">
<h3 id="sec-2-42"><span class="section-number-3">2.42</span> <span class="done DONE">DONE</span> 2.42</h3>
<div class="outline-text-3" id="text-2-42">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">empty-board</span> '())

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">slope</span> x1 y1 x2 y2)
  (/ (- y2 y1) (- x2 x1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">safe?</span> k positions)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((kth-position (list-ref positions (- k 1))))
    (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((positions positions)
               (i 1))
      (<span style="color: #00ffff; font-weight: bold;">or</span> (null? positions)
          (<span style="color: #00ffff; font-weight: bold;">if</span> (= i k)
              (iter (cdr positions) (+ i 1))
              (<span style="color: #00ffff; font-weight: bold;">let*</span> ((ith-position (car positions))
                     (slope (slope i ith-position
                                   k kth-position)))
                (<span style="color: #00ffff; font-weight: bold;">and</span> (not (<span style="color: #00ffff; font-weight: bold;">or</span> (= slope 0)
                              (= (abs slope) 1)))
                     (iter (cdr positions) (+ i 1)))))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-position</span> new-row k rest-of-queens)
  (append (take rest-of-queens (- k 1))
          (list new-row)
          (drop rest-of-queens (- k 1))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">queens</span> board-size)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">queen-cols</span> k)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= k 0)
        (list empty-board)
        (filter
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (positions) (safe? k positions))
         (flatmap
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> (rest-of-queens)
            (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (new-row)
                   (adjoin-position new-row k rest-of-queens))
                 (enumerate-interval 1 board-size)))
          (queen-cols (- k 1))))))
  (queen-cols board-size))

(time (test 92 (length (queens 8))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-43" class="outline-3">
<h3 id="sec-2-43"><span class="section-number-3">2.43</span> <span class="done DONE">DONE</span> 2.43</h3>
<div class="outline-text-3" id="text-2-43">
<p>
The first implementation of queens prunes the tree based on <code>safe?</code>;
the second doesn’t. The second, therefore, evaluates all \(6 ^ 6 =
  46656\) possibilities; pruning on <code>safe?</code> should reduce all
subsequent moves by at least one possibility, meaning that the tree
is at worst \(6! = 720\) possibilities and that the non-pruning
version should run in more than \(64T\).
</p>

<p>
Scratch that:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">\(k\)</th>
<th scope="col" class="right">\(t\) (ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">8</td>
<td class="right">0.18</td>
</tr>

<tr>
<td class="right">9</td>
<td class="right">1.12</td>
</tr>

<tr>
<td class="right">10</td>
<td class="right">5.44</td>
</tr>

<tr>
<td class="right">11</td>
<td class="right">22.85</td>
</tr>
</tbody>
</table>

<p>
Appears to obey a power-law implying \(O(n^{15})\).
</p>
</div>
</div>
<div id="outline-container-sec-2-44" class="outline-3">
<h3 id="sec-2-44"><span class="section-number-3">2.44</span> <span class="done DONE">DONE</span> 2.44</h3>
<div class="outline-text-3" id="text-2-44">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">up-split</span> painter n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0)
      painter
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((smaller (up-split painter (- n 1))))
        (below painter (beside smaller smaller)))))

(write-painter-to-png (up-split (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>) 2) <span style="color: #00ff00;">"2.44.png"</span>)
</pre>
</div>


<div class="figure">
<p><img src="./2.44.png" alt="2.44.png" />
</p>
<p><span class="figure-number">Figure 5:</span> <code>up-split</code></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-45" class="outline-3">
<h3 id="sec-2-45"><span class="section-number-3">2.45</span> <span class="done DONE">DONE</span> 2.45</h3>
<div class="outline-text-3" id="text-2-45">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">split</span> first-preposition second-preposition)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (painter n)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0)
        painter
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((smaller ((split first-preposition second-preposition)
                        painter
                        (- n 1))))
          (first-preposition painter (second-preposition smaller smaller))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">right-split</span> (split beside below))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">up-split</span> (split below beside))

(write-painter-to-png (right-split (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>) 4)
                      <span style="color: #00ff00;">"2.45-right-split.png"</span>)
(write-painter-to-png (up-split (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>) 4)
                      <span style="color: #00ff00;">"2.45-up-split.png"</span>)
</pre>
</div>



<div class="figure">
<p><img src="./2.45-right-split.png" alt="2.45-right-split.png" />
</p>
<p><span class="figure-number">Figure 6:</span> <code>right-split</code></p>
</div>


<div class="figure">
<p><img src="./2.45-up-split.png" alt="2.45-up-split.png" />
</p>
<p><span class="figure-number">Figure 7:</span> <code>up-split</code></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-46" class="outline-3">
<h3 id="sec-2-46"><span class="section-number-3">2.46</span> <span class="done DONE">DONE</span> 2.46</h3>
<div class="outline-text-3" id="text-2-46">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-vect</span> cons)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">xcor-vect</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">ycor-vect</span> cdr)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-vect</span> v1 v2)
  (make-vect (+ (xcor-vect v1)
                (xcor-vect v2))
             (+ (ycor-vect v1)
                (ycor-vect v2))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-vect</span> v1 v2)
  (add-vect v1 (make-vect (- (xcor-vect v2))
                          (- (ycor-vect v2)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scale-vect</span> s v1)
  (make-vect (* s (xcor-vect v1))
             (* s (ycor-vect v1))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)
(include <span style="color: #00ff00;">"vect.scm"</span>)

(test (make-vect 4 7)
      (add-vect (make-vect 1 2) (make-vect 3 5)))

(test (make-vect -2 -3)
      (sub-vect (make-vect 1 2) (make-vect 3 5)))

(test (make-vect 6 15)
      (scale-vect 3 (make-vect 2 5)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-47" class="outline-3">
<h3 id="sec-2-47"><span class="section-number-3">2.47</span> <span class="done DONE">DONE</span> 2.47</h3>
<div class="outline-text-3" id="text-2-47">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-frame</span> origin edge1 edge2)
  (list origin edge1 edge2))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">origin-frame</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">edge1-frame</span> cadr)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">edge2-frame</span> caddr)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)
(include <span style="color: #00ff00;">"frame.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((frame (make-frame (make-vect 0 0)
                         (make-vect 1 1)
                         (make-vect 2 2))))
  (test (make-vect 0 0) (origin-frame frame))
  (test (make-vect 1 1) (edge1-frame frame))
  (test (make-vect 2 2) (edge2-frame frame)))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">The other representation.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-frame</span> origin edge1 edge2)
  (cons origin (cons edge1 edge2)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">edge2-frame</span> cddr)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((frame (make-frame (make-vect 0 0)
                         (make-vect 1 1)
                         (make-vect 2 2))))
  (test (make-vect 0 0) (origin-frame frame))
  (test (make-vect 1 1) (edge1-frame frame))
  (test (make-vect 2 2) (edge2-frame frame)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-48" class="outline-3">
<h3 id="sec-2-48"><span class="section-number-3">2.48</span> <span class="done DONE">DONE</span> 2.48</h3>
<div class="outline-text-3" id="text-2-48">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #ffff00;">;; </span><span style="color: #ffff00;">We'll reuse make-segment from 2.2.</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-49" class="outline-3">
<h3 id="sec-2-49"><span class="section-number-3">2.49</span> <span class="done DONE">DONE</span> 2.49</h3>
<div class="outline-text-3" id="text-2-49">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"segment.scm"</span>)
(include <span style="color: #00ff00;">"vect.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">outline</span>
  (list
   (make-segment (make-vect 0 0) (make-vect 0 1))
   (make-segment (make-vect 0 1) (make-vect 1 1))
   (make-segment (make-vect 1 1) (make-vect 1 0))
   (make-segment (make-vect 1 0) (make-vect 0 0))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span>
  (list
   (make-segment (make-vect 0 0) (make-vect 1 1))
   (make-segment (make-vect 0 1) (make-vect 1 0))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">diamond</span>
  (list
   (make-segment (make-vect 0.5 0) (make-vect 1 0.5))
   (make-segment (make-vect 1 0.5) (make-vect 0.5 1))
   (make-segment (make-vect 0.5 1) (make-vect 0 0.5))
   (make-segment (make-vect 0 0.5) (make-vect 0.5 0))))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Needs to be asymmetrical, so we can see rotations and flips.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">wave</span>
  (list
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Left leg</span>
   (make-segment (make-vect 0.3 1) (make-vect 0.4 0.6))
   (make-segment (make-vect 0.4 1) (make-vect 0.5 0.7))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Right leg</span>
   (make-segment (make-vect 0.6 1) (make-vect 0.5 0.7))
   (make-segment (make-vect 0.7 1) (make-vect 0.6 0.6))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Torso</span>
   (make-segment (make-vect 0.4 0.6) (make-vect 0.4 0.4))
   (make-segment (make-vect 0.6 0.6) (make-vect 0.6 0.4))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Left arm</span>
   (make-segment (make-vect 0.4 0.4) (make-vect 0.2 0.35))
   (make-segment (make-vect 0.2 0.35) (make-vect 0.2 0.25))
   (make-segment (make-vect 0.2 0.25) (make-vect 0.45 0.3))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Right arm</span>
   (make-segment (make-vect 0.6 0.4) (make-vect 0.8 0.45))
   (make-segment (make-vect 0.8 0.45) (make-vect 0.8 0.35))
   (make-segment (make-vect 0.8 0.35) (make-vect 0.55 0.3))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Neck</span>
   (make-segment (make-vect 0.45 0.3) (make-vect 0.45 0.25))
   (make-segment (make-vect 0.55 0.3) (make-vect 0.55 0.25))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Head</span>
   (make-segment (make-vect 0.45 0.25) (make-vect 0.425 0.25))
   (make-segment (make-vect 0.425 0.25) (make-vect 0.425 0.05))
   (make-segment (make-vect 0.425 0.05) (make-vect 0.575 0.05))
   (make-segment (make-vect 0.575 0.05) (make-vect 0.575 0.25))
   (make-segment (make-vect 0.575 0.25) (make-vect 0.55 0.25))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp)
(include <span style="color: #00ff00;">"painters.scm"</span>)

(write-painter-to-svg (segments-&gt;painter outline) <span style="color: #00ff00;">"2.49-outline.svg"</span>)
(write-painter-to-svg (segments-&gt;painter x) <span style="color: #00ff00;">"2.49-x.svg"</span>)
(write-painter-to-svg (segments-&gt;painter diamond) <span style="color: #00ff00;">"2.49-diamond.svg"</span>)
(write-painter-to-svg (segments-&gt;painter wave) <span style="color: #00ff00;">"2.49-wave.svg"</span>)
</pre>
</div>


<div class="figure">
<p><img src="./2.49-diamond.svg" alt="2.49-diamond.svg" />
</p>
<p><span class="figure-number">Figure 8:</span> Diamond</p>
</div>


<div class="figure">
<p><img src="./2.49-outline.svg" alt="2.49-outline.svg" />
</p>
<p><span class="figure-number">Figure 9:</span> Outline</p>
</div>


<div class="figure">
<p><img src="./2.49-x.svg" alt="2.49-x.svg" />
</p>
<p><span class="figure-number">Figure 10:</span> X</p>
</div>


<div class="figure">
<p><img src="./2.49-wave.svg" alt="2.49-wave.svg" />
</p>
<p><span class="figure-number">Figure 11:</span> Wave</p>
</div>
</div>
</div>
<div id="outline-container-sec-2-50" class="outline-3">
<h3 id="sec-2-50"><span class="section-number-3">2.50</span> <span class="done DONE">DONE</span> 2.50</h3>
<div class="outline-text-3" id="text-2-50">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">flip-horiz</span> painter)
  (transform-painter painter
                     (make-vect 1 0)
                     (make-vect 0 0)
                     (make-vect 1 1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">rotate180</span> (compose rotate90 rotate90))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">rotate270</span> (compose rotate180 rotate90))

(write-painter-to-png (flip-horiz (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)) <span style="color: #00ff00;">"2.50-horiz.png"</span>)
(write-painter-to-png (rotate180 (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)) <span style="color: #00ff00;">"2.50-rotate180.png"</span>)
(write-painter-to-png (rotate270 (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)) <span style="color: #00ff00;">"2.50-rotate270.png"</span>)
</pre>
</div>


<div class="figure">
<p><img src="./2.50-horiz.png" alt="2.50-horiz.png" />
</p>
<p><span class="figure-number">Figure 12:</span> Flipped horizontally</p>
</div>


<div class="figure">
<p><img src="./2.50-rotate180.png" alt="2.50-rotate180.png" />
</p>
<p><span class="figure-number">Figure 13:</span> Rotated 180°</p>
</div>


<div class="figure">
<p><img src="./2.50-rotate270.png" alt="2.50-rotate270.png" />
</p>
<p><span class="figure-number">Figure 14:</span> Rotated 270°</p>
</div>
</div>
</div>
<div id="outline-container-sec-2-51" class="outline-3">
<h3 id="sec-2-51"><span class="section-number-3">2.51</span> <span class="done DONE">DONE</span> 2.51</h3>
<div class="outline-text-3" id="text-2-51">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">below</span> painter1 painter2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((split-point (make-vect 1 0.5)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((paint-top
           (transform-painter
            painter2
            (make-vect 0 0)
            (make-vect 1 0)
            (make-vect 0 0.5)))
          (paint-bottom
           (transform-painter
            painter1
            (make-vect 0 0.5)
            split-point
            (make-vect 0 1)
            )))
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> (frame)
        (paint-top frame)
        (paint-bottom frame)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((lena (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)))
  (write-painter-to-png (below lena lena) <span style="color: #00ff00;">"2.51-below-direct.png"</span>))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">below</span> painter1 painter2)
  (rotate90 (beside (rotate270 painter1) (rotate270 painter2))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((lena (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)))
  (write-painter-to-png (below lena lena) <span style="color: #00ff00;">"2.51-below-indirect.png"</span>))
</pre>
</div>


<div class="figure">
<p><img src="./2.51-below-direct.png" alt="2.51-below-direct.png" />
</p>
<p><span class="figure-number">Figure 15:</span> <code>below</code> written directly</p>
</div>


<div class="figure">
<p><img src="./2.51-below-indirect.png" alt="2.51-below-indirect.png" />
</p>
<p><span class="figure-number">Figure 16:</span> <code>below</code> written indirectly (i.e. in terms of rotations)</p>
</div>
</div>
</div>
<div id="outline-container-sec-2-52" class="outline-3">
<h3 id="sec-2-52"><span class="section-number-3">2.52</span> <span class="done DONE">DONE</span> 2.52</h3>
<div class="outline-text-3" id="text-2-52">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)
(include <span style="color: #00ff00;">"painters.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">wave-with-smile</span>
  (append wave
          (list (make-segment (make-vect 0.48 0.2) (make-vect 0.52 0.2))
                (make-segment (make-vect 0.45 0.13) (make-vect 0.47 0.13))
                (make-segment (make-vect 0.53 0.13) (make-vect 0.55 0.13)))))

(write-painter-to-svg (segments-&gt;painter wave-with-smile) <span style="color: #00ff00;">"2.52-smile.svg"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">corner-split</span> painter n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0)
      painter
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((up (up-split painter (- n 1)))
            (right (right-split painter (- n 1))))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((top-left up)
              (bottom-right right)
              (corner (corner-split painter (- n 1))))
          (beside (below painter top-left)
                  (below bottom-right corner))))))

(write-painter-to-png (corner-split (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>) 5)
                     <span style="color: #00ff00;">"2.52-corner-split.png"</span>)

(write-painter-to-png (square-limit (flip-horiz (image-&gt;painter <span style="color: #00ff00;">"lena.png"</span>)) 5)
                     <span style="color: #00ff00;">"2.52-square-limit.png"</span>)
</pre>
</div>


<div class="figure">
<p><img src="./2.52-smile.svg" alt="2.52-smile.svg" />
</p>
<p><span class="figure-number">Figure 17:</span> Add a smile</p>
</div>


<div class="figure">
<p><img src="./2.52-corner-split.png" alt="2.52-corner-split.png" />
</p>
<p><span class="figure-number">Figure 18:</span> Corner split with only one top and one right</p>
</div>


<div class="figure">
<p><img src="./2.52-square-limit.png" alt="2.52-square-limit.png" />
</p>
<p><span class="figure-number">Figure 19:</span> Square limit with flipped wave</p>
</div>
</div>
</div>
<div id="outline-container-sec-2-53" class="outline-3">
<h3 id="sec-2-53"><span class="section-number-3">2.53</span> <span class="done DONE">DONE</span> 2.53</h3>
<div class="outline-text-3" id="text-2-53">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(test '(a b c) (list 'a 'b 'c))
(test '((george)) (list (list 'george)))
(test '((y1 y2)) (cdr '((x1 x2) (y1 y2))))
(test '(y1 y2) (cadr '((x1 x2) (y1 y2))))
(test #f (pair? (car '(a short list))))
(test #f (memq 'red '((red shoes) (blue shoes))))
(test '(red shoes blue shoes) (memq 'red '(red shoes blue shoes)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-54" class="outline-3">
<h3 id="sec-2-54"><span class="section-number-3">2.54</span> <span class="done DONE">DONE</span> 2.54</h3>
<div class="outline-text-3" id="text-2-54">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equal?</span> l1 l2)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">and</span> (symbol? l1) (symbol? l2))
         (eq? l1 l2))
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (number? l1) (number? l2))
         (= l1 l2))
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (pair? l1) (pair? l2))
         (<span style="color: #00ffff; font-weight: bold;">and</span> (equal? (car l1) (car l2))
              (equal? (cdr l1) (cdr l2))))))

(test-assert (equal? '(this is a list) '(this is a list)))
(test-assert (not (equal? '(this is a list) '(this (is a) list))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-55" class="outline-3">
<h3 id="sec-2-55"><span class="section-number-3">2.55</span> <span class="done DONE">DONE</span> 2.55</h3>
<div class="outline-text-3" id="text-2-55">
<p>
<code>’’abracadabra</code> evaluates to <code>(quote (quote abracadabra))</code>; the
<code>car</code> of which evaluates to <code>quote</code>.
</p>
</div>
</div>
<div id="outline-container-sec-2-56" class="outline-3">
<h3 id="sec-2-56"><span class="section-number-3">2.56</span> <span class="done DONE">DONE</span> 2.56</h3>
<div class="outline-text-3" id="text-2-56">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-diff</span> a1 a2)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((=number? a1 0) a2)
        ((=number? a2 0) a1)
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (number? a1) (number? a2))
         (- a1 a2))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (list '- a1 a2))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv</span> exp var)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? exp) 0)
        ((variable? exp) (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? exp var) 1 0))
        ((sum? exp) (make-sum (deriv (addend exp) var)
                              (deriv (augend exp) var)))
        ((product? exp)
         (make-sum
          (make-product (multiplier exp)
                        (deriv (multiplicand exp) var))
          (make-product (deriv (multiplier exp) var)
                        (multiplicand exp))))
        ((exponentiation? exp)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((base (base exp))
               (exponent (exponent exp)))
           (make-product exponent
                         (make-product
                          (make-exponentiation base (make-diff exponent 1))
                          (deriv base var)))))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (error <span style="color: #00ff00;">"Unknown expression type: DERIV"</span> exp))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">exponentiation?</span> x) (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (eq? (car x) '**)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">base</span> cadr)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">exponent</span> caddr)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-exponentiation</span> b e)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((=number? e 0) 1)
        ((=number? e 1) b)
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (number? b) (number? e))
         (expt b e))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (list '** b e))))

(test '(* y (** x (- y 1))) (deriv '(** x y) 'x))
(test '(* 2 x) (deriv '(** x 2) 'x))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-57" class="outline-3">
<h3 id="sec-2-57"><span class="section-number-3">2.57</span> <span class="done DONE">DONE</span> 2.57</h3>
<div class="outline-text-3" id="text-2-57">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">augend</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((augenda (cddr x)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr augenda))
        (car augenda)
        (cons '+ augenda))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">multiplicand</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((multiplicanda (cddr x)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr multiplicanda))
        (car multiplicanda)
        (cons '* multiplicanda))))

(test '(+ (* x y) (* y (+ x 3))) (deriv '(* x y (+ x 3)) 'x))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-58" class="outline-3">
<h3 id="sec-2-58"><span class="section-number-3">2.58</span> <span class="done DONE">DONE</span> 2.58</h3>
<div class="outline-text-3" id="text-2-58">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">addend</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">augend</span> caddr)
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum?</span> x) (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (eq? (cadr x) '+)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplier</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplicand</span> caddr)
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product?</span> x) (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (eq? (cadr x) '*)))

(test 4 (deriv '(x + (3 * (x + (y + 2)))) 'x))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-or-symbol</span> x)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (null? (cdr x)))
      (car x)
      x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">addend</span> x)
  (list-or-symbol (take-while (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (not (eq? x '+))) x)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">augend</span> x)
  (list-or-symbol (cdr (drop-while (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (not (eq? x '+))) x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sum?</span> x) (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (<span style="color: #00ffff; font-weight: bold;">and</span> (memq '+ x) #t)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplier</span> car)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">multiplicand</span> x)
  (list-or-symbol (cddr x)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">product?</span> x) (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? x) (eq? (cadr x) '*)))

(test 4 (deriv '(x + 3 * (x + y + 2)) 'x))

(test 5 (deriv '(x * 3 + x * 2 + y * 3) 'x))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-59" class="outline-3">
<h3 id="sec-2-59"><span class="section-number-3">2.59</span> <span class="done DONE">DONE</span> 2.59</h3>
<div class="outline-text-3" id="text-2-59">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">union-set</span> set1 set2)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? set1)
      set2
      (<span style="color: #00ffff; font-weight: bold;">if</span> (element-of-set? (car set1) set2)
          (union-set (cdr set1) set2)
          (union-set (cdr set1) (cons (car set1) set2)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((set1 '(1 2 3))
      (set2 '(3 4 5)))
  (test '(2 1 3 4 5) (union-set set1 set2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-60" class="outline-3">
<h3 id="sec-2-60"><span class="section-number-3">2.60</span> <span class="done DONE">DONE</span> 2.60</h3>
<div class="outline-text-3" id="text-2-60">
<p>
<code>element-of-set?</code> is still \(\Theta(n)\), <code>adjoin-set</code> went from
\(\Theta(n)\) to \(\Theta(1)\), <code>union-set</code> is went from \(\Theta(n^2)\)
to \(\Theta(n)\) (the complexity of <code>append</code>) and <code>intersection-set</code>
is still \(\Theta(n^2)\); where \(n\) in the repeated case is some
constant factor larger than \(n\) in the unique case.
</p>

<p>
It might be useful where you need cheap writes.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">set</span> '(2 3 2 1 3 2 2))

(test-assert (element-of-set? 1 set))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">adjoin-set</span> cons)

(test '(4 2 3 2 1 3 2 2)
      (adjoin-set 4 set))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">union-set</span> append)

(test '(2 3 2 1 3 2 2 2 3 2 1 3 2 2)
      (union-set set set))

(test '(3 2 2) (intersection-set '(3 2 2) set))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-61" class="outline-3">
<h3 id="sec-2-61"><span class="section-number-3">2.61</span> <span class="done DONE">DONE</span> 2.61</h3>
<div class="outline-text-3" id="text-2-61">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">element-of-set?</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set) #f)
        ((= x (car set)) #t)
        ((&lt; x (car set)) #f)
        (<span style="color: #00ffff; font-weight: bold;">else</span> (element-of-set? x (cdr set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">intersection-set</span> set1 set2)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (null? set1) (null? set2))
      '()
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((x1 (car set1)) (x2 (car set2)))
        (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= x1 x2)
               (cons x1 (intersection-set (cdr set1) (cdr set2))))
              ((&lt; x1 x2)
               (intersection-set (cdr set1) set2))
              ((&lt; x2 x1)
               (intersection-set set1 (cdr set2)))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)
(include <span style="color: #00ff00;">"ordered-sets.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-set</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? set)
      (list x)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((first (car set)))
        (<span style="color: #00ffff; font-weight: bold;">if</span> (&lt; first x)
            (cons first (adjoin-set x (cdr set)))
            (cons x set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">set</span> '(1 3 6 10))

(test '(1 3 5 6 10) (adjoin-set 5 '(1 3 6 10)))
(test '(5) (adjoin-set 5 '()))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-62" class="outline-3">
<h3 id="sec-2-62"><span class="section-number-3">2.62</span> <span class="done DONE">DONE</span> 2.62</h3>
<div class="outline-text-3" id="text-2-62">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">union-set</span> set1 set2)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set1) set2)
        ((null? set2) set1)
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((x1 (car set1)) (x2 (car set2)))
           (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= x1 x2)
                  (cons x1 (union-set (cdr set1) (cdr set2))))
                 ((&lt; x1 x2)
                  (cons x1 (union-set (cdr set1) set2)))
                 (<span style="color: #00ffff; font-weight: bold;">else</span>
                  (cons x2 (union-set set1 (cdr set2)))))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"union-set.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">set1</span> '(1 3 6 10))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">set2</span> '(0 2 3 7 12))

(test '(0 1 2 3 6 7 10 12) (union-set set1 set2))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-63" class="outline-3">
<h3 id="sec-2-63"><span class="section-number-3">2.63</span> <span class="done DONE">DONE</span> 2.63</h3>
<div class="outline-text-3" id="text-2-63">
<p>
The two procedures should return the same result for every tree,
since they’re both doing a topological sort over the entries.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">entry</span> tree) (car tree))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">left-branch</span> tree) (cadr tree))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">right-branch</span> tree) (caddr tree))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-tree</span> entry left right)
  (list entry left right))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">element-of-set?</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set) #f)
        ((= x (entry set)) #t)
        ((&lt; x (entry set))
         (element-of-set? x (left-branch set)))
        ((&gt; x (entry set))
         (element-of-set? x (right-branch set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-set</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set) (make-tree x '() '()))
        ((= x (entry set)) set)
        ((&lt; x (entry set))
         (make-tree (entry set)
                    (adjoin-set x (left-branch set))
                    (right-branch set)))
        ((&gt; x (entry set))
         (make-tree (entry set) (left-branch set)
                    (adjoin-set x (right-branch set))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tree-&gt;list-1</span> tree)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? tree)
      '()
      (append (tree-&gt;list-1 (left-branch tree))
              (cons (entry tree)
                    (tree-&gt;list-1
                     (right-branch tree))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tree-&gt;list-2</span> tree)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">copy-to-list</span> tree result-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? tree)
        result-list
        (copy-to-list (left-branch tree)
                      (cons (entry tree)
                            (copy-to-list
                             (right-branch tree)
                             result-list)))))
  (copy-to-list tree '()))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-&gt;tree</span> elements)
  (car (partial-tree elements (length elements))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">partial-tree</span> elts n)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0)
      (cons '() elts)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((left-size (quotient (- n 1) 2)))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((left-result
               (partial-tree elts left-size)))
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((left-tree (car left-result))
                (non-left-elts (cdr left-result))
                (right-size (- n (+ left-size 1))))
            (<span style="color: #00ffff; font-weight: bold;">let</span> ((this-entry (car non-left-elts))
                  (right-result
                   (partial-tree
                    (cdr non-left-elts)
                    right-size)))
              (<span style="color: #00ffff; font-weight: bold;">let</span> ((right-tree (car right-result))
                    (remaining-elts
                     (cdr right-result)))
                (cons (make-tree this-entry
                                 left-tree
                                 right-tree)
                      remaining-elts))))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)
(include <span style="color: #00ff00;">"tree-sets.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree-1</span>
  '(7 (3 (1 () ()) (5 () ())) (9 () (11 () ()))))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree-2</span>
  '(3 (1 () ()) (7 (5 () ()) (9 () (11 () ())))))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree-3</span>
  '(5 (3 (1 () ()) ()) (9 (7 () ()) (11 () ()))))

(test-assert (equal? (tree-&gt;list-1 tree-1)
                     (tree-&gt;list-2 tree-1)))

(test-assert (equal? (tree-&gt;list-1 tree-2)
                     (tree-&gt;list-2 tree-2)))

(test-assert (equal? (tree-&gt;list-1 tree-3)
                     (tree-&gt;list-2 tree-3)))
</pre>
</div>

<p>
<code>tree-&gt;list-1</code> has an additional <code>append</code> at every level of the
tree, whereas <code>tree-&gt;list-2</code> gets away with <code>cons</code> only;
<code>tree-&gt;list-2</code> should grow more slowly, therefore, since <code>append</code> is
a \(\Theta(n)\) operation and <code>cons</code> is \(\Theta(1)\).
</p>
</div>
</div>
<div id="outline-container-sec-2-64" class="outline-3">
<h3 id="sec-2-64"><span class="section-number-3">2.64</span> <span class="done DONE">DONE</span> 2.64</h3>
<div class="outline-text-3" id="text-2-64">
<div class="org-src-container">

<pre class="src src-scheme">(use test)
(include <span style="color: #00ff00;">"tree-sets.scm"</span>)

(test '(5 (1 () (3 () ())) (9 (7 () ()) (11 () ())))
      (list-&gt;tree '(1 3 5 7 9 11)))
</pre>
</div>

<p>
In the \(n = 0\) case, we’re at a leaf; return an empty list,
signifying no children.
</p>

<p>
Otherwise, the size of the left-tree (\(leftsize\)) will be half of
the list minus the middle element, which will act as the root;
create the left-tree from the first \(leftsize\) elements. The size of
the right-tree (\(rightsize\)) is the left-over elements minus the
root (i.e. the first non-left entry); create the right-tree from the
last \(rightsize\) elements
</p>

<p>
It recursively partitions the tree into a pivot (the
\(\frac{n}{2}^{nd}\) element or so-called “entry”), the left elements
less than the pivot (belonging to the left subtree) and the right
elements greater than the pivot (belonging to the right subtree); it
works from the left side of the list and the bottom of the tree,
composing leaves and smaller subtrees into larger ones and
eventually consuming the entire list.
</p>

<p>
The order of growth is \(\Theta(n)\), since the list is already
sorted; \(\Theta(n log(n))\) if this were not the case.
</p>
</div>
<div id="outline-container-sec-2-64-1" class="outline-4">
<h4 id="sec-2-64-1"><span class="section-number-4">2.64.1</span> <span class="todo TODO">TODO</span> Some sort of power-law with nodes vs. invocations of partial-tree.</h4>
</div>
</div>
<div id="outline-container-sec-2-65" class="outline-3">
<h3 id="sec-2-65"><span class="section-number-3">2.65</span> <span class="done DONE">DONE</span> 2.65</h3>
<div class="outline-text-3" id="text-2-65">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"ordered-sets.scm"</span>)
(include <span style="color: #00ff00;">"union-set.scm"</span>)
(include <span style="color: #00ff00;">"tree-sets.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tree-union-set</span> tree1 tree2)
  (list-&gt;tree (union-set (tree-&gt;list-2 tree1)
                         (tree-&gt;list-2 tree2))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tree-intersection-set</span> tree1 tree2)
  (list-&gt;tree (intersection-set (tree-&gt;list-2 tree1)
                                (tree-&gt;list-2 tree2))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree1</span> (list-&gt;tree '(1 3 6 10)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree2</span> (list-&gt;tree '(0 2 3 7 12)))

(test '(0 1 2 3 6 7 10 12)
      (tree-&gt;list-2 (tree-union-set tree1 tree2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-66" class="outline-3">
<h3 id="sec-2-66"><span class="section-number-3">2.66</span> <span class="done DONE">DONE</span> 2.66</h3>
<div class="outline-text-3" id="text-2-66">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)
(include <span style="color: #00ff00;">"tree-sets.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tree</span> (list-&gt;tree '(1 3 6 10)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">lookup</span> key tree)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? tree)
      #f
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((entry (entry tree)))
        (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= key entry) #t)
              ((&lt; key entry) (lookup key (left-branch tree)))
              (<span style="color: #00ffff; font-weight: bold;">else</span> (lookup key (right-branch tree)))))))

(test-assert (not (lookup 2 tree)))
(test-assert (lookup 1 tree))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-67" class="outline-3">
<h3 id="sec-2-67"><span class="section-number-3">2.67</span> <span class="done DONE">DONE</span> 2.67</h3>
<div class="outline-text-3" id="text-2-67">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sample-tree</span>
  (make-code-tree (make-leaf 'A 4)
                  (make-code-tree
                   (make-leaf 'B 2)
                   (make-code-tree
                    (make-leaf 'D 1)
                    (make-leaf 'C 1)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sample-message</span> '(0 1 1 0 0 1 0 1 0 1 1 1 0))

(test '(A D A B B C A) (decode sample-message sample-tree))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-68" class="outline-3">
<h3 id="sec-2-68"><span class="section-number-3">2.68</span> <span class="done DONE">DONE</span> 2.68</h3>
<div class="outline-text-3" id="text-2-68">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">encode-symbol</span> symbol tree)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (leaf? tree)
      '()
      (<span style="color: #00ffff; font-weight: bold;">cond</span> ((memq symbol (symbols (left-branch tree)))
             (cons 0 (encode-symbol symbol (left-branch tree))))
            ((memq symbol (symbols (right-branch tree)))
             (cons 1 (encode-symbol symbol (right-branch tree))))
            (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Symbol not in tree -- ENCODE-SYMBOL"</span> symbol)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sample-tree</span>
  (make-code-tree (make-leaf 'A 4)
                  (make-code-tree
                   (make-leaf 'B 2)
                   (make-code-tree
                    (make-leaf 'D 1)
                    (make-leaf 'C 1)))))

(test '(0 1 1 0 0 1 0 1 0 1 1 1 0)
      (encode '(A D A B B C A) sample-tree))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-69" class="outline-3">
<h3 id="sec-2-69"><span class="section-number-3">2.69</span> <span class="done DONE">DONE</span> 2.69</h3>
<div class="outline-text-3" id="text-2-69">
<p>
Interesting to note that the message from 2.67 is decoded slightly
differently.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp traversal)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-leaf-set</span> tree leaf-set)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? leaf-set)
      (list tree)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((leaf (car leaf-set)))
        (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; (weight tree) (weight leaf))
            (cons leaf (adjoin-tree tree (cdr leaf-set)))
            (cons tree leaf-set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">successive-merge</span> leaf-set)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (= 1 (length leaf-set))
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">What if it's a single leaf?</span>
      (<span style="color: #00ffff; font-weight: bold;">if</span> (leaf? leaf-set)
          leaf-set
          (car leaf-set))
      (successive-merge (adjoin-leaf-set (make-code-tree (cadr leaf-set)
                                                         (car leaf-set))
                                         (cddr leaf-set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">generate-huffman-tree</span> pairs)
  (successive-merge (make-leaf-set pairs)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"huffman.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sample-message</span> '(0 1 1 0 0 1 0 1 0 1 1 1 0))

(test
 '(A C A B B D A)
 (decode sample-message
         (generate-huffman-tree '((A 4) (B 2) (C 1) (D 1)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-70" class="outline-3">
<h3 id="sec-2-70"><span class="section-number-3">2.70</span> <span class="done DONE">DONE</span> 2.70</h3>
<div class="outline-text-3" id="text-2-70">
<p>
84 bits are required for the encoding; if we had used a fixed-length
encoding, \(36\ \text{symbols} \times \log_28\
  \frac{\text{bits}}{\text{symbol}} = 108\ \text{bits}\) would have
been required.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"huffman.scm"</span>)

(test
 '(1 1 1 1 1 1 1 1 1 0 1 1 0 0 1 1 1
     0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1
     1 1 0 1 1 0 0 1 1 1 0 0 0 0 0 0
     0 0 0 1 1 0 1 0 1 0 1 0 1 0 1 0
     1 0 1 0 1 0 1 0 1 0 1 1 1 0 1 1
     0 1 1)
 (encode
 '(get a job
       sha na na na na na na na na
       get a job
       sha na na na na na na na na
       wah yip yip yip yip yip yip yip yip yip
       sha boom)
 (generate-huffman-tree '((wah 1)
                          (boom 1)
                          (a 2)
                          (get 2)
                          (job 2)
                          (sha 3)
                          (na 16)
                          (yip 9)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-71" class="outline-3">
<h3 id="sec-2-71"><span class="section-number-3">2.71</span> <span class="done DONE">DONE</span> 2.71</h3>
<div class="outline-text-3" id="text-2-71">
<p>
Here is the tree for \(n = 5\):
</p>


<div class="figure">
<p><img src="2.71.png" alt="2.71.png" />
</p>
</div>

<p>
In general, 1 bit is required to encode the most frequent symbol;
\(n - 1\) bits, the least frequent.
</p>
</div>
</div>
<div id="outline-container-sec-2-72" class="outline-3">
<h3 id="sec-2-72"><span class="section-number-3">2.72</span> <span class="done DONE">DONE</span> 2.72</h3>
<div class="outline-text-3" id="text-2-72">
<p>
Assuming a linear <code>memq</code>, <code>encode-symbol</code> takes, in the special case
where the relative frequencies of symbols are \(1, 2, \dots,
  2^{n-1}\), \(O(n)\) for the most frequent symbol and \(O(n^2)\) for the
least frequent.
</p>

<p>
For pathological (nearly linear) trees, the order of growth is
\(O(n^2)\); for balanced trees, \(O(n \log n)\).
</p>

<p>
Using a constant-time lookup for symbol membership instead of
<code>memq</code>, the order of growth would be \(O(n)\) and \((\log n)\).
</p>
</div>
</div>
<div id="outline-container-sec-2-73" class="outline-3">
<h3 id="sec-2-73"><span class="section-number-3">2.73</span> <span class="done DONE">DONE</span> 2.73</h3>
<div class="outline-text-3" id="text-2-73">
<p>
<code>number?</code> and <code>variable?</code> can’t be assimilated because they operate
on primitive (i.e. non-type-tagged objects); on the other hand,
<code>type-tag</code> and <code>contents</code> could be generalized to support them.
</p>

<p>
In order to accomodate a reversal of the indexing for procedures,
we’d have to reverse the corresponding <code>put</code> statements during
installation.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-69 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv</span> exp var)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? exp) 0)
        ((variable? exp) (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? exp var) 1 0))
        (<span style="color: #00ffff; font-weight: bold;">else</span> ((get 'deriv (operator exp))
               (operands exp) var))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operator</span> exp) (car exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operands</span> exp) (cdr exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dispatch-table</span> (make-parameter (make-hash-table)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">put</span> op type proc)
  (hash-table-set! (dispatch-table) (cons op type) proc))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get</span> op type)
  (hash-table-ref/default (dispatch-table) (cons op type) #f))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-sum-and-product-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">addend</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">augend</span> cadr)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv-sum</span> exp var)
    (make-sum (deriv (addend exp) var)
              (deriv (augend exp) var)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplicand</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplier</span> cadr)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv-product</span> exp var)
    (make-sum
     (make-product (multiplier exp)
                   (deriv (multiplicand exp) var))
     (make-product (deriv (multiplier exp) var)
                   (multiplicand exp))))

  (put 'deriv '+ deriv-sum)
  (put 'deriv '* deriv-product)
  'done)

(install-sum-and-product-package)

(test 'y (deriv '(* x y) 'x))
(test 1 (deriv '(+ x y) 'x))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-exponent-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">base</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">exponent</span> cadr)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-exponentiation</span> b e)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((=number? e 0) 1)
          ((=number? e 1) b)
          ((<span style="color: #00ffff; font-weight: bold;">and</span> (number? b) (number? e))
           (expt b e))
          (<span style="color: #00ffff; font-weight: bold;">else</span> (list '** b e))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-diff</span> a1 a2)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((=number? a1 0) a2)
          ((=number? a2 0) a1)
          ((<span style="color: #00ffff; font-weight: bold;">and</span> (number? a1) (number? a2))
           (- a1 a2))
          (<span style="color: #00ffff; font-weight: bold;">else</span> (list '- a1 a2))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deriv-exponent</span> exp var)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((base (base exp))
          (exponent (exponent exp)))
      (make-product exponent
                    (make-product
                     (make-exponentiation base (make-diff exponent 1))
                     (deriv base var)))))

  (put 'deriv '** deriv-exponent)
  'done)

(install-exponent-package)

(test '(* y (** x (- y 1))) (deriv '(** x y) 'x))
(test '(* 2 x) (deriv '(** x 2) 'x))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-74" class="outline-3">
<h3 id="sec-2-74"><span class="section-number-3">2.74</span> <span class="done DONE">DONE</span> 2.74</h3>
<div class="outline-text-3" id="text-2-74">
<p>
Some sort of type information supplied as e.g. a file-extension or
header should be provided to describe the file being read; this type
is passed to functions for reading and parsing records so that
<code>get-record</code> can be generically defined. (See, for instance,
<a href="./division-a-1.data">./division-a-1.data</a> and <a href="./division-b-1.data">./division-b-1.data</a>.)
</p>

<p>
The record itself should have a tag so that <code>get-salary</code> can be
generically defined.
</p>

<p>
When Insatiable takes over a new company, record- and field-parsers
corresponding to their file-format will have to be installed in the
dispatch table.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use alist-lib extras medea sicp srfi-61 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-division-a-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">get-person</span> (cut alist-ref &lt;&gt; 'person))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">get-salary</span> (cut alist-ref &lt;&gt; 'salary))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">read-record</span> file)
    (attach-tag 'division-a-record (read file)))
  (put 'get-person '(division-a-record) get-person)
  (put 'get-salary '(division-a-record) get-salary)
  (put 'read-record '(division-a-file) read-record)
  (put 'eof? '(division-a-record) eof-object?)
  (put 'close '(division-a-file) close-input-port))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-division-b-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-person</span> record)
    (string-&gt;symbol (alist-ref record 'name)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">get-salary</span> (cute alist-ref &lt;&gt; 'income))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">read-record</span> file)
    (attach-tag 'division-b-record
                (<span style="color: #00ffff; font-weight: bold;">let</span> ((object (read-line file)))
                  (<span style="color: #00ffff; font-weight: bold;">if</span> (eof-object? object)
                      object
                      (read-json object)))))
  (put 'get-person '(division-b-record) get-person)
  (put 'get-salary '(division-b-record) get-salary)
  (put 'read-record '(division-b-file) read-record)
  (put 'eof? '(division-b-record) eof-object?)
  (put 'close '(division-b-file) close-input-port))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">file-tag</span> file)
  (string-&gt;symbol (read-line file)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-file</span> file)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((file (open-input-file file)))
    (attach-tag (file-tag file) file)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">read-record</span> file)
  (apply-generic 'read-record file))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-person</span> record)
  (apply-generic 'get-person record))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eof?</span> record)
  (apply-generic 'eof? record))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">close</span> file)
  (apply-generic 'close file))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-record</span> person file)
  (dynamic-wind
      void
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((record (read-record file)))
              (<span style="color: #00ffff; font-weight: bold;">if</span> (eof? record)
                  #f
                  (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? person (get-person record))
                      record
                      (iter (read-record file))))))
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (close file))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-person</span> name)
  (attach-tag 'person name))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-salary</span> record)
  (apply-generic 'get-salary record))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-salary</span> record)
  (apply-generic 'get-salary record))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">find-employee-record</span> person files)
  (append-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (file)
                (<span style="color: #00ffff; font-weight: bold;">let</span> ((record (get-record person (make-file file))))
                  (<span style="color: #00ffff; font-weight: bold;">if</span> record
                      (list record)
                      '())))
              files))

(install-division-a-package)
(install-division-b-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((jake (get-record 'jake (make-file <span style="color: #00ff00;">"division-a-1.data"</span>)))
      (mary (get-record 'mary (make-file <span style="color: #00ff00;">"division-b-1.data"</span>))))
  (test <span style="color: #00ff00;">"(get-record 'jake (make-file \"division-a-1.data\"))"</span>
        jake
        '(division-a-record (person . jake) (salary . 110000)))
  (test <span style="color: #00ff00;">"(get-record 'mary (make-file \"division-b-1.data\"))"</span>
        mary
        '(division-b-record (name . <span style="color: #00ff00;">"mary"</span>) (income . 110000)))
  (test 110000 (get-salary jake))
  (test 110000 (get-salary mary)))

(test '((division-b-record (name . <span style="color: #00ff00;">"barbara"</span>) (income . 60000)))
      (find-employee-record 'barbara '(<span style="color: #00ff00;">"division-b-1.data"</span>
                                       <span style="color: #00ff00;">"division-b-2.data"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-75" class="outline-3">
<h3 id="sec-2-75"><span class="section-number-3">2.75</span> <span class="done DONE">DONE</span> 2.75</h3>
<div class="outline-text-3" id="text-2-75">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-mag-ang</span> r a)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (op)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((eq? op 'real-part) (* r (cos a)))
          ((eq? op 'imag-part) (* r (sin a)))
          ((eq? op 'magnitude) r)
          ((eq? op 'angle) a)
          (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown op: MAKE-FROM-MAG-ANG"</span> op)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((magnitude (sqrt 2))
      (angle (atan 1)))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((number (make-from-mag-ang magnitude angle)))
    (test 1.0 (number 'real-part))
    (test 1.0 (number 'imag-part))
    (test magnitude (number 'magnitude))
    (test angle (number 'angle))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-76" class="outline-3">
<h3 id="sec-2-76"><span class="section-number-3">2.76</span> <span class="done DONE">DONE</span> 2.76</h3>
<div class="outline-text-3" id="text-2-76">
<p>
Explicit dispatch isn’t appropriate for large systems in which
either new types or new operations must be added, since explicit
dispatch doesn’t exhibit additivity: the generic dispatch procedure
must be modified every time there is a new type or operation.
</p>

<p>
If new types are often added (and one doesn’t mind having a sparse
operation-and-type table), message passing is superior: adding a
type is merely the addition of a column; and if new procedures are
often added, data-directed is superior: adding an operation is
merely the addition of a row.
</p>
</div>
</div>
<div id="outline-container-sec-2-77" class="outline-3">
<h3 id="sec-2-77"><span class="section-number-3">2.77</span> <span class="done DONE">DONE</span> 2.77</h3>
<div class="outline-text-3" id="text-2-77">
<p>
<code>Apply-generic</code> is invoked twice.
</p>

<p>
First, the top-level procedure <code>magnitude</code> is applied to <code>z</code> which,
after substitution, looks like:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(magnitude (complex rectangular 3 4))
</pre>
</div>

<p>
which in turn calls <code>apply-generic</code>:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(apply-generic 'magnitude (complex rectangular 3 4))
</pre>
</div>

<p>
<code>Apply-generic</code> applies <code>magnitude</code> from the complex package with
the contents of <code>z</code>, stripping off the <code>complex</code> tag; <code>magnitude</code>
from the complex package defers, however, to top-level <code>magnitude</code>:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(magnitude (rectangular 3 4))
</pre>
</div>

<p>
which invokes <code>apply-generic</code> a second time:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(apply-generic 'magnitude (rectangular 3 4))
</pre>
</div>

<p>
<code>Apply-generic</code> then applies <code>magnitude</code> from the rectangular
package:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(sqrt (+ (square (real-part (rectangular 3 4))
                 (imag-part (rectangular 3 4)))))
</pre>
</div>

<p>
which becomes:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(sqrt (+ (square 3) (square 4)))
</pre>
</div>

<p>
and finally:
</p>

<div class="org-src-container">

<pre class="src src-scheme">5.0
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-complex-selectors-package</span>)
  (put 'real-part '(complex) real-part)
  (put 'imag-part '(complex) imag-part)
  (put 'magnitude '(complex) magnitude)
  (put 'angle '(complex) angle)
  'done)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-complex-selectors-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((z (make-complex-from-mag-ang 3 4)))
  (test 3 (magnitude z)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-78" class="outline-3">
<h3 id="sec-2-78"><span class="section-number-3">2.78</span> <span class="done DONE">DONE</span> 2.78</h3>
<div class="outline-text-3" id="text-2-78">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">attach-tag</span> type-tag contents)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? type-tag 'scheme-number)
      contents
      (cons type-tag contents)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">type-tag</span> datum)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? datum) 'scheme-number)
        ((pair? datum) (car datum))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Bad tagged datum: TYPE-TAG"</span> datum))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">contents</span> datum)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? datum) datum)
        ((pair? datum) (cdr datum))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Bad tagged datum: CONTENTS"</span> datum))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((n (make-scheme-number 1)))
  (test 1 n)
  (test 2 (add n n)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-79" class="outline-3">
<h3 id="sec-2-79"><span class="section-number-3">2.79</span> <span class="done DONE">DONE</span> 2.79</h3>
<div class="outline-text-3" id="text-2-79">
<p>
This took a little more code than I would have liked; opted for an
orthogonal package that tests equality across all permutations of
scheme-number, rational, complex.
</p>

<p>
This is not an additive strategy: the equality package has to be
modified every time we add a type; the alternative of embedding the
equality procedures in the scheme-number, rational, complex packages
would have violated module-boundaries.
</p>

<p>
It also involves writing ad-hoc promotion and demotion procedures up
and down the number ladder.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scheme-number-&gt;rational</span> scheme-number)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((number (contents scheme-number)))
    (make-rational (numerator number)
                   (denominator number))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rational-&gt;complex</span> rational)
  (make-complex-from-real-imag
   (/ (numer rational) (denom rational))
   0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag-scheme-number</span> scheme-number)
  (attach-tag 'scheme-number scheme-number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag-rational</span> rational)
  (attach-tag 'rational rational))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag-complex</span> complex)
  (attach-tag 'complex complex))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Let's modify the rational package so that it exports numer and</span>
<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">denom.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rational-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">numer</span> x) (car x))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">denom</span> x) (cdr x))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-rat</span> n d)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((g (gcd n d)))
      (cons (/ n g) (/ d g))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-rat</span> x y)
    (make-rat (+ (* (numer x) (denom y))
                 (* (numer y) (denom x)))
              (* (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-rat</span> x y)
    (make-rat (- (* (numer x) (denom y))
                 (* (numer y) (denom x)))
              (* (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-rat</span> x y)
    (make-rat (* (numer x) (numer y))
              (* (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-rat</span> x y)
    (make-rat (* (numer x) (denom y))
              (* (denom x) (numer y))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tag</span> tag-rational)
  (put 'add '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (add-rat x y))))
  (put 'sub '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (sub-rat x y))))
  (put 'mul '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (mul-rat x y))))
  (put 'div '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (div-rat x y))))
  (put 'make 'rational
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n d) (tag (make-rat n d))))
  (put 'numer '(rational) numer)
  (put 'denom '(rational) denom)
  'done)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">numer</span> rational)
  (apply-generic 'numer rational))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">denom</span> rational)
  (apply-generic 'denom rational))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scheme-number-rational-equ?</span> scheme-number rational)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((scheme-number-rational (scheme-number-&gt;rational scheme-number)))
    (<span style="color: #00ffff; font-weight: bold;">and</span> (= (numer scheme-number-rational) (numer rational))
         (= (denom scheme-number-rational) (denom rational)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rational-complex-equ?</span> rational complex)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((rational-complex (rational-&gt;complex rational)))
    (<span style="color: #00ffff; font-weight: bold;">and</span> (= (magnitude rational-complex) (magnitude complex))
         (= (angle rational-complex) (angle complex)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-equality-package</span>)
  (install-scheme-number-package)
  (install-rational-package)
  (install-complex-package)
  (put 'equ? '(scheme-number scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (= x y)))
  (put 'equ? '(scheme-number rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((scheme-number (tag-scheme-number x))
               (rational (tag-rational y)))
           (scheme-number-rational-equ? scheme-number rational))))
  (put 'equ? '(scheme-number complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((scheme-number (tag-scheme-number x))
               (complex (tag-complex y)))
           (rational-complex-equ?
            (scheme-number-&gt;rational scheme-number)
            complex))))

  (put 'equ? '(rational scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((rational (tag-rational x))
               (scheme-number (tag-rational y)))
           (scheme-number-rational-equ? scheme-number rational))))
  (put 'equ? '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((rational-x (tag-rational x))
               (rational-y (tag-rational y)))
           (<span style="color: #00ffff; font-weight: bold;">and</span> (= (numer rational-x)
                   (numer rational-y))
                (= (denom rational-x)
                   (denom rational-y))))))
  (put 'equ? '(rational complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((rational (attach-tag 'rational x))
               (complex (attach-tag 'complex y)))
           (rational-complex-equ? rational complex))))

  (put 'equ? '(complex scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((complex (tag-complex x))
               (scheme-number (tag-complex y)))
           (rational-complex-equ?
            (scheme-number-&gt;rational scheme-number)
            complex))))
  (put 'equ? '(complex rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((complex (tag-complex x))
               (rational (tag-rational y)))
           (rational-complex-equ? rational complex))))
  (put 'equ? '(complex complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((complex-x (tag-complex x))
               (complex-y (tag-complex y)))
           (<span style="color: #00ffff; font-weight: bold;">and</span> (= (magnitude complex-x)
                   (magnitude complex-y))
                (= (angle complex-y)
                   (angle complex-y)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equ?</span> x y)
  (apply-generic 'equ? x y))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"number-equality.scm"</span>)

(install-equality-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((scheme-number (make-scheme-number 0.5))
      (rational (make-rational 2 4))
      (complex (make-complex-from-real-imag 0.5 0)))
  (test-assert (equ? scheme-number scheme-number))
  (test-assert (equ? scheme-number rational))
  (test-assert (equ? scheme-number complex))

  (test-assert (equ? rational scheme-number))
  (test-assert (equ? rational rational))
  (test-assert (equ? rational complex))

  (test-assert (equ? complex scheme-number))
  (test-assert (equ? complex rational))
  (test-assert (equ? complex complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-80" class="outline-3">
<h3 id="sec-2-80"><span class="section-number-3">2.80</span> <span class="done DONE">DONE</span> 2.80</h3>
<div class="outline-text-3" id="text-2-80">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"number-equality.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-zero-package</span>)
  (install-equality-package)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">zero</span> (make-scheme-number 0))
  (put '=zero? '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
         (equ? (tag-scheme-number x) zero)))
  (put '=zero? '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
         (equ? (tag-rational x) zero)))
  (put '=zero? '(complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
         (equ? (tag-complex x) zero))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">=zero?</span> x)
  (apply-generic '=zero? x))

(install-zero-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((scheme-number (make-scheme-number 0))
      (rational (make-rational 0 1))
      (complex (make-complex-from-real-imag 0 0)))
  (test-assert (=zero? scheme-number))
  (test-assert (=zero? rational))
  (test-assert (=zero? complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-81" class="outline-3">
<h3 id="sec-2-81"><span class="section-number-3">2.81</span> <span class="done DONE">DONE</span> 2.81</h3>
<div class="outline-text-3" id="text-2-81">
<p>
With a <code>complex-&gt;complex</code> coercion in place, there will be an
infinite loop as it repeatedly coerces complex to itself and retries
the generic operation.
</p>

<p>
<code>apply-generic</code> works correctly as is, even if self-coercion wastes
some time.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-69 test)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">coercion-table</span> (make-parameter (make-hash-table)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">put-coercion</span> op type proc)
  (hash-table-set! (coercion-table) (cons op type) proc))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-coercion</span> op type)
  (hash-table-ref/default (coercion-table) (cons op type) #f))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply-generic</span> op . args)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((type-tags (<span style="color: #00ffff; font-weight: bold;">map</span> type-tag args)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((proc (get op type-tags)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> proc
          (apply proc (<span style="color: #00ffff; font-weight: bold;">map</span> contents args))
          (<span style="color: #00ffff; font-weight: bold;">if</span> (= (length args) 2)
              (<span style="color: #00ffff; font-weight: bold;">let</span> ((type1 (car type-tags))
                    (type2 (cadr type-tags))
                    (a1 (car args))
                    (a2 (cadr args)))
                <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Don't bother coercing to self.</span>
                (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? type1 type2)
                    (error <span style="color: #00ff00;">"No method for these types"</span>
                           (list op type-tags))
                    (<span style="color: #00ffff; font-weight: bold;">let</span> ((t1-&gt;t2 (get-coercion type1 type2))
                          (t2-&gt;t1 (get-coercion type2 type1)))
                      (<span style="color: #00ffff; font-weight: bold;">cond</span> (t1-&gt;t2
                             (apply-generic op (t1-&gt;t2 a1) a2))
                            (t2-&gt;t1
                             (apply-generic op a1 (t2-&gt;t1 a2)))
                            (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"No method for these types"</span>
                                         (list op type-tags)))))))
              (error <span style="color: #00ff00;">"No method for these types"</span>
                     (list op type-tags)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scheme-number-&gt;complex</span> n)
  (make-complex-from-real-imag (contents n) 0))

(put-coercion 'scheme-number
              'complex
              scheme-number-&gt;complex)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scheme-number-&gt;scheme-number</span> n) n)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">complex-&gt;complex</span> z) z)

(put-coercion 'scheme-number
              'scheme-number
              scheme-number-&gt;scheme-number)

(put-coercion 'complex
              'complex
              complex-&gt;complex)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">exp</span> x y)
  (apply-generic 'exp x y))

(put 'exp '(scheme-number scheme-number)
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
       (attach-tag 'scheme-number (expt x y))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((complex (make-complex-from-real-imag 2 0))
      (scheme-number (make-scheme-number 2)))
  (test '(scheme-number . 4) (exp scheme-number scheme-number))
  (test-error (exp complex complex))
  (test-error (exp scheme-number complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-82" class="outline-3">
<h3 id="sec-2-82"><span class="section-number-3">2.82</span> <span class="done DONE">DONE</span> 2.82</h3>
<div class="outline-text-3" id="text-2-82">
<p>
If we had a vector arithmetic package, for instance, and wanted to
scale a vector by a scheme-number (but had only defined scale for
rationals and vectors); this generalized coercion would not work.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-69 test)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">coercion-table</span> (make-parameter (make-hash-table)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">put-coercion</span> op type proc)
  (hash-table-set! (coercion-table) (cons op type) proc))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-coercion</span> op type)
  (hash-table-ref/default (coercion-table) (cons op type) #f))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply-generic</span> op . args)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((type-tags (<span style="color: #00ffff; font-weight: bold;">map</span> type-tag args)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((proc (get op type-tags)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> proc
          (apply proc (<span style="color: #00ffff; font-weight: bold;">map</span> contents args))
          (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((candidate-types type-tags))
            (<span style="color: #00ffff; font-weight: bold;">if</span> (null? candidate-types)
                (error <span style="color: #00ff00;">"No method for these types"</span>
                       (list op type-tags))
                (<span style="color: #00ffff; font-weight: bold;">let*</span> ((candidate-type (car candidate-types))
                       (coercions (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (type)
                                         <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Need to distinguish</span>
                                         <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">between no coercion and</span>
                                         <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">self-coercion.</span>
                                         (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? type candidate-type)
                                             identity
                                             (get-coercion type candidate-type)))
                                       type-tags)))
                  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">We should have a coercion for every type,</span>
                  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">excluding self-coercions.</span>
                  (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">and</span> (every identity coercions)
                           (pair? (delete identity coercions)))
                      (<span style="color: #00ffff; font-weight: bold;">let</span> ((args (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (coercion arg) (coercion arg))
                                       coercions args)))
                        (apply apply-generic (cons op args)))
                      (iter (cdr candidate-types))))))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scheme-number-&gt;complex</span> n)
  (make-complex-from-real-imag (contents n) 0))

(put-coercion 'scheme-number
              'complex
              scheme-number-&gt;complex)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">exp</span> x y)
  (apply-generic 'exp x y))

(put 'exp '(scheme-number scheme-number)
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y)
       (attach-tag 'scheme-number (expt x y))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((complex (make-complex-from-real-imag 2 0))
      (scheme-number (make-scheme-number 2)))
  (test '(complex rectangular 4 . 0) (add scheme-number complex))
  (test-error (exp scheme-number complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-83" class="outline-3">
<h3 id="sec-2-83"><span class="section-number-3">2.83</span> <span class="done DONE">DONE</span> 2.83</h3>
<div class="outline-text-3" id="text-2-83">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Packages</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-scheme-number-conversion-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;rational</span> number)
    (make-rational (numerator number)
                   (denominator number)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;complex</span> number)
    (make-complex-from-real-imag number 0))
  (put '-&gt;rational '(scheme-number) -&gt;rational)
  (put '-&gt;complex '(scheme-number) -&gt;complex))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rational-conversion-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">numer</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">denom</span> cdr)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;real</span> rational)
    (make-real (/ (numer rational)
                  (denom rational))))
  (put 'raise '(rational) -&gt;real))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-complex-conversion-package</span>)
  (put 'raise '(complex) (constantly #f)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-integer-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> object)
    (attach-tag 'integer object))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make</span> value)
    (tag (make-scheme-number value)))
  (put 'raise '(integer) -&gt;rational)
  (put 'make 'integer make))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-real-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> object)
    (attach-tag 'real object))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make</span> value)
    (tag (make-scheme-number value)))
  (put 'raise '(real) -&gt;complex)
  (put 'make 'real make))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Constructors</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-integer</span> i)
  ((get 'make 'integer) i))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-real</span> x)
  ((get 'make 'real) x))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Converters</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;rational</span> number)
  (apply-generic '-&gt;rational number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;complex</span> number)
  (apply-generic '-&gt;complex number))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Generic raise</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">raise</span> number)
  (apply-generic 'raise number))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use data-structures sicp test)

(include <span style="color: #00ff00;">"raise.scm"</span>)

(install-scheme-number-package)
(install-scheme-number-conversion-package)
(install-rational-package)
(install-rational-conversion-package)
(install-complex-package)
(install-complex-conversion-package)

(install-integer-package)
(install-real-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((integer (make-integer 1))
      (rational (make-rational 1 1))
      (real (make-real 1))
      (complex (make-complex-from-real-imag 1 0)))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">These tests rely on the fact that we're dealing with lists as a</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">convential interface.</span>
  (test rational (raise integer))
  (test real (raise rational))
  (test complex (raise real))
  (test-assert (not (raise complex))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-84" class="outline-3">
<h3 id="sec-2-84"><span class="section-number-3">2.84</span> <span class="done DONE">DONE</span> 2.84</h3>
<div class="outline-text-3" id="text-2-84">
<p>
For simplicity, we’re only handling the monadic and dyadic case; we
should really abstract this to n-ary.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">supertype-table</span> (make-parameter (make-hash-table)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">put-supertype</span> subtype supertype)
  (hash-table-set! (supertype-table) subtype supertype))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">get-supertype</span> subtype)
  (hash-table-ref/default (supertype-table) subtype #f))

(put-supertype 'integer 'rational)
(put-supertype 'rational 'real)
(put-supertype 'real 'complex)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">supertype?</span> subtype type)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((supertype (get-supertype subtype)))
    (<span style="color: #00ffff; font-weight: bold;">and</span> supertype
         (<span style="color: #00ffff; font-weight: bold;">or</span> (eq? supertype type)
             (iter (get-supertype supertype))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">raise-until-equitable</span> arg type)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? (type-tag arg) type)
      arg
      (raise-until-equitable (raise arg) type)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply-generic</span> op . args)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((type-tags (<span style="color: #00ffff; font-weight: bold;">map</span> type-tag args)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((proc (get op type-tags)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> proc
          (apply proc (<span style="color: #00ffff; font-weight: bold;">map</span> contents args))
          (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= (length args) 1)
                 (<span style="color: #00ffff; font-weight: bold;">let</span> ((superarg (raise (car args))))
                   (<span style="color: #00ffff; font-weight: bold;">if</span> superarg
                       (apply-generic op superarg)
                       (error <span style="color: #00ff00;">"No method for these types"</span>
                              (list op type-tags)))))
                ((= (length args) 2)
                 (<span style="color: #00ffff; font-weight: bold;">let</span> ((type1 (car type-tags))
                       (type2 (cadr type-tags))
                       (a1 (car args))
                       (a2 (cadr args)))
                   (<span style="color: #00ffff; font-weight: bold;">cond</span> ((supertype? type1 type2)
                          (apply-generic op
                                         (raise-until-equitable a1 type2)
                                         a2))
                         ((supertype? type2 type1)
                          (apply-generic op a1 (raise-until-equitable a2
                                                                      type1)))
                         (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"No method for these types"</span>
                                      (list op type-tags))))))
                (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"No method for these types"</span> (list op type-tags))))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use data-structures sicp srfi-69 test)

(include <span style="color: #00ff00;">"raise.scm"</span>)
(include <span style="color: #00ff00;">"apply-generic-raise.scm"</span>)

(install-scheme-number-package)
(install-scheme-number-conversion-package)
(install-rational-package)
(install-rational-conversion-package)
(install-complex-package)
(install-complex-conversion-package)

(install-integer-package)
(install-real-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((rational (make-rational 1 1))
      (complex (make-complex-from-real-imag 1 0)))
  (test '(complex rectangular 2 . 0) (add rational complex))
  (test 0 (imag-part rational)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-85" class="outline-3">
<h3 id="sec-2-85"><span class="section-number-3">2.85</span> <span class="done DONE">DONE</span> 2.85</h3>
<div class="outline-text-3" id="text-2-85">
<p>
We were able to simplify results from apply-generic, but had to
configure a switch to disable dropping on raise.
</p>

<p>
We might have detected that the operation was raise in
<code>apply-generic</code>, but that doesn’t seem additive; let’s add a <code>drop?</code>
parameter.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use data-structures sicp test)

(include <span style="color: #00ff00;">"raise.scm"</span>)
(include <span style="color: #00ff00;">"apply-generic-raise.scm"</span>)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Packages</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-scheme-number-projection-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;rational</span> number)
    (make-rational (numerator number)
                   (denominator number)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equ?</span> x y) (= x y))
  (put '-&gt;rational '(real) -&gt;rational)
  (put 'equ? '(scheme-number scheme-number) equ?))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rational-projection-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">numer</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">denom</span> cdr)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;integer</span> rational)
    (make-integer (/ (numer rational)
                     (denom rational))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equ?</span> n1 n2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (= (numer n1) (numer n2))
         (= (denom n1) (denom n2))))
  (put 'project '(rational) -&gt;integer)
  (put 'equ? '(rational rational) equ?))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-complex-projection-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">-&gt;real</span> complex)
    (make-real (real-part complex)))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Not precise because of errors in conversion?</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equ?</span> c1 c2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (= (real-part c1) (real-part c2))
         (= (imag-part c1) (imag-part c2))))
  (put 'project '(complex) -&gt;real)
  (put 'equ? '(complex complex) equ?))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-integer-projection-package</span>)
  (put 'project '(integer) (constantly #f))
  (put 'equ? '(integer integer) equ?))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-real-projection-package</span>)
  (put 'project '(real) -&gt;rational)
  (put 'equ? '(real real) equ?))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Generic project, equ?; drop</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">project</span> number)
  (apply-generic 'project number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">equ?</span> n1 n2)
  (apply-generic 'equ? n1 n2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">drop</span> number)
  (handle-exceptions exn
    number
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((projection (project number)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> projection
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((promotion (raise projection)))
            (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">and</span> promotion (equ? promotion number))
                (drop projection)
                number))
          number))))

(install-scheme-number-package)
(install-scheme-number-conversion-package)
(install-scheme-number-projection-package)
(install-rational-package)
(install-rational-conversion-package)
(install-rational-projection-package)
(install-complex-package)
(install-complex-conversion-package)
(install-complex-projection-package)

(install-integer-package)
(install-integer-projection-package)
(install-real-package)
(install-real-projection-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((integer (make-integer 1))
      (rational (make-rational 1 1))
      (real (make-real 1))
      (complex (make-complex-from-real-imag 1 0))
      (irreducible-complex (make-complex-from-real-imag 1 2)))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">These tests rely on the fact that we're dealing with lists as a</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">convential interface.</span>
  (test-assert (not (project integer)))
  (test integer (project rational))
  (test rational (project real))
  (test real (project complex))
  (test integer (drop complex))
  (test irreducible-complex (drop irreducible-complex)))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Simplifying apply-generic</span>

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">generic-number?</span> number)
  (<span style="color: #00ffff; font-weight: bold;">and</span> (pair? number)
       (eq? (type-tag number) 'complex)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">drop?</span> (make-parameter #t))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply-generic</span> op . args)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((type-tags (<span style="color: #00ffff; font-weight: bold;">map</span> type-tag args)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((proc (get op type-tags)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> proc
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (apply proc (<span style="color: #00ffff; font-weight: bold;">map</span> contents args))))
            (<span style="color: #00ffff; font-weight: bold;">if</span> (drop?) (drop result) result))
          (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= (length args) 1)
                 (<span style="color: #00ffff; font-weight: bold;">let</span> ((superarg (raise (car args))))
                   (<span style="color: #00ffff; font-weight: bold;">if</span> superarg
                       (apply-generic op superarg)
                       (error <span style="color: #00ff00;">"No method for these types"</span>
                              (list op type-tags)))))
                ((= (length args) 2)
                 (<span style="color: #00ffff; font-weight: bold;">let</span> ((type1 (car type-tags))
                       (type2 (cadr type-tags))
                       (a1 (car args))
                       (a2 (cadr args)))
                   (<span style="color: #00ffff; font-weight: bold;">cond</span> ((supertype? type1 type2)
                          (apply-generic op
                                         (raise-until-equitable a1 type2)
                                         a2))
                         ((supertype? type2 type1)
                          (apply-generic op a1 (raise-until-equitable a2
                                                                      type1)))
                         (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"No method for these types"</span>
                                      (list op type-tags))))))
                (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"No method for these types"</span> (list op type-tags))))))))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Don't drop on raise: it defeats the purpose of raising.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">raise</span> number)
  (parameterize ((drop? #f))
    (apply-generic 'raise number)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((integer (make-integer 2))
      (complex (make-complex-from-real-imag 1 0)))
  (test integer (add complex complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-86" class="outline-3">
<h3 id="sec-2-86"><span class="section-number-3">2.86</span> <span class="done DONE">DONE</span> 2.86</h3>
<div class="outline-text-3" id="text-2-86">
<p>
For every primitive operation in the imaginary package, we have to
replace them with generic ones (including not only <code>cos</code> and <code>sin</code>,
but also <code>sqrt</code>, <code>square</code>, <code>atan</code>, <code>*</code>, <code>+</code>).
</p>

<p>
We could have done this more intelligently using e.g. coercion; we
could have also endeavored to preserve types (i.e. instead of
returning scheme-numbers from trigonometric and other functions,
return e.g. rationals).
</p>

<p>
We could have also installed the trigonometric and other functions
in the e.g. rational-package itself, instead of creating
function-specific packages.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rectangular-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">real-part</span> z) (car z))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">imag-part</span> z) (cdr z))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-real-imag</span> x y) (cons x y))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">magnitude</span> z)
    (square-root (add (square (real-part z))
                      (square (imag-part z)))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">angle</span> z)
    (arctan (imag-part z) (real-part z)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-mag-ang</span> r a)
    (cons (* r (cos a)) (* r (sin a))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to the rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> x) (attach-tag 'rectangular x))
  (put 'real-part '(rectangular) real-part)
  (put 'imag-part '(rectangular) imag-part)
  (put 'magnitude '(rectangular) magnitude)
  (put 'angle '(rectangular) angle)
  (put 'make-from-real-imag 'rectangular
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (make-from-real-imag x y))))
  (put 'make-from-mag-ang 'rectangular
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (r a) (tag (make-from-mag-ang r a))))
  'done)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polar-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">magnitude</span> z) (car z))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">angle</span> z) (cdr z))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-mag-ang</span> r a) (cons r a))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">real-part</span> z) (mul (magnitude z) (cosine (angle z))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">imag-part</span> z) (mul (magnitude z) (sine (angle z))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-real-imag</span> x y)
    (cons (square-root (add (square x) (square y)))
          (atan y x)))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to the rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> x) (attach-tag 'polar x))
  (put 'real-part '(polar) real-part)
  (put 'imag-part '(polar) imag-part)
  (put 'magnitude '(polar) magnitude)
  (put 'angle '(polar) angle)
  (put 'make-from-real-imag 'polar
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (make-from-real-imag x y))))
  (put 'make-from-mag-ang 'polar
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (r a) (tag (make-from-mag-ang r a))))
  'done)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-complex-package</span>)
  (install-polar-package)
  (install-rectangular-package)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">imported procedures from rectangular and polar packages</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-real-imag</span> x y)
    ((get 'make-from-real-imag 'rectangular) x y))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-from-mag-ang</span> r a)
    ((get 'make-from-mag-ang 'polar) r a))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-complex</span> z1 z2)
    (make-from-real-imag (add (real-part z1) (real-part z2))
                         (add (imag-part z1) (imag-part z2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-complex</span> z1 z2)
    (make-from-real-imag (sub (real-part z1) (real-part z2))
                         (sub (imag-part z1) (imag-part z2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-complex</span> z1 z2)
    (make-from-mag-ang (mul (magnitude z1) (magnitude z2))
                       (add (angle z1) (angle z2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-complex</span> z1 z2)
    (make-from-mag-ang (div (magnitude z1) (magnitude z2))
                       (sub (angle z1) (angle z2))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> z) (attach-tag 'complex z))
  (put 'add '(complex complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z1 z2) (tag (add-complex z1 z2))))
  (put 'sub '(complex complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z1 z2) (tag (sub-complex z1 z2))))
  (put 'mul '(complex complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z1 z2) (tag (mul-complex z1 z2))))
  (put 'div '(complex complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z1 z2) (tag (div-complex z1 z2))))
  (put 'make-from-real-imag 'complex
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (make-from-real-imag x y))))
  (put 'make-from-mag-ang 'complex
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (r a) (tag (make-from-mag-ang r a))))
  (put 'real-part '(complex) real-part)
  (put 'imag-part '(complex) imag-part)
  (put 'magnitude '(complex) magnitude)
  (put 'angle '(complex) angle)
  'done)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Should have done this using coercion; also, should have tried to</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">preserve types?</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-trigonometric-etc-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag-scheme-number</span> object)
    (attach-tag 'scheme-number object))
  (put 'arctan '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (atan n))))
  (put 'arctan '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (atan (/ (numer n) (denom n))))))
  (put 'sine '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (sin n))))
  (put 'sine '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (sin (/ (numer n) (denom n))))))
  (put 'cosine '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (cos n))))
  (put 'cosine '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (cos (/ (numer n) (denom n))))))
  (put 'square '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (* n n))))
  (put 'square '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (<span style="color: #00ffff; font-weight: bold;">let</span> ((n (/ (numer n) (denom n))))
                (tag-scheme-number (* n n)))))
  (put 'square-root '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number (sqrt n))))
  (put 'square-root '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (tag-scheme-number
               (sqrt (/ (numer n) (denom n)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">arctan</span> x) (apply-generic 'arctan x))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cosine</span> x) (apply-generic 'cosine x))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sine</span> x) (apply-generic 'sine x))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (apply-generic 'square x))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-root</span> x) (apply-generic 'square-root x))

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-trigonometric-etc-package)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((rational (make-rational 1 2))
       (complex (make-complex-from-real-imag rational rational)))
  (test '(complex rectangular (rational 1 . 1) rational 1 . 1)
        (add complex complex)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-87" class="outline-3">
<h3 id="sec-2-87"><span class="section-number-3">2.87</span> <span class="done DONE">DONE</span> 2.87</h3>
<div class="outline-text-3" id="text-2-87">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">attach-tag</span> type-tag contents)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? type-tag 'scheme-number)
      contents
      (cons type-tag contents)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">type-tag</span> datum)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? datum) 'scheme-number)
        ((pair? datum) (car datum))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Bad tagged datum: TYPE-TAG"</span> datum))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">contents</span> datum)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((number? datum) datum)
        ((pair? datum) (cdr datum))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Bad tagged datum: CONTENTS"</span> datum))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-zero-package</span>)
  (put '=zero? '(scheme-number) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (= 0 n)))
  (put '=zero? '(rational) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (= 0 (numer n))))
  (put '=zero? '(complex) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (<span style="color: #00ffff; font-weight: bold;">and</span> (= (imag-part n) 0)
                                      (= (real-part n) 0)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">=zero?</span> n) (apply-generic '=zero? n))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polynomial-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">representation of poly</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (add-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: ADD-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((empty-termlist? L1) L2)
          ((empty-termlist? L2) L1)
          (<span style="color: #00ffff; font-weight: bold;">else</span>
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((t1 (first-term L1))
                 (t2 (first-term L2)))
             (<span style="color: #00ffff; font-weight: bold;">cond</span> ((&gt; (order t1) (order t2))
                    (adjoin-term
                     t1 (add-terms (rest-terms L1) L2)))
                   ((&lt; (order t1) (order t2))
                    (adjoin-term
                     t2 (add-terms L1 (rest-terms L2))))
                   (<span style="color: #00ffff; font-weight: bold;">else</span>
                    (adjoin-term
                     (make-term (order t1)
                                (add (coeff t1) (coeff t2)))
                     (add-terms (rest-terms L1)
                                (rest-terms L2)))))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (mul-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: MUL-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L1)
        (the-empty-termlist)
        (add-terms (mul-term-by-all-terms (first-term L1) L2)
                   (mul-terms (rest-terms L1) L2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-term-by-all-terms</span> t1 L)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L)
        (the-empty-termlist)
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((t2 (first-term L)))
          (adjoin-term
           (make-term (+ (order t1) (order t2))
                      (mul (coeff t1) (coeff t2)))
           (mul-term-by-all-terms t1 (rest-terms L))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">poly-=zero?</span> p)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((term-list (term-list p)))
      (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? term-list)
          (every =zero? (<span style="color: #00ffff; font-weight: bold;">map</span> coeff term-list)))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))
  (put 'add '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (add-poly p1 p2))))
  (put 'mul '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (mul-poly p1 p2))))
  (put 'make 'polynomial
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (var terms) (tag (make-poly var terms))))
  (put '=zero? '(polynomial) poly-=zero?)
  'done)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-polynomial</span> var terms)
  ((get 'make 'polynomial) var terms))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-polynomial-package)
(install-zero-package)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((p1 (make-polynomial 'x '((2 1))))
       (p2 (make-polynomial 'x `((2 ,p1)))))
  (test '(polynomial x (2 (polynomial x (2 2))))
        (add p2 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-88" class="outline-3">
<h3 id="sec-2-88"><span class="section-number-3">2.88</span> <span class="done DONE">DONE</span> 2.88</h3>
<div class="outline-text-3" id="text-2-88">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-negation-package</span>)
  (put 'negate '(scheme-number)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (make-scheme-number (- n))))
  (put 'negate '(rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (r) (make-rational (- (numer r))
                             (denom r))))
  (put 'negate '(complex)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z) (make-complex-from-real-imag
               (- (real-part z))
               (- (imag-part z)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (put 'negate '(polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p) (make-polynomial (variable p)
                               (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (term)
                                      (make-term (order term)
                                                 (negate (coeff term))))
                                    (term-list p))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">negate</span> n) (apply-generic 'negate n))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polynomial-sub-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-poly</span> p1 p2)
    (add (attach-tag 'polynomial p1)
         (negate (attach-tag 'polynomial p2))))
  (put 'sub '(polynomial polynomial) sub-poly))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-polynomial-package)
(install-negation-package)
(install-polynomial-sub-package)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((p1 (make-polynomial 'x '((2 1))))
       (p2 (make-polynomial 'x `((2 ,p1)))))
  (test '(polynomial x)
        (sub p2 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-89" class="outline-3">
<h3 id="sec-2-89"><span class="section-number-3">2.89</span> <span class="done DONE">DONE</span> 2.89</h3>
<div class="outline-text-3" id="text-2-89">
<p>
It is sufficient to modify <code>first-term</code> and <code>adjoin-term</code> to
implement the dense representation.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polynomial-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Modified these accessors for the dense representation.</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list)
    (make-term (- (length term-list) 1)
               (car term-list)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= (length term-list) (order term))
        (cons (coeff term) term-list)
        (adjoin-term term (cons 0 term-list))))

  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">The rest is the same.</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list)
    (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (add-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: ADD-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((empty-termlist? L1) L2)
          ((empty-termlist? L2) L1)
          (<span style="color: #00ffff; font-weight: bold;">else</span>
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((t1 (first-term L1))
                 (t2 (first-term L2)))
             (<span style="color: #00ffff; font-weight: bold;">cond</span> ((&gt; (order t1) (order t2))
                    (adjoin-term
                     t1 (add-terms (rest-terms L1) L2)))
                   ((&lt; (order t1) (order t2))
                    (adjoin-term
                     t2 (add-terms L1 (rest-terms L2))))
                   (<span style="color: #00ffff; font-weight: bold;">else</span>
                    (adjoin-term
                     (make-term (order t1)
                                (add (coeff t1) (coeff t2)))
                     (add-terms (rest-terms L1)
                                (rest-terms L2)))))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (mul-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: MUL-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L1)
        (the-empty-termlist)
        (add-terms (mul-term-by-all-terms (first-term L1) L2)
                   (mul-terms (rest-terms L1) L2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-term-by-all-terms</span> t1 L)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L)
        (the-empty-termlist)
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((t2 (first-term L)))
          (adjoin-term
           (make-term (+ (order t1) (order t2))
                      (mul (coeff t1) (coeff t2)))
           (mul-term-by-all-terms t1 (rest-terms L))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">poly-=zero?</span> p)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((term-list (term-list p)))
      (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? term-list)
          (every =zero? (<span style="color: #00ffff; font-weight: bold;">map</span> coeff term-list)))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))
  (put 'add '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (add-poly p1 p2))))
  (put 'mul '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (mul-poly p1 p2))))
  (put 'make 'polynomial
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (var terms) (tag (make-poly var terms))))
  (put '=zero? '(polynomial) poly-=zero?)
  'done)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-polynomial-package)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((p1 (make-polynomial 'x '(1 0 0)))
       (p2 (make-polynomial 'x `(,p1 0 0))))
  (test '(polynomial x (polynomial x 2 0 0) 0 0)
         (add p2 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-90" class="outline-3">
<h3 id="sec-2-90"><span class="section-number-3">2.90</span> <span class="done DONE">DONE</span> 2.90</h3>
<div class="outline-text-3" id="text-2-90">
<p>
Unlike complex numbers, we don’t have two types of polynomials:
sparse and dense; instead, we have one type of polynomial (namely
polynomial) and two types of term lists, sparse and dense, such that
a polynomial looks like: <code>(polynomial x sparse (2 2))</code>.
</p>

<p>
It’s also useful to have a <code>term</code> type for generic operations
involving coefficients, etc.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-term-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> object) (attach-tag 'term object))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">order</span> car)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">coeff</span> cadr)
  (put 'make-term 'term (<span style="color: #00ffff; font-weight: bold;">lambda</span> (order coeff)
                          (tag (list order coeff))))
  (put 'order '(term) order)
  (put 'coeff '(term) coeff))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff)
  ((get 'make-term 'term) order coeff))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term)
  (apply-generic 'order term))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term)
  (apply-generic 'coeff term))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-sparse-term-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> object) (attach-tag 'sparse object))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (apply make-term (car term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((term (apply make-term term)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
          (tag term-list)
          (tag (cons (contents term) term-list)))))
  (put 'make-terms 'sparse
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (terms)
         (attach-tag 'sparse terms)))
  (put 'first-term '(sparse) first-term)
  (put 'adjoin-term '(term sparse) adjoin-term)
  (put 'empty-termlist? '(sparse) null?)
  (put 'rest-terms '(sparse) (compose tag cdr)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-dense-term-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> object) (attach-tag 'dense object))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list)
    (make-term (- (length term-list) 1)
               (car term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((term (apply make-term term)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (= (length term-list) (order term))
          (tag (cons (coeff term) term-list))
          (adjoin-term (contents term)
                       (cons 0 term-list)))))
  (put 'make-terms 'dense
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (terms) (tag terms)))
  (put 'first-term '(dense) first-term)
  (put 'adjoin-term '(term dense) adjoin-term)
  (put 'empty-termlist? '(dense) null?)
  (put 'rest-terms '(dense) (compose tag cdr)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list)
  (apply-generic 'first-term term-list))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
  (apply-generic 'adjoin-term term term-list))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> terms)
  (apply-generic 'empty-termlist? terms))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> terms)
  (apply-generic 'rest-terms terms))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-sparse-terms</span> terms)
  ((get 'make-terms 'sparse) terms))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-dense-terms</span> terms)
  ((get 'make-terms 'dense) terms))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polynomial-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">representation of poly</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list)
    (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (add-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: ADD-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((empty-termlist? L1) L2)
          ((empty-termlist? L2) L1)
          (<span style="color: #00ffff; font-weight: bold;">else</span>
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((t1 (first-term L1))
                 (t2 (first-term L2)))
             (<span style="color: #00ffff; font-weight: bold;">cond</span> ((&gt; (order t1) (order t2))
                    (adjoin-term
                     t1 (add-terms (rest-terms L1) L2)))
                   ((&lt; (order t1) (order t2))
                    (adjoin-term
                     t2 (add-terms L1 (rest-terms L2))))
                   (<span style="color: #00ffff; font-weight: bold;">else</span>
                    (adjoin-term
                     (make-term (order t1)
                                (add (coeff t1) (coeff t2)))
                     (add-terms (rest-terms L1)
                                (rest-terms L2)))))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (make-poly (variable p1)
                   (mul-terms (term-list p1) (term-list p2)))
        (error <span style="color: #00ff00;">"Polys not in same var: MUL-POLY"</span> (list p1 p2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-terms</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L1)
        (the-empty-termlist)
        (add-terms (mul-term-by-all-terms (first-term L1) L2)
                   (mul-terms (rest-terms L1) L2))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-term-by-all-terms</span> t1 L)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-termlist? L)
        (the-empty-termlist)
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((t2 (first-term L)))
          (adjoin-term
           (make-term (+ (order t1) (order t2))
                      (mul (coeff t1) (coeff t2)))
           (mul-term-by-all-terms t1 (rest-terms L))))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">poly-=zero?</span> p)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((term-list (term-list p)))
      (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? term-list)
          (every =zero? (<span style="color: #00ffff; font-weight: bold;">map</span> coeff term-list)))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))
  (put 'add '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (add-poly p1 p2))))
  (put 'mul '(polynomial polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (tag (mul-poly p1 p2))))
  (put 'make 'polynomial
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (var terms) (tag (make-poly var terms))))
  (put '=zero? '(polynomial) poly-=zero?)
  'done)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-sparse-polynomial</span> var terms)
  ((get 'make 'polynomial) var (make-sparse-terms terms)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-dense-polynomial</span> var terms)
  ((get 'make 'polynomial) var (make-dense-terms terms)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">=zero?</span> n) (apply-generic '=zero? n))

(install-zero-package)
(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-term-package)
(install-sparse-term-package)
(install-dense-term-package)
(install-polynomial-package)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((p1 (make-sparse-polynomial 'x '((2 1))))
       (p2 (make-dense-polynomial 'x `(,p1 0 0))))
  (test '(polynomial x dense (polynomial x sparse (2 2)) 0 0)
        (add p2 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-91" class="outline-3">
<h3 id="sec-2-91"><span class="section-number-3">2.91</span> <span class="done DONE">DONE</span> 2.91</h3>
<div class="outline-text-3" id="text-2-91">
<p>
In order to pull this off, we had to employ generic <code>=zero?</code> and
<code>sub</code>; because we were working outside of the original polynomial
package, there was a little awkwardness in terms of reexporting
polynomials for generic operations.
</p>

<p>
(We have a separate case for zero-polynomials which Robert didn’t
need; why is that?)
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-polynomial-div-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Copied, unfortunately, from the polynomial package</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))

  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Division starts here.</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable (variable p1)))
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (div-terms variable
                                   (term-list p1)
                                   (term-list p2))))
            (list (make-polynomial variable (car result))
                  (make-polynomial variable (cadr result)))))
        (error <span style="color: #00ff00;">"Polys not in same var: DIV-POLY"</span> (list p1 p2))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((every =zero? (<span style="color: #00ffff; font-weight: bold;">map</span> coeff L1))
           (list (list (make-term 0 0)) (list (make-term 0 0))))
          ((empty-termlist? L1)
           (list (the-empty-termlist) (the-empty-termlist)))
          (<span style="color: #00ffff; font-weight: bold;">else</span>
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((t1 (first-term L1))
                 (t2 (first-term L2)))
             (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt; (order t2) (order t1))
                 (list (the-empty-termlist) L1)
                 (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-c (div (coeff t1) (coeff t2)))
                       (new-o (- (order t1) (order t2))))
                   (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-term (make-term new-o new-c)))
                     (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (make-polynomial variable (list new-term)))
                           (dividend (make-polynomial variable L1))
                           (divisor (make-polynomial variable L2)))
                       (<span style="color: #00ffff; font-weight: bold;">let</span> ((rest-of-result
                              (div-terms variable
                                         (term-list
                                          (contents
                                           (sub dividend (mul result divisor))))
                                         L2)))
                         (list (adjoin-term new-term (car rest-of-result))
                               (cadr rest-of-result)))))))))))

  (put 'div '(polynomial polynomial) div-poly))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((5 1) (0 -1))))
      (p2 (make-polynomial 'x '((2 1) (0 -1)))))
  (test '((polynomial x (3 1) (1 1)) (polynomial x (1 1) (0 -1)))
        (div p1 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-92" class="outline-3">
<h3 id="sec-2-92"><span class="section-number-3">2.92</span> <span class="todo TODO">TODO</span> 2.92</h3>
<div class="outline-text-3" id="text-2-92">
<p>
How would this work: order the primary variable first, followed by
secondary, tertiary, etc.?
</p>
</div>
</div>
<div id="outline-container-sec-2-93" class="outline-3">
<h3 id="sec-2-93"><span class="section-number-3">2.93</span> <span class="done DONE">DONE</span> 2.93</h3>
<div class="outline-text-3" id="text-2-93">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rational-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">numer</span> x) (car x))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">denom</span> x) (cdr x))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-rat</span> n d)
    (cons n d))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-rat</span> x y)
    (make-rat (add (mul (numer x) (denom y))
                   (mul (numer y) (denom x)))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-rat</span> x y)
    (make-rat (sub (mul (numer x) (denom y))
                   (mul (numer y) (denom x)))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-rat</span> x y)
    (make-rat (mul (numer x) (numer y))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-rat</span> x y)
    (make-rat (mul (numer x) (denom y))
              (mul (denom x) (numer y))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> x) (attach-tag 'rational x))
  (put 'add '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (add-rat x y))))
  (put 'sub '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (sub-rat x y))))
  (put 'mul '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (mul-rat x y))))
  (put 'div '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (div-rat x y))))
  (put 'make 'rational
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n d) (tag (make-rat n d))))
  (put 'numer '(rational) numer)
  (put 'denom '(rational) denom)
  'done)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)
(include <span style="color: #00ff00;">"rational-generic.scm"</span>)

(install-scheme-number-package)
(install-rational-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((2 1) (0 1))))
      (p2 (make-polynomial 'x '((3 1) (0 1)))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((rf (make-rational p2 p1)))
    (test '(rational (polynomial x (5 2) (3 2) (2 2) (0 2))
                     polynomial x (4 1) (2 2) (0 1))
          (add rf rf))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-94" class="outline-3">
<h3 id="sec-2-94"><span class="section-number-3">2.94</span> <span class="done DONE">DONE</span> 2.94</h3>
<div class="outline-text-3" id="text-2-94">
<p>
According to <a href="http://po.st/UPdANw">WolframAlpha</a>, though, the result is not \(-x^2 + x\) but
\(x^2 - x\); which, I take it, is because they prefer <a href="http://en.wikipedia.org/wiki/Monic_polynomial">monic form</a>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-greatest-common-divisor-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Copied, unfortunately, from the polynomial package</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remainder-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (div (make-polynomial variable L1)
                       (make-polynomial variable L2))))
      (term-list (contents (cadr result)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? L2)
            (=zero? (make-polynomial variable L2)))
        L1
        (gcd-terms variable L2 (remainder-terms variable L1 L2))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable (variable p1)))
          (make-polynomial variable (gcd-terms variable
                                               (term-list p1)
                                               (term-list p2))))
        (error <span style="color: #00ff00;">"Polys not in same var: GCD-POLY"</span>)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd</span> a b)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
        a
        (gcd b (remainder a b))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-scheme-number</span> a b)
    (attach-tag 'scheme-number
                (gcd a b)))

  (put 'greatest-common-divisor
       '(polynomial polynomial)
       gcd-poly)

  (put 'greatest-common-divisor
       '(scheme-number scheme-number)
       gcd-scheme-number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">greatest-common-divisor</span> n1 n2)
  (apply-generic 'greatest-common-divisor n1 n2))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-rational-simplifying-make-package</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-rat</span> n d)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((g (greatest-common-divisor n d)))
      (cons (div n g) (div d g))))
  (put 'make 'rational
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n d)
         (attach-tag 'rational (make-rat n d)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)
(include <span style="color: #00ff00;">"rational-generic.scm"</span>)
(include <span style="color: #00ff00;">"greatest-common-divisor.scm"</span>)

(install-scheme-number-package)
(install-rational-package)
(install-rational-simplifying-make-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)
(install-greatest-common-divisor-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((4 1) (3 -1) (2 -2) (1 2))))
      (p2 (make-polynomial 'x '((3 1) (1 -1)))))
  (test '(polynomial x (2 -1) (1 1))
        (greatest-common-divisor p1 p2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-95" class="outline-3">
<h3 id="sec-2-95"><span class="section-number-3">2.95</span> <span class="done DONE">DONE</span> 2.95</h3>
<div class="outline-text-3" id="text-2-95">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)
(include <span style="color: #00ff00;">"rational-generic.scm"</span>)
(include <span style="color: #00ff00;">"greatest-common-divisor.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-greatest-common-divisor-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Copied, unfortunately, from the polynomial package</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remainder-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (div (make-polynomial variable L1)
                       (make-polynomial variable L2))))
      (term-list (contents (cadr result)))))

  (trace remainder-terms)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? L2)
            (=zero? (make-polynomial variable L2)))
        L1
        (gcd-terms variable L2 (remainder-terms variable L1 L2))))

  (trace gcd-terms)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable (variable p1)))
          (make-polynomial variable (gcd-terms variable
                                               (term-list p1)
                                               (term-list p2))))
        (error <span style="color: #00ff00;">"Polys not in same var: GCD-POLY"</span>)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd</span> a b)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
        a
        (gcd b (remainder a b))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-scheme-number</span> a b)
    (attach-tag 'scheme-number
                (gcd a b)))

  (put 'greatest-common-divisor
       '(polynomial polynomial)
       gcd-poly)

  (put 'greatest-common-divisor
       '(scheme-number scheme-number)
       gcd-scheme-number))

(install-scheme-number-package)
(install-rational-package)
(install-rational-simplifying-make-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)
(install-greatest-common-divisor-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((2 1) (1 -2) (0 1))))
      (p2 (make-polynomial 'x '((2 11) (0 7))))
      (p3 (make-polynomial 'x '((1 13) (0 5)))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((q1 (mul p1 p2))
        (q2 (mul p1 p3)))
    (test-assert (not (equal? p1 (greatest-common-divisor q1 q2))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-96" class="outline-3">
<h3 id="sec-2-96"><span class="section-number-3">2.96</span> <span class="done DONE">DONE</span> 2.96</h3>
<div class="outline-text-3" id="text-2-96">
<p>
We ended up defining an ad-hoc <code>mul</code> between scheme-numbers and
polynomials (though this should have been taken care of by
coercion); and it turns out that <code>greatest-common-divisor</code> is
pathological for the zero-case (otherwise, we could have used zero
as an identity when folding over GCD).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)
(include <span style="color: #00ff00;">"rational-generic.scm"</span>)
(include <span style="color: #00ff00;">"greatest-common-divisor.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">remove-common-factors?</span> (make-parameter #f))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-greatest-common-divisor-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Copied, unfortunately, from the polynomial package</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integerizing-factor</span> L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((o1 (order (first-term L1)))
          (o2 (order (first-term L2)))
          (c (coeff (first-term L2))))
      (expt c (+ 1 (- o1 o2)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pseudoremainder-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (div (mul (integerizing-factor L1 L2)
                            (make-polynomial variable L1))
                       (make-polynomial variable L2))))
      (term-list (contents (cadr result)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remove-common-factors</span> L)
    (<span style="color: #00ffff; font-weight: bold;">let*</span> ((factors (<span style="color: #00ffff; font-weight: bold;">map</span> coeff L))
           (gcd (fold greatest-common-divisor
                      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This is a little </span><span style="color: #ff0000; font-weight: bold;">hack</span><span style="color: #ffff00;">y; with out-of-the box</span>
                      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">gcd, we could have given 0 as the seed.</span>
                      (car factors)
                      (cdr factors))))
      (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (term) (make-term (order term)
                                (div (coeff term) gcd))) L)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? L2)
            (=zero? (make-polynomial variable L2)))
        (<span style="color: #00ffff; font-weight: bold;">if</span> (remove-common-factors?)
            (remove-common-factors L1)
            L1)
        (gcd-terms variable L2 (pseudoremainder-terms variable L1 L2))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable (variable p1)))
          (make-polynomial variable (gcd-terms variable
                                               (term-list p1)
                                               (term-list p2))))
        (error <span style="color: #00ff00;">"Polys not in same var: GCD-POLY"</span>)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-scheme-number</span> a b)
    (attach-tag 'scheme-number
                (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
                    0
                    (gcd b (remainder a b)))))

  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This should be part of a general coercion; let's fill it in</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">ad-hoc here, though. To make this more general, should probably</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">also use e.g. adjoin-term instead of map (that would accomodate</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">both sparse and dense representations).</span>
  (put 'mul
       '(scheme-number polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n p)
         (make-polynomial
          (variable p)
          (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (term)
                 (make-term (order term)
                            (mul n (coeff term))))
               (term-list p)))))

  (put 'greatest-common-divisor
       '(polynomial polynomial)
       gcd-poly)

  (put 'greatest-common-divisor
       '(scheme-number scheme-number)
       gcd-scheme-number))

(install-scheme-number-package)
(install-rational-package)
(install-rational-simplifying-make-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)
(install-greatest-common-divisor-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((2 1) (1 -2) (0 1))))
      (p2 (make-polynomial 'x '((2 11) (0 7))))
      (p3 (make-polynomial 'x '((1 13) (0 5)))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((q1 (mul p1 p2))
        (q2 (mul p1 p3)))
    (test '(polynomial x (2 1458) (1 -2916) (0 1458))
          (greatest-common-divisor q1 q2))
    (parameterize ((remove-common-factors? #t))
      (test p1 (greatest-common-divisor q1 q2)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-97" class="outline-3">
<h3 id="sec-2-97"><span class="section-number-3">2.97</span> <span class="done DONE">DONE</span> 2.97</h3>
<div class="outline-text-3" id="text-2-97">
<p>
In order to make this work, we generalized <code>integerizing-factor</code> but
still had to redefine the rational package to use the simplifying
<code>make-rational</code>.
</p>

<p>
We renamed the top-level procedure <code>reduce</code> to <code>simplify</code> so as not
to contradict SRFI-1.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-1 test)

(include <span style="color: #00ff00;">"polynomial.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-sub.scm"</span>)
(include <span style="color: #00ff00;">"polynomial-div.scm"</span>)
(include <span style="color: #00ff00;">"rational-generic.scm"</span>)
(include <span style="color: #00ff00;">"greatest-common-divisor.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-reduction-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Copied, unfortunately, from the polynomial package</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-poly</span> variable term-list) (cons variable term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">variable</span> p) (car p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">term-list</span> p) (cdr p))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">variable?</span> symbol?)

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">same-variable?</span> v1 v2)
    (<span style="color: #00ffff; font-weight: bold;">and</span> (variable? v1) (variable? v2) (eq? v1 v2)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-term</span> term term-list)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (=zero? (coeff term))
        term-list
        (cons term term-list)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">the-empty-termlist</span>) '())
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-term</span> term-list) (car term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rest-terms</span> term-list) (cdr term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-termlist?</span> term-list) (null? term-list))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-term</span> order coeff) (list order coeff))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">order</span> term) (car term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">coeff</span> term) (cadr term))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> p) (attach-tag 'polynomial p))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integerizing-factor</span> o1 t2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((o2 (order t2))
          (c (coeff t2)))
      (expt c (+ 1 (- o1 o2)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pseudoremainder-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (div (mul (integerizing-factor
                             (order (first-term L1))
                             (first-term L2))
                            (make-polynomial variable L1))
                       (make-polynomial variable L2))))
      (term-list (contents (cadr result)))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">greatest-common-divisor-coefficients</span> L)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((factors (<span style="color: #00ffff; font-weight: bold;">map</span> coeff L)))
      (fold greatest-common-divisor
            (car factors)
            (cdr factors))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">divide-through</span> factor L)
    (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (term) (make-term (order term)
                              (div (coeff term) factor)))
         L))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remove-common-factors</span> L)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((gcd (greatest-common-divisor-coefficients L)))      
      (divide-through gcd L)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (empty-termlist? L2)
            (=zero? (make-polynomial variable L2)))
        (remove-common-factors L1)
        (gcd-terms variable L2 (pseudoremainder-terms variable L1 L2))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">reduce-terms</span> variable L1 L2)
    (<span style="color: #00ffff; font-weight: bold;">let*</span> ((gcd-terms (gcd-terms variable L1 L2))
           (factor (integerizing-factor
                    (max (order (first-term L1))
                         (order (first-term L2)))
                    (first-term gcd-terms))))
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((gcd-coefficients
             (greatest-common-divisor-coefficients
              (append L1 L2))))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((reduce
               (<span style="color: #00ffff; font-weight: bold;">lambda</span> (L)
                 (divide-through
                  gcd-coefficients
                  (term-list
                   (contents
                    (car
                     (div (mul factor (make-polynomial variable L))
                          (make-polynomial variable gcd-terms)))))))))
          (list (reduce L1)
                (reduce L2))))))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">reduce-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let*</span> ((variable (variable p1))
               (term-lists (reduce-terms variable
                                         (term-list p1)
                                         (term-list p2))))
          (list (make-polynomial variable (car term-lists))
                (make-polynomial variable (cadr term-lists))))
        (error <span style="color: #00ff00;">"Polys not in same var: REDUCE-POLY"</span>)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-poly</span> p1 p2)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (same-variable? (variable p1) (variable p2))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable (variable p1)))
          (make-polynomial variable (gcd-terms variable
                                               (term-list p1)
                                               (term-list p2))))
        (error <span style="color: #00ff00;">"Polys not in same var: GCD-POLY"</span>)))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">gcd-scheme-number</span> a b)
    (attach-tag 'scheme-number
                (<span style="color: #00ffff; font-weight: bold;">if</span> (= b 0)
                    0
                    (gcd b (remainder a b)))))

  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This should be part of a general coercion; let's fill it in</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">ad-hoc here, though. To make this more general, should probably</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">also use e.g. adjoin-term instead of map (that would accomodate</span>
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">both sparse and dense representations).</span>
  (put 'mul
       '(scheme-number polynomial)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n p)
         (make-polynomial
          (variable p)
          (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (term)
                 (make-term (order term)
                            (mul n (coeff term))))
               (term-list p)))))

  (put 'greatest-common-divisor
       '(polynomial polynomial)
       gcd-poly)

  (put 'greatest-common-divisor
       '(scheme-number scheme-number)
       gcd-scheme-number)

  (put 'simplify
       '(polynomial polynomial)
       reduce-poly)

  (put 'simplify
     '(scheme-number scheme-number)
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n d)
       (<span style="color: #00ffff; font-weight: bold;">let</span> ((g (gcd n d)))
         (list (/ n g) (/ d g)))))) 

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">simplify</span> x y)
  (apply-generic 'simplify x y))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">install-simplifying-rational-package</span>)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">internal procedures</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">numer</span> x) (car x))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">denom</span> x) (cdr x))

  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-rat</span> n d)
    (apply cons (simplify n d)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-rat</span> x y)
    (make-rat (add (mul (numer x) (denom y))
                   (mul (numer y) (denom x)))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sub-rat</span> x y)
    (make-rat (sub (mul (numer x) (denom y))
                   (mul (numer y) (denom x)))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-rat</span> x y)
    (make-rat (mul (numer x) (numer y))
              (mul (denom x) (denom y))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-rat</span> x y)
    (make-rat (mul (numer x) (denom y))
              (mul (denom x) (numer y))))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">interface to rest of the system</span>
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">tag</span> x) (attach-tag 'rational x))
  (put 'add '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (add-rat x y))))
  (put 'sub '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (sub-rat x y))))
  (put 'mul '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (mul-rat x y))))
  (put 'div '(rational rational)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (tag (div-rat x y))))
  (put 'make 'rational
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n d) (tag (make-rat n d))))
  (put 'numer '(rational) numer)
  (put 'denom '(rational) denom)
  'done)

(install-scheme-number-package)
(install-rational-package)
(install-rational-simplifying-make-package)
(install-complex-package)
(install-negation-package)
(install-polynomial-package)
(install-polynomial-sub-package)
(install-polynomial-div-package)
(install-zero-package)
(install-reduction-package)
(install-simplifying-rational-package)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((p1 (make-polynomial 'x '((1 1) (0 1))))
      (p2 (make-polynomial 'x '((3 1) (0 -1))))
      (p3 (make-polynomial 'x '((1 1))))
      (p4 (make-polynomial 'x '((2 1) (0 -1)))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((rf1 (make-rational p1 p2))
        (rf2 (make-rational p3 p4)))
    (test '(rational
            (polynomial x (3 1) (2 2) (1 3) (0 1) (0 0))
            polynomial x (4 1) (3 1) (1 -1) (0 -1) (0 0))
          (add rf1 rf2))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Chapter 3</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> <span class="done DONE">DONE</span> 3.1</h3>
<div class="outline-text-3" id="text-3-1">
<p>
We’re using the parameter in the procedure as our captured variable.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-accumulator</span> accumulatum)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (accumulandum)
    (set! accumulatum (+ accumulandum accumulatum))
    accumulatum))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((accumulator (make-accumulator 5)))
  (test 10 (accumulator 5))
  (test 15 (accumulator 5)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> <span class="done DONE">DONE</span> 3.2</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Let’s use the <a href="http://www.schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html#%25_idx_114">case</a>-syntax.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-monitored</span> f)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((calls 0))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
      (<span style="color: #00ffff; font-weight: bold;">case</span> message
        ((how-many-calls?) calls)
        ((reset-count) (set! calls 0))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (set! calls (+ calls 1))
              (f message))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((s (make-monitored sqrt)))
  (test 10.0 (s 100))
  (test 1 (s 'how-many-calls?)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> <span class="done DONE">DONE</span> 3.3</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Let’s start with the amount-lambda and do the logic therein.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-account</span> balance account-password)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (password message)
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (amount)
      (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? account-password password)
          (<span style="color: #00ffff; font-weight: bold;">case</span> message
            ((withdraw)
             (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt;= balance amount)
                 (<span style="color: #00ffff; font-weight: bold;">begin</span> (set! balance (- balance amount))
                        balance)
                 <span style="color: #00ff00;">"Insufficient funds"</span>))
            ((deposit)
             (set! balance (+ balance amount))
             balance)
            (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown request: MAKE-ACCOUNT"</span> message)))
          <span style="color: #00ff00;">"Incorrect password"</span>))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"make-account.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((acc (make-account 100 'password)))
  (test 60 ((acc 'password 'withdraw) 40))
  (test <span style="color: #00ff00;">"Incorrect password"</span> ((acc 'not-password 'withdraw) 40)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> <span class="done DONE">DONE</span> 3.4</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">

<pre class="src src-scheme">(use miscmacros test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">allowed-incorrect-accesses</span> (make-parameter 7))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-account</span> balance account-password)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((incorrect-accesses (allowed-incorrect-accesses)))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (password message)
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> (amount)
        (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? account-password password)
            (<span style="color: #00ffff; font-weight: bold;">begin</span>
              (set! incorrect-accesses (allowed-incorrect-accesses))
              (<span style="color: #00ffff; font-weight: bold;">case</span> message
                ((withdraw)
                 (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt;= balance amount)
                     (<span style="color: #00ffff; font-weight: bold;">begin</span> (set! balance (- balance amount))
                            balance)
                     <span style="color: #00ff00;">"Insufficient funds"</span>))
                ((deposit)
                 (set! balance (+ balance amount))
                 balance)
                (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown request: MAKE-ACCOUNT"</span> message))))
            (<span style="color: #00ffff; font-weight: bold;">begin</span>
              (set! incorrect-accesses (- incorrect-accesses 1))
              (<span style="color: #00ffff; font-weight: bold;">if</span> (negative? incorrect-accesses)
                  <span style="color: #00ff00;">"Call the cops"</span>
                  <span style="color: #00ff00;">"Incorrect password"</span>)))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((acc (make-account 100 'password)))
  (dotimes (i 7)
    (test <span style="color: #00ff00;">"Incorrect password"</span> ((acc 'not-password 'withdraw) 40)))
  (test <span style="color: #00ff00;">"Call the cops"</span> ((acc 'not-password 'withdraw) 40)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> <span class="done DONE">DONE</span> 3.5</h3>
<div class="outline-text-3" id="text-3-5">
<p>
We can simplify the <code>pi-predicate</code> to test \(x\) and \(y\) against 1.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use random-bsd sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">random-in-range</span> low high)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((range (- high low)))
    (+ low (* (random-real) range))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">monte-carlo</span> trials experiment)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((trials-remaining trials)
             (trials-passed 0))
    (<span style="color: #00ffff; font-weight: bold;">cond</span> ((zero? trials-remaining)
           (/ trials-passed trials))
          ((experiment)
           (iter (- trials-remaining 1)
                 (+ trials-passed 1)))
          (<span style="color: #00ffff; font-weight: bold;">else</span>
           (iter (- trials-remaining 1)
                 trials-passed)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">estimate-integral</span> p x1 x2 y1 y2 trials)
  (monte-carlo
   trials
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
     (<span style="color: #00ffff; font-weight: bold;">let</span> ((x (random-in-range x1 x2))
           (y (random-in-range y1 y2)))
       (p x y)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pi-predicate</span> x y)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Can also test against x instead of 1 - x.</span>
  (&lt;= (+ (square (- 1 x))
         (square (- 1 y)))
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Superfluous square</span>
      (square 1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">estimate-pi</span> trials)
  (* 4 (estimate-integral pi-predicate 0 1 0 1 trials)))

(parameterize ((current-test-epsilon 0.01))
  (test 3.14 (estimate-pi 10000)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> <span class="done DONE">DONE</span> 3.6</h3>
<div class="outline-text-3" id="text-3-6">
<p>
This uses the built-in <code>random</code> and <code>randomize</code> from Chicken.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use extras test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rand</span> message)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n)
    (<span style="color: #00ffff; font-weight: bold;">case</span> message
      ((generate) (random n))
      ((reset) (randomize n)))))

((rand 'reset) 100)
(test 1 ((rand 'generate) 6))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7"><span class="section-number-3">3.7</span> <span class="done DONE">DONE</span> 3.7</h3>
<div class="outline-text-3" id="text-3-7">
<p>
We didn’t end up modifying the original <code>make-account</code> to accomodate
the <code>make-joint</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"make-account.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-joint</span> account old-password new-password)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (password message)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? password new-password)
        (account old-password message)
        (<span style="color: #00ffff; font-weight: bold;">lambda</span> (amount) <span style="color: #00ff00;">"Incorrect password"</span>))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((peter (make-account 100 'old-password))
       (paul (make-joint peter 'old-password 'new-password)))
  (test 80 ((peter 'old-password 'withdraw) 20))
  (test 60 ((paul 'new-password 'withdraw) 20))
  (test <span style="color: #00ff00;">"Incorrect password"</span> ((peter 'not-old-password 'withdraw) 20))
  (test <span style="color: #00ff00;">"Incorrect password"</span> ((paul 'not-new-password 'withdraw) 20)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8"><span class="section-number-3">3.8</span> <span class="done DONE">DONE</span> 3.8</h3>
<div class="outline-text-3" id="text-3-8">
<p>
Does it defy “simple” to have a constructor for <code>f</code>?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-f</span>)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((init #f))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
      (<span style="color: #00ffff; font-weight: bold;">if</span> init
          0
          (<span style="color: #00ffff; font-weight: bold;">begin</span>
            (set! init x)
            init)))))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Left-to-right</span>
(<span style="color: #00ffff; font-weight: bold;">let</span> ((f (make-f)))
  (test 0 (+ (f 0) (f 1))))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Right-to-left</span>
(<span style="color: #00ffff; font-weight: bold;">let</span> ((f (make-f)))
  (test 1 (+ (f 1) (f 0))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9"><span class="section-number-3">3.9</span> <span class="done DONE">DONE</span> 3.9</h3>
<div class="outline-text-3" id="text-3-9">
<p>
For completeness, should have included subtraction and addition;
only took factorial and multiplication into consideration.
</p>


<div class="figure">
<p><img src="./3.9-recursive.jpg" alt="3.9-recursive.jpg" />
</p>
<p><span class="figure-number">Figure 21:</span> Recursive factorial</p>
</div>


<div class="figure">
<p><img src="./3.9-iterative.jpg" alt="3.9-iterative.jpg" />
</p>
<p><span class="figure-number">Figure 22:</span> Iterative factorial</p>
</div>
</div>
</div>
<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10"><span class="section-number-3">3.10</span> <span class="done DONE">DONE</span> 3.10</h3>
<div class="outline-text-3" id="text-3-10">

<div class="figure">
<p><img src="./3.10.jpg" alt="3.10.jpg" />
</p>
<p><span class="figure-number">Figure 23:</span> Environment model for <code>make-withdraw</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11"><span class="section-number-3">3.11</span> <span class="done DONE">DONE</span> 3.11</h3>
<div class="outline-text-3" id="text-3-11">
<p>
The local state for <code>acc</code> is kept in <code>E1</code>; the local state for <code>acc2</code>
would be kept in a separate environment <code>E4</code> that resembles <code>E1</code>.
</p>

<p>
This is implementation-dependent; but the part of the environment
that would be shared between <code>acc</code> and <code>acc2</code> would be the body of
the code for the external and internal functions.
</p>


<div class="figure">
<p><img src="./3.11.jpg" alt="3.11.jpg" />
</p>
<p><span class="figure-number">Figure 24:</span> Environment model for <code>make-account</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-12" class="outline-3">
<h3 id="sec-3-12"><span class="section-number-3">3.12</span> <span class="done DONE">DONE</span> 3.12</h3>
<div class="outline-text-3" id="text-3-12">

<div class="figure">
<p><img src="./3.12.jpg" alt="3.12.jpg" />
</p>
<p><span class="figure-number">Figure 25:</span> Box-and-pointer for <code>w</code>, <code>x</code>, <code>y</code> and <code>z</code></p>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">append!</span> x y)
  (set-cdr! (last-pair x) y)
  x)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">last-pair</span> x)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr x)) x (last-pair (cdr x))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> '(a b))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> '(c d))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">z</span> (append x y))
(test '(b) (cdr x))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">w</span> (append! x y))
(test '(b c d) (cdr x))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-13" class="outline-3">
<h3 id="sec-3-13"><span class="section-number-3">3.13</span> <span class="done DONE">DONE</span> 3.13</h3>
<div class="outline-text-3" id="text-3-13">

<div class="figure">
<p><img src="./3.13.jpg" alt="3.13.jpg" />
</p>
<p><span class="figure-number">Figure 26:</span> Box-and-pointer for cyclical <code>z</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-14" class="outline-3">
<h3 id="sec-3-14"><span class="section-number-3">3.14</span> <span class="done DONE">DONE</span> 3.14</h3>
<div class="outline-text-3" id="text-3-14">

<div class="figure">
<p><img src="./3.14.jpg" alt="3.14.jpg" />
</p>
<p><span class="figure-number">Figure 27:</span> Box-and-pointer for mystery <code>v</code> and <code>w</code></p>
</div>
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mystery</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">loop</span> ((x x)
             (y '()))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? x)
        y
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((temp (cdr x)))
          (set-cdr! x y)
          (loop temp x)))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((v (list 'a 'b 'c 'd))
       (w (mystery v)))
  (test v '(a))
  (test w '(d c b a)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-15" class="outline-3">
<h3 id="sec-3-15"><span class="section-number-3">3.15</span> <span class="done DONE">DONE</span> 3.15</h3>
<div class="outline-text-3" id="text-3-15">

<div class="figure">
<p><img src="./3.15.jpg" alt="3.15.jpg" />  
</p>
<p><span class="figure-number">Figure 28:</span> Box-and-pointer for mystery <code>x</code>, <code>z1</code> and <code>z2</code> after <code>set-to-wow!</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-16" class="outline-3">
<h3 id="sec-3-16"><span class="section-number-3">3.16</span> <span class="done DONE">DONE</span> 3.16</h3>
<div class="outline-text-3" id="text-3-16">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">count-pairs</span> x)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (not (pair? x))
      0
      (+ (count-pairs (car x))
         (count-pairs (cdr x))
         1)))

(test 3 (count-pairs '(1 2 3)))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((x (cons 1 (cons 2 '()))))
  (test 5 (count-pairs (cons x x))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((x (cons 1 2))
       (y (cons x x)))
  (test 7 (count-pairs (cons y y))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-17" class="outline-3">
<h3 id="sec-3-17"><span class="section-number-3">3.17</span> <span class="done DONE">DONE</span> 3.17</h3>
<div class="outline-text-3" id="text-3-17">
<p>
Use hash-tables to check whether we’ve seen the node before.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use srfi-69 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">count-pairs</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((seen? (make-hash-table)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((x x))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (not (pair? x))
          0
          (+ (iter (car x))
             (iter (cdr x))
             (<span style="color: #00ffff; font-weight: bold;">if</span> (hash-table-ref/default seen? x #f)
                 0
                 (<span style="color: #00ffff; font-weight: bold;">begin</span>
                   (hash-table-set! seen? x #t) 1)))))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((x (cons 1 2))
       (y (cons x x)))
  (test 3 (count-pairs (cons y y))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-18" class="outline-3">
<h3 id="sec-3-18"><span class="section-number-3">3.18</span> <span class="done DONE">DONE</span> 3.18</h3>
<div class="outline-text-3" id="text-3-18">
<div class="org-src-container">

<pre class="src src-scheme">(use srfi-1 srfi-69 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-cycle</span> x)
  (set-cdr! (last-pair x) x)
  x)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cycle?</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((seen? (make-hash-table)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((x x))
      (<span style="color: #00ffff; font-weight: bold;">and</span> (not (null? x))
           (<span style="color: #00ffff; font-weight: bold;">or</span> (hash-table-ref/default seen? x #f)
               (<span style="color: #00ffff; font-weight: bold;">begin</span>
                 (hash-table-set! seen? x #t)
                 (iter (cdr x))))))))

(test-assert (not (cycle? '(1 2 1))))
(test-assert (cycle? (make-cycle (list 1 2 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-19" class="outline-3">
<h3 id="sec-3-19"><span class="section-number-3">3.19</span> <span class="done DONE">DONE</span> 3.19</h3>
<div class="outline-text-3" id="text-3-19">
<p>
Use Floyd’s with the composition of <code>cdr</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-cycle</span> x)
  (set-cdr! (last-pair x) x)
  x)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cycle?</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((tortoise (cdr x))
             (hare (cddr x)))
    (<span style="color: #00ffff; font-weight: bold;">and</span> (not (null? hare))
         (<span style="color: #00ffff; font-weight: bold;">or</span> (eq? tortoise hare)
             (<span style="color: #00ffff; font-weight: bold;">and</span> (not (null? (cdr hare)))
                  (iter (cdr tortoise) (cddr hare)))))))

(test-assert (not (cycle? '(1 2 1))))
(test-assert (cycle? (make-cycle (list 1 2 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-20" class="outline-3">
<h3 id="sec-3-20"><span class="section-number-3">3.20</span> <span class="done DONE">DONE</span> 3.20</h3>
<div class="outline-text-3" id="text-3-20">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2014-10-13 Mon 16:19]</span></span> <br  />
    This doesn’t feel complete.
</li>
</ul>

<div class="figure">
<p><img src="./3.20.jpg" alt="3.20.jpg" />
</p>
<p><span class="figure-number">Figure 29:</span> Environment diagram for <code>set-car!</code> and <code>car</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-21" class="outline-3">
<h3 id="sec-3-21"><span class="section-number-3">3.21</span> <span class="done DONE">DONE</span> 3.21</h3>
<div class="outline-text-3" id="text-3-21">
<div class="org-src-container">

<pre class="src src-scheme">(use ports sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">print-queue</span> (compose display car))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">q1</span> (make-queue))
(test <span style="color: #00ff00;">"(a)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (print-queue (insert-queue! q1 'a)))))
(test <span style="color: #00ff00;">"(a b)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (print-queue (insert-queue! q1 'b)))))
(test <span style="color: #00ff00;">"(b)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (print-queue (delete-queue! q1)))))
(test <span style="color: #00ff00;">"()"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (print-queue (delete-queue! q1)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-22" class="outline-3">
<h3 id="sec-3-22"><span class="section-number-3">3.22</span> <span class="done DONE">DONE</span> 3.22</h3>
<div class="outline-text-3" id="text-3-22">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-queue</span>)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((front-ptr '())
        (rear-ptr '()))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-front-ptr!</span> new-front-ptr)
      (set! front-ptr new-front-ptr))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-rear-ptr!</span> new-rear-ptr)
      (set! rear-ptr new-rear-ptr))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-queue?</span>)
      (null? front-ptr))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
      (<span style="color: #00ffff; font-weight: bold;">case</span> message
        ((front-ptr) front-ptr)
        ((rear-ptr) rear-ptr)
        ((set-front-ptr!) set-front-ptr!)
        ((set-rear-ptr!) set-rear-ptr!)
        ((empty?) empty-queue?)
        ((front)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-queue?)
             (error <span style="color: #00ff00;">"FRONT called with an empty queue"</span>)
             (car front-ptr)))
        ((insert!)
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (item)
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-pair (cons item '())))
             (<span style="color: #00ffff; font-weight: bold;">cond</span> ((empty-queue?)
                    (set-front-ptr! new-pair)
                    (set-rear-ptr! new-pair))
                   (<span style="color: #00ffff; font-weight: bold;">else</span>
                    (set-cdr! rear-ptr new-pair)
                    (set-rear-ptr! new-pair))))))
        ((delete!)
         (<span style="color: #00ffff; font-weight: bold;">cond</span> ((empty-queue?)
                (error <span style="color: #00ff00;">"DELETE! called with an empty queue"</span>))
               (<span style="color: #00ffff; font-weight: bold;">else</span> (set-front-ptr! (cdr front-ptr)))))
        ((print) (display front-ptr))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">front-ptr</span> queue) (queue 'front-ptr))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rear-ptr</span> queue) (queue 'rear-ptr))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-front-ptr!</span> queue item)
  ((queue 'set-front-ptr!) item))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-rear-ptr!</span> queue item)
  ((queue 'set-rear-ptr!) item))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty-queue?</span> queue) (queue 'empty?))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">front-queue</span> queue) (queue 'front))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">insert-queue!</span> queue item)
  ((queue 'insert!) item))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">delete-queue!</span> queue)
  (queue 'delete!))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">print-queue</span> queue) (queue 'print))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">q1</span> (make-queue))
(test <span style="color: #00ff00;">"(a)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (insert-queue! q1 'a) (print-queue q1))))
(test <span style="color: #00ff00;">"(a b)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (insert-queue! q1 'b) (print-queue q1))))
(test <span style="color: #00ff00;">"(b)"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (delete-queue! q1) (print-queue q1))))
(test <span style="color: #00ff00;">"()"</span>
      (with-output-to-string (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (delete-queue! q1) (print-queue q1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-23" class="outline-3">
<h3 id="sec-3-23"><span class="section-number-3">3.23</span> <span class="done DONE">DONE</span> 3.23</h3>
<div class="outline-text-3" id="text-3-23">
<p>
Implemented deques with something like a ternary cons cell (see <a href="https://groups.google.com/forum/?hl=en#!topic/alt.folklore.computers/ocLEir5Gfzw">car,
cdr, csr (cooser)</a>) to represent doubly-linked lists.
</p>


<div class="figure">
<p><img src="./3.23.jpg" alt="3.23.jpg" />
</p>
<p><span class="figure-number">Figure 30:</span> Deques with (quasi-ternary) conses</p>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use srfi-1 srfi-69 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-cell</span>
  (case-lambda ((payload) (make-cell #f #f payload))
          ((forward backward payload)
           (cons* forward backward payload))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">cell-forward</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">cell-backward</span> cadr)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">cell-payload</span> cddr)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cell-set-forward!</span> cell forward)
  (set-car! cell forward))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cell-set-backward!</span> cell backward)
  (set-car! (cdr cell) backward))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cell-set-payload!</span> cell payload)
  (set-cdr! (cdr cell) payload))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cell-&gt;list</span> front)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((cell (cell-backward front))
             (payloads '()))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? cell front)
        (cons (cell-payload cell) payloads)
        (iter (cell-backward cell)
              (cons (cell-payload cell) payloads)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-deque</span>)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((front '())
        (rear '()))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">empty?</span>) (null? front))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
      (<span style="color: #00ffff; font-weight: bold;">case</span> message
        ((front)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (empty?)
             (error <span style="color: #00ff00;">"FRONT called with an empty deque."</span>)
             (cell-payload front)))
        ((rear)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (empty?)
             (error <span style="color: #00ff00;">"REAR called with an empty deque."</span>)
             (cell-payload rear)))
        ((front-insert!)
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (payload)
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((cell (make-cell payload)))
             (when (empty?)
               (set! front cell)
               (set! rear cell))
             (cell-set-forward! cell front)
             (cell-set-backward! cell rear)
             (cell-set-backward! front cell)
             (cell-set-forward! rear cell)
             (set! front cell))))
        ((rear-insert!)
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (payload)
           (<span style="color: #00ffff; font-weight: bold;">let</span> ((cell (make-cell payload)))
             (when (empty?)
               (set! front cell)
               (set! rear cell))
             (cell-set-backward! cell rear)
             (cell-set-forward! cell front)
             (cell-set-forward! rear cell)
             (cell-set-backward! front cell)
             (set! rear cell))))
        ((front-delete!)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (empty?)
             (error <span style="color: #00ff00;">"FRONT-DELETE! called with empty deque."</span>)
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-front (cell-forward front)))
               (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? front new-front)
                   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Deque is empty.</span>
                   (<span style="color: #00ffff; font-weight: bold;">begin</span>
                     (set! front '())
                     (set! rear '()))
                   (<span style="color: #00ffff; font-weight: bold;">begin</span>
                     (cell-set-backward! new-front rear)
                     (cell-set-forward! rear new-front)
                     (set! front new-front))))))
        ((rear-delete!)
         (<span style="color: #00ffff; font-weight: bold;">if</span> (empty?)
             (error <span style="color: #00ff00;">"REAR-DELETE! called with empty deque."</span>)
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-rear (cell-backward rear)))
               (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? rear new-rear)
                   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Deque is empty.</span>
                   (<span style="color: #00ffff; font-weight: bold;">begin</span>
                     (set! front '())
                     (set! rear '()))
                   (<span style="color: #00ffff; font-weight: bold;">begin</span>
                     (cell-set-backward! front new-rear)
                     (cell-set-forward! new-rear front)
                     (set! rear new-rear))))))
        ((-&gt;list) (<span style="color: #00ffff; font-weight: bold;">if</span> (empty?) '() (cell-&gt;list front)))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((deque (make-deque)))
  (test '() (deque '-&gt;list))
  ((deque 'front-insert!) 'b)
  (test '(b) (deque '-&gt;list))
  ((deque 'front-insert!) 'a)
  (test '(a b) (deque '-&gt;list))
  ((deque 'rear-insert!) 'c)
  (test '(a b c) (deque '-&gt;list))
  (deque 'front-delete!)
  (test '(b c) (deque '-&gt;list))
  (deque 'rear-delete!)
  (test '(b) (deque '-&gt;list)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-24" class="outline-3">
<h3 id="sec-3-24"><span class="section-number-3">3.24</span> <span class="done DONE">DONE</span> 3.24</h3>
<div class="outline-text-3" id="text-3-24">
<p>
Let’s demonstrate tolerant keys using a tunable epsilon.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-table</span>
  (case-lambda
   (() (make-table equal?))
   ((same-key?)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((table (list '*table*)))
      (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">assoc</span> key records)
        (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? records) #f)
              ((same-key? key (caar records)) (car records))
              (<span style="color: #00ffff; font-weight: bold;">else</span> (assoc key (cdr records)))))
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
        (<span style="color: #00ffff; font-weight: bold;">case</span> message
          ((lookup)
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> (key)
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((record (assoc key (cdr table))))
               (<span style="color: #00ffff; font-weight: bold;">and</span> record (cdr record)))))
          ((insert!)
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> (key value)
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((record (assoc key (cdr table))))
               (<span style="color: #00ffff; font-weight: bold;">if</span> record
                   (set-cdr! record value)
                   (set-cdr! table
                             (cons (cons key value)
                                   (cdr table)))))))
          ((table) table)))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"table.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">epsilon</span> (make-parameter 0.1))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Bad design to use a dynamic variable: could change the semantics of</span>
<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">the table during usage; define at `make-approx-equal?'?</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">approx-equal?</span> x y)
  (&lt; (abs (- x y)) (epsilon)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((table (make-table approx-equal?)))
  ((table 'insert!) 1.0 'hello)
  (test 'hello ((table 'lookup) 0.99)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-25" class="outline-3">
<h3 id="sec-3-25"><span class="section-number-3">3.25</span> <span class="done DONE">DONE</span> 3.25</h3>
<div class="outline-text-3" id="text-3-25">
<p>
We created a new data-structure, <code>table-or-value</code>; the
implementation consists of <code>table-or-values</code> indexed by key.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test)

(include <span style="color: #00ff00;">"table.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">no-value</span> (cons #f #f))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">no-value?</span> object) (eq? no-value object))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-table-or-value</span> cons)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">table-or-value-table</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">table-or-value-table-set!</span> set-car!)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">table-or-value-value</span> cdr)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">table-or-value-value-set!</span> set-cdr!)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-deep-table</span>)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((table (make-table)))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
      (<span style="color: #00ffff; font-weight: bold;">case</span> message
        ((lookup)
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (keys)
           (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((keys keys)
                      (table table))
             (<span style="color: #00ffff; font-weight: bold;">let*</span> ((key (car keys))
                    (subtable-or-value ((table 'lookup) key)))
               (<span style="color: #00ffff; font-weight: bold;">and</span> subtable-or-value
                    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr keys)) <span style="color: #ffff00;">; </span><span style="color: #ffff00;">Terminal case</span>
                        (table-or-value-value subtable-or-value)
                        (iter (cdr keys)
                              (table-or-value-table subtable-or-value))))))))
        ((insert!)
         (<span style="color: #00ffff; font-weight: bold;">lambda</span> (keys value)
           (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((keys keys)
                      (table table))
             (<span style="color: #00ffff; font-weight: bold;">let*</span> ((key (car keys))
                    (subtable-or-value ((table 'lookup) key)))
               (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr keys))   <span style="color: #ffff00;">; </span><span style="color: #ffff00;">Terminal case</span>
                   (<span style="color: #00ffff; font-weight: bold;">if</span> subtable-or-value
                       (table-or-value-value-set! subtable-or-value value)
                       ((table 'insert!)
                        key
                        (make-table-or-value (make-table) value)))
                   (<span style="color: #00ffff; font-weight: bold;">if</span> subtable-or-value
                       (iter (cdr keys)
                             (table-or-value-table subtable-or-value))
                       (<span style="color: #00ffff; font-weight: bold;">let</span> ((subtable-or-value
                              (make-table-or-value (make-table) no-value)))
                         ((table 'insert!)
                          key
                          subtable-or-value)
                         (iter (cdr keys)
                               (table-or-value-table subtable-or-value)))))))))
        ((table) (table 'table))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((table (make-deep-table)))
  ((table 'insert!) '(a) 1)
  ((table 'insert!) '(a b) 2)
  (test 1 ((table 'lookup) '(a)))
  (test 2 ((table 'lookup) '(a b))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-26" class="outline-3">
<h3 id="sec-3-26"><span class="section-number-3">3.26</span> <span class="done DONE">DONE</span> 3.26</h3>
<div class="outline-text-3" id="text-3-26">
<p>
Let’s reuse tree-sets, but distinguishing between the key and the
value; in the previous implementation, keys were values.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"tree-sets.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">key-value</span> cons)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">key</span> car)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">value</span> cdr)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">element-of-set?</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set) #f)
        ((= (key x) (key (entry set))) #t)
        ((&lt; (key x) (key (entry set)))
         (element-of-set? x (left-branch set)))
        ((&gt; (key x) (key (entry set)))
         (element-of-set? x (right-branch set)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">adjoin-set</span> x set)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? set) (make-tree x '() '()))
        ((= (key x) (key (entry set))) set)
        ((&lt; (key x) (key (entry set)))
         (make-tree (entry set)
                    (adjoin-set x (left-branch set))
                    (right-branch set)))
        ((&gt; x (entry set))
         (make-tree (entry set) (left-branch set)
                    (adjoin-set x (right-branch set))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">lookup</span> lookup-key tree)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (null? tree)
      #f
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((entry (entry tree)))
        (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= lookup-key (key entry)) (value entry))
              ((&lt; lookup-key (key entry))
               (lookup lookup-key (left-branch tree)))
              (<span style="color: #00ffff; font-weight: bold;">else</span> (lookup lookup-key (right-branch tree)))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((tree (list-&gt;tree (list (key-value 1 'a)
                              (key-value 3 'b)
                              (key-value 6 'c)
                              (key-value 10 'd)))))
  (test 'c (lookup 6 tree))
  (test-assert (not (lookup 5 tree))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-27" class="outline-3">
<h3 id="sec-3-27"><span class="section-number-3">3.27</span> <span class="done DONE">DONE</span> 3.27</h3>
<div class="outline-text-3" id="text-3-27">
<ul class="org-ul">
<li>CLOSING NOTE <span class="timestamp-wrapper"><span class="timestamp">[2014-11-10 Mon 14:15]</span></span> <br  />
    We should redo this one to be a little clearer.
</li>
</ul>

<div class="figure">
<p><img src="./3.27.jpg" alt="3.27.jpg" />
</p>
<p><span class="figure-number">Figure 31:</span> Environment diagram for <code>memo-fib</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-28" class="outline-3">
<h3 id="sec-3-28"><span class="section-number-3">3.28</span> <span class="done DONE">DONE</span> 3.28</h3>
<div class="outline-text-3" id="text-3-28">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">logical-or</span> s t)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">and</span> (= s 1) (= t 1)) 1)
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (= s 1) (= t 0)) 1)
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (= s 0) (= t 1)) 1)
        ((<span style="color: #00ffff; font-weight: bold;">and</span> (= s 0) (= t 0)) 0)
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Invalid signal"</span> s))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">or-gate</span> a1 a2 output)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">or-action-procedure</span>)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((new-value
           (logical-or (get-signal a1) (get-signal a2))))
      (after-delay
       (or-gate-delay)
       (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (set-signal! output new-value)))))
  (add-action! a1 or-action-procedure)
  (add-action! a2 or-action-procedure)
  'ok)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(include <span style="color: #00ff00;">"or-gate.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-or-gate</span> test-or-gate)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-wire))
        (b (make-wire))
        (c (make-wire)))
    (or-gate a b c)
    (test-or-gate a b c)))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (propagate)
   (test 0 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! a 1)
   (propagate)
   (test 1 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! b 1)
   (propagate)
   (test 1 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! a 1)
   (set-signal! b 1)
   (propagate)
   (test 1 (get-signal c))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-29" class="outline-3">
<h3 id="sec-3-29"><span class="section-number-3">3.29</span> <span class="done DONE">DONE</span> 3.29</h3>
<div class="outline-text-3" id="text-3-29">
<p>
On analogy with \(\lnot (\lnot (x \lor y)) \equiv \lnot (\lnot x
  \land \lnot y)\), the compound or-gate might look like:
</p>


<div class="figure">
<p><img src="./3.29.jpg" alt="3.29.jpg" />
</p>
<p><span class="figure-number">Figure 32:</span> Compound or-gate</p>
</div>

<p>
whose delay is \(2\,\text{inverterDelay} + \text{andGateDelay}\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">or-gate</span> a1 a2 output)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((a3 (make-wire))
        (a4 (make-wire))
        (a5 (make-wire)))
    (inverter a1 a3)
    (inverter a2 a4)
    (and-gate a3 a4 a5)
    (inverter a5 output)
    'ok))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-or-gate</span> test-or-gate)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-wire))
        (b (make-wire))
        (c (make-wire)))
    (or-gate a b c)
    (test-or-gate a b c)))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (propagate)
   (test 0 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! a 1)
   (propagate)
   (test 1 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! b 1)
   (propagate)
   (test 1 (get-signal c))))

(test-or-gate
 (<span style="color: #00ffff; font-weight: bold;">lambda</span> (a b c)
   (set-signal! a 1)
   (set-signal! b 1)
   (propagate)
   (test 1 (get-signal c))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-30" class="outline-3">
<h3 id="sec-3-30"><span class="section-number-3">3.30</span> <span class="done DONE">DONE</span> 3.30</h3>
<div class="outline-text-3" id="text-3-30">
<p>
A full adder is two half adders plus an or-gate; whereas a half
adder is an or-gate, two and-gates and an inverter.
</p>

<p>
The total cost of a ripple-carry adder for \(n\) bits is therefore:
</p>

\begin{align}
n \times (2 \times (\text{orGateDelay} + 2\,\text{andGateDelay} + \text{inverterDelay}) + \\
\text{orGateDelay})
\end{align}

<div class="org-src-container">

<pre class="src src-scheme">(use sicp srfi-26 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">ripple-carry-adder</span> a b s c-out)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((a a)
             (b b)
             (s s)
             (c-in (make-wire)))
    (unless (null? a)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((c-out (<span style="color: #00ffff; font-weight: bold;">if</span> (null? (cdr a)) c-out (make-wire))))
        (full-adder (car a) (car b) c-in (car s) c-out)
        (iter (cdr a) (cdr b) (cdr s) c-out)))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a (list (make-wire 1)
               (make-wire 1)
               (make-wire 1)
               (make-wire 1)))
      (b (list (make-wire 1)
               (make-wire 1)
               (make-wire 1)
               (make-wire 1)))
      (s (list (make-wire)
               (make-wire)
               (make-wire)
               (make-wire)))
      (c (make-wire)))
  (ripple-carry-adder a b s c)
  (propagate)
  (test <span style="color: #00ff00;">"15 + 15 = 30 in binary"</span>
        '(1 1 1 1 0)
        (<span style="color: #00ffff; font-weight: bold;">map</span> get-signal (cons c (reverse s)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-31" class="outline-3">
<h3 id="sec-3-31"><span class="section-number-3">3.31</span> <span class="todo TODO">TODO</span> 3.31</h3>
<div class="outline-text-3" id="text-3-31">
<p>
The first call to <code>proc</code> scheduled the action; interestingly,
however, don’t see a difference in the half-adder example.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(parameterize ((the-agenda (make-agenda)))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((input-1 (make-wire))
        (input-2 (make-wire))
        (sum (make-wire))
        (carry (make-wire)))
    (probe 'sum sum)
    (probe 'carry carry)
    (half-adder input-1 input-2 sum carry)
    (set-signal! input-1 1)
    (propagate)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">make-wire-no-proc</span>
  (case-lambda
   (() (make-wire 0))
   ((signal-value)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((action-procedures '()))
      (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-my-signal!</span> new-value)
        (<span style="color: #00ffff; font-weight: bold;">if</span> (not (= signal-value new-value))
            (<span style="color: #00ffff; font-weight: bold;">begin</span> (set! signal-value new-value)
                   (call-each action-procedures))
            'done))
      (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">accept-action-procedure!</span> proc)
        (set! action-procedures
              (cons proc action-procedures)))
      (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">dispatch</span> m)
        (<span style="color: #00ffff; font-weight: bold;">cond</span> ((eq? m 'get-signal) signal-value)
              ((eq? m 'set-signal!) set-my-signal!)
              ((eq? m 'add-action!) accept-action-procedure!)
              (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown operation: WIRE"</span> m))))
      dispatch))))

(parameterize ((the-agenda (make-agenda)))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((input-1 (make-wire-no-proc))
        (input-2 (make-wire-no-proc))
        (sum (make-wire-no-proc))
        (carry (make-wire-no-proc)))
    (probe 'sum sum)
    (probe 'carry carry)
    (half-adder input-1 input-2 sum carry)
    (set-signal! input-1 1)
    (propagate)
    (get-signal sum)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-32" class="outline-3">
<h3 id="sec-3-32"><span class="section-number-3">3.32</span> <span class="todo TODO">TODO</span> 3.32</h3>
<div class="outline-text-3" id="text-3-32">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">remove-first-agenda-item!</span> agenda)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((q (segment-queue (first-segment agenda))))
    (set! q (cdr q))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? q)
        (set-segments! agenda (rest-segments agenda)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">first-agenda-item</span> agenda)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (empty-agenda? agenda)
      (error <span style="color: #00ff00;">"Agenda is empty: FIRST-AGENDA-ITEM"</span>)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((first-seg (first-segment agenda)))
        (set-current-time! agenda
                           (segment-time first-seg))
        (car (segment-queue first-seg)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-to-agenda!</span> time action agenda)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">belongs-before?</span> segments)
    (<span style="color: #00ffff; font-weight: bold;">or</span> (null? segments)
        (&lt; time (segment-time (car segments)))))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-new-time-segment</span> time action)
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((q (list)))
      (set! q (cons action q))
      (make-time-segment time q)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-to-segments!</span> segments)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (= (segment-time (car segments)) time)
        (set-cdr! (car segments)
                  (cons action (segment-queue (car segments))))
        <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">(insert-queue! (segment-queue (car segments))</span>
        <span style="color: #ffff00;">;;                </span><span style="color: #ffff00;">action)</span>
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((rest (cdr segments)))
          (<span style="color: #00ffff; font-weight: bold;">if</span> (belongs-before? rest)
              (set-cdr!
               segments
               (cons (make-new-time-segment time action)
                     (cdr segments)))
              (add-to-segments! rest)))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((segments (segments agenda)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (belongs-before? segments)
        (set-segments!
         agenda
         (cons (make-new-time-segment time action)
               segments))
        (add-to-segments! segments))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-wire 0))
      (b (make-wire 1))
      (c (make-wire))
      (d (make-wire))
      (e (make-wire)))
  (inverter a c)
  (inverter b d)
  (and-gate c d e)
  (propagate)
  (get-signal e))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-33" class="outline-3">
<h3 id="sec-3-33"><span class="section-number-3">3.33</span> <span class="done DONE">DONE</span> 3.33</h3>
<div class="outline-text-3" id="text-3-33">

<div class="figure">
<p><img src="./3.33.jpg" alt="3.33.jpg" />
</p>
<p><span class="figure-number">Figure 33:</span> The average-relation (\(2c = a + b\)) as a constraint network</p>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-constraints test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">averager</span> a b c)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((x (make-connector))
        (y (make-connector)))
    (adder a b x)
    (multiplier c y x)
    (constant 2 y)
    'ok))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">a</span> (make-connector))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">b</span> (make-connector))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">c</span> (make-connector))

(averager a b c)
(set-value! a 3 'user)
(set-value! b 5 'user)

(test 4 (get-value c))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-34" class="outline-3">
<h3 id="sec-3-34"><span class="section-number-3">3.34</span> <span class="done DONE">DONE</span> 3.34</h3>
<div class="outline-text-3" id="text-3-34">

<div class="figure">
<p><img src="./3.34.jpg" alt="3.34.jpg" />
</p>
<p><span class="figure-number">Figure 34:</span> A pathological square-relation</p>
</div>

<p>
If \(b\) is set and neither \(m_1\) nor \(m_2\) are set, it will not
square (there is not enough information); if \(a\) is set, on the
other hand, both \(m_1\) and \(m_2\) are also set and it will square.
</p>

<p>
(Not to mention the problem of generating solutions for \(m_1\) and
\(m_2\) when there is not enough information.)
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-constraints test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">squarer</span> a b)
  (multiplier a a b))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-connector))
      (b (make-connector)))
  (squarer a b)

  (set-value! b 4 'user)
  (test-assert <span style="color: #00ff00;">"a has not been set."</span> (not (has-value? a)))

  (forget-value! b 'user)
  (set-value! a 2 'user)
  (test <span style="color: #00ff00;">"b is 4."</span> 4 (get-value b)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-35" class="outline-3">
<h3 id="sec-3-35"><span class="section-number-3">3.35</span> <span class="done DONE">DONE</span> 3.35</h3>
<div class="outline-text-3" id="text-3-35">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-constraints test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">squarer</span> a b)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">process-new-value</span>)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (has-value? b)
        (<span style="color: #00ffff; font-weight: bold;">if</span> (&lt; (get-value b) 0)
            (error <span style="color: #00ff00;">"square less than 0: SQUARER"</span>
                   (get-value b))
            (set-value! a (sqrt (get-value b)) me))
        (set-value! b (* (get-value a) (get-value a)) me)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">process-forget-value</span>)
    (forget-value! a me)
    (forget-value! b me)
    (process-new-value))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">me</span> request)
    (<span style="color: #00ffff; font-weight: bold;">case</span> request
      ((I-have-a-value) (process-new-value))
      ((I-lost-my-value) (process-forget-value))
      (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown request: SQUARER"</span> request))))
  (connect a me)
  (connect b me)
  me)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-connector))
      (b (make-connector)))
  (squarer a b)
  (set-value! b 2 'user)
  (test 1.4142135623731 (get-value a)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a (make-connector))
      (b (make-connector)))
  (squarer a b)
  (set-value! a 2 'user)
  (test 4 (get-value b)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-36" class="outline-3">
<h3 id="sec-3-36"><span class="section-number-3">3.36</span> <span class="done DONE">DONE</span> 3.36</h3>
<div class="outline-text-3" id="text-3-36">

<div class="figure">
<p><img src="./3.36.jpg" alt="3.36.jpg" />
</p>
<p><span class="figure-number">Figure 35:</span> Environment diagram for <code>(for-each-except setter inform-about-value constraints)</code></p>
</div>
</div>
</div>
<div id="outline-container-sec-3-37" class="outline-3">
<h3 id="sec-3-37"><span class="section-number-3">3.37</span> <span class="done DONE">DONE</span> 3.37</h3>
<div class="outline-text-3" id="text-3-37">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-constraints test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">c+</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((z (make-connector)))
    (adder x y z)
    z))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">c*</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((z (make-connector)))
    (multiplier x y z)
    z))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">c/</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((z (make-connector)))
    (multiplier y z x)
    z))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cv</span> x)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((y (make-connector)))
    (constant x y)
    y))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">celsius-fahrenheit-converter</span> x)
  (c+ (c* (c/ (cv 9) (cv 5))
          x)
      (cv 32)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">C</span> (make-connector))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">F</span> (celsius-fahrenheit-converter C))

(set-value! F 212 'user)
(test 100.0 (get-value C))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-38" class="outline-3">
<h3 id="sec-3-38"><span class="section-number-3">3.38</span> <span class="done DONE">DONE</span> 3.38</h3>
<div class="outline-text-3" id="text-3-38">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Different values for <code>balance</code> given sequential operations</caption>

<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">\(balance_0\)</th>
<th scope="col" class="right">\(op_0\)</th>
<th scope="col" class="right">\(op_1\)</th>
<th scope="col" class="right">\(op_2\)</th>
<th scope="col" class="right">\(balance_4\)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">-20</td>
<td class="right">/2</td>
<td class="right">45</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">/2</td>
<td class="right">-20</td>
<td class="right">35</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">+10</td>
<td class="right">/2</td>
<td class="right">45</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">/2</td>
<td class="right">+10</td>
<td class="right">50</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">-20</td>
<td class="right">+10</td>
<td class="right">40</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">+10</td>
<td class="right">-20</td>
<td class="right">40</td>
</tr>
</tbody>
</table>

<p>
Whereas sequential operations can result in any permutation of
operations (for \(n!\) possibilites); interleaved operations, on the
other hand, can result (due to preëmption) in any power-permutation
of operations excluding the empty set (for \(\sum_{i=1}^n P_{n,i}\)
possibilities).
</p>

<p>
The new possibilities in the interleaved case are 30, 55, 60, 80,
90, 110.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Different values for <code>balance</code> given interleaved operations</caption>

<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">\(balance_0\)</th>
<th scope="col" class="right">\(op_0\)</th>
<th scope="col" class="right">\(op_1\)</th>
<th scope="col" class="left">\(op_2\)</th>
<th scope="col" class="right">\(balance_4\)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">50</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">110</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">80</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">+10</td>
<td class="left">&#xa0;</td>
<td class="right">60</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">-20</td>
<td class="left">&#xa0;</td>
<td class="right">30</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">/2</td>
<td class="left">&#xa0;</td>
<td class="right">55</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">-20</td>
<td class="left">&#xa0;</td>
<td class="right">90</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">/2</td>
<td class="left">&#xa0;</td>
<td class="right">40</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">+10</td>
<td class="left">&#xa0;</td>
<td class="right">90</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">-20</td>
<td class="left">/2</td>
<td class="right">45</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">+10</td>
<td class="right">/2</td>
<td class="left">-20</td>
<td class="right">35</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">+10</td>
<td class="left">/2</td>
<td class="right">45</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">-20</td>
<td class="right">/2</td>
<td class="left">+10</td>
<td class="right">50</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">-20</td>
<td class="left">+10</td>
<td class="right">40</td>
</tr>

<tr>
<td class="right">100</td>
<td class="right">/2</td>
<td class="right">+10</td>
<td class="left">-20</td>
<td class="right">40</td>
</tr>
</tbody>
</table>

<p>
The timing might look something this:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">Time</th>
<th scope="col" class="left">Bank</th>
<th scope="col" class="left">Peter</th>
<th scope="col" class="left">Paul</th>
<th scope="col" class="left">Mary</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">0</td>
<td class="left"><code>(get-balance) =&gt; 100</code></td>
<td class="left"><code>(get-balance) =&gt; 100</code></td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">&#xa0;</td>
<td class="left"><code>(set-balance! 90)</code></td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left"><code>(set-balance! 110)</code></td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left"><code>(get-balance) =&gt; 110</code></td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left"><code>(set-balance! 55)</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-sec-3-39" class="outline-3">
<h3 id="sec-3-39"><span class="section-number-3">3.39</span> <span class="done DONE">DONE</span> 3.39</h3>
<div class="outline-text-3" id="text-3-39">
<dl class="org-dl">
<dt> 101 </dt><dd>\(P_1\) sets \(x\) to 100, \(P_2\) increments \(x\) to 101.
</dd>
<dt> 100 </dt><dd>\(P_1\) accesses \(x\), \(P_2\) sets \(x\) to 11, \(P_1\) sets \(x\)
           to 100.
</dd>
<dt> 121 </dt><dd>\(P_2\) increments \(x\) to 11, \(P_1\) sets \(x\) to 121.
</dd>
</dl>
</div>
</div>
<div id="outline-container-sec-3-40" class="outline-3">
<h3 id="sec-3-40"><span class="section-number-3">3.40</span> <span class="done DONE">DONE</span> 3.40</h3>
<div class="outline-text-3" id="text-3-40">
<p>
If there are six atomic operations: <code>p1-access</code>, <code>p1-multiply</code>,
<code>p1-set!</code>, <code>p2-access</code>, <code>p2-multiply</code>, <code>p2-set!</code>; one can think of
this as an interleaving sequence problem where \(P_1 = \{access,
  multiply, set!\}\) and \(P_2 = \{access, multiply, multiply, set!\}\).
</p>

<p>
The <a href="http://math.stackexchange.com/questions/666288/number-of-ways-to-interleave-two-ordered-sequences">number of ways</a> to interleave the sequences are
\(\binom{|P_1| + |P_2|}{|P_1|} = 35\); we can simulate the order of
operations in the machine to see that the possibilities are 100,
1000, 10000, 100000, 1000000 and which sequences of operations
generate them.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use combinatorics srfi-69 srfi-95 vector-lib)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operations-set!</span> operations
                         combination
                         access
                         multiply
                         set!)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((access? #t)
             (combination combination))
    (unless (null? combination)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((operation (car combination)))
        (<span style="color: #00ffff; font-weight: bold;">cond</span> (access?
               (vector-set! operations operation access))
              ((null? (cdr combination))
               (vector-set! operations operation set!))
              (<span style="color: #00ffff; font-weight: bold;">else</span>
               (vector-set! operations operation multiply))))
      (iter #f (cdr combination)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">combination-&gt;operations</span> combinations combination)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((operations (make-vector 7))
        (anti-combination (lset-difference = combinations combination)))
    (operations-set! operations
                     (sort combination &lt;)
                     'p1-access
                     'p1-multiply
                     'p1-set!)
    (operations-set! operations
                     (sort anti-combination &lt;)
                     'p2-access
                     'p2-multiply
                     'p2-set!)
    operations))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply-operations</span> x operations)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((x1 #f)
        (x2 #f))
    (vector-for-each
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i operation)
       (<span style="color: #00ffff; font-weight: bold;">case</span> operation
         ((p1-access) (set! x1 x))
         ((p1-multiply) (set! x1 (* x1 x)))
         ((p1-set!) (set! x x1))
         ((p2-access) (set! x2 x))
         ((p2-multiply) (set! x2 (* x2 x)))
         ((p2-set!) (set! x x2))
         (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown operation"</span>))))
     operations))
  x)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((x-&gt;operations (make-hash-table))
      (combinations (iota 7)))
  (unordered-subset-for-each
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (combination)
     (<span style="color: #00ffff; font-weight: bold;">let</span> ((x 10))
       (<span style="color: #00ffff; font-weight: bold;">let*</span> ((operations
               (combination-&gt;operations combinations combination))
              (x (apply-operations x operations)))
         (hash-table-update!/default x-&gt;operations
                                     x
                                     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x-operations)
                                       (cons operations x-operations))
                                     '()))))
   combinations
   3)
  (sort (hash-table-&gt;alist x-&gt;operations) &lt; car))
</pre>
</div>

<p>
yields:
</p>

<div class="org-src-container">

<pre class="src src-scheme">((100
  #(p2-access p2-multiply p2-multiply p1-access p1-multiply p2-set! p1-set!)
  #(p2-access p2-multiply p1-access p2-multiply p1-multiply p2-set! p1-set!)
  #(p2-access p2-multiply p1-access p1-multiply p2-multiply p2-set! p1-set!)
  #(p2-access p1-access p2-multiply p2-multiply p1-multiply p2-set! p1-set!)
  #(p2-access p1-access p2-multiply p1-multiply p2-multiply p2-set! p1-set!)
  #(p2-access p1-access p1-multiply p2-multiply p2-multiply p2-set! p1-set!)
  #(p1-access p2-access p2-multiply p2-multiply p1-multiply p2-set! p1-set!)
  #(p1-access p2-access p2-multiply p1-multiply p2-multiply p2-set! p1-set!)
  #(p1-access p2-access p1-multiply p2-multiply p2-multiply p2-set! p1-set!)
  #(p1-access p1-multiply p2-access p2-multiply p2-multiply p2-set! p1-set!))
 (1000
  #(p2-access p2-multiply p2-multiply p1-access p1-multiply p1-set! p2-set!)
  #(p2-access p2-multiply p1-access p2-multiply p1-multiply p1-set! p2-set!)
  #(p2-access p2-multiply p1-access p1-multiply p2-multiply p1-set! p2-set!)
  #(p2-access p1-access p2-multiply p2-multiply p1-multiply p1-set! p2-set!)
  #(p2-access p1-access p2-multiply p1-multiply p2-multiply p1-set! p2-set!)
  #(p2-access p1-access p1-multiply p2-multiply p2-multiply p1-set! p2-set!)
  #(p1-access p2-access p2-multiply p2-multiply p1-multiply p1-set! p2-set!)
  #(p1-access p2-access p2-multiply p1-multiply p2-multiply p1-set! p2-set!)
  #(p1-access p2-access p1-multiply p2-multiply p2-multiply p1-set! p2-set!)
  #(p1-access p1-multiply p2-access p2-multiply p2-multiply p1-set! p2-set!))
 (10000
  #(p2-access p2-multiply p2-multiply p1-access p2-set! p1-multiply p1-set!)
  #(p2-access p2-multiply p1-access p2-multiply p2-set! p1-multiply p1-set!)
  #(p2-access p2-multiply p1-access p1-multiply p1-set! p2-multiply p2-set!)
  #(p2-access p1-access p2-multiply p2-multiply p2-set! p1-multiply p1-set!)
  #(p2-access p1-access p2-multiply p1-multiply p1-set! p2-multiply p2-set!)
  #(p2-access p1-access p1-multiply p2-multiply p1-set! p2-multiply p2-set!)
  #(p1-access p2-access p2-multiply p2-multiply p2-set! p1-multiply p1-set!)
  #(p1-access p2-access p2-multiply p1-multiply p1-set! p2-multiply p2-set!)
  #(p1-access p2-access p1-multiply p2-multiply p1-set! p2-multiply p2-set!)
  #(p1-access p1-multiply p2-access p2-multiply p1-set! p2-multiply p2-set!))
 (100000
  #(p2-access p1-access p1-multiply p1-set! p2-multiply p2-multiply p2-set!)
  #(p1-access p2-access p1-multiply p1-set! p2-multiply p2-multiply p2-set!)
  #(p1-access p1-multiply p2-access p1-set! p2-multiply p2-multiply p2-set!))
 (1000000
  #(p2-access p2-multiply p2-multiply p2-set! p1-access p1-multiply p1-set!)
  #(p1-access
    p1-multiply
    p1-set!
    p2-access
    p2-multiply
    p2-multiply
    p2-set!)))
</pre>
</div>

<p>
Serially, the only possibility is 1000000.
</p>
</div>
</div>
<div id="outline-container-sec-3-41" class="outline-3">
<h3 id="sec-3-41"><span class="section-number-3">3.41</span> <span class="todo TODO">TODO</span> 3.41</h3>
<div class="outline-text-3" id="text-3-41">
<p>
If there are processor-level interlocks on memory operations (where
it is impossible to read a value quicker than it is written),
accessing the balance unprotected balance should be ok.
</p>

<p>
TODO: Think about accessing balance in the middle of <code>withdraw</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3-42" class="outline-3">
<h3 id="sec-3-42"><span class="section-number-3">3.42</span> <span class="done DONE">DONE</span> 3.42</h3>
<div class="outline-text-3" id="text-3-42">
<p>
<a href="https://github.com/klutometis/sicp-chicken/blob/master/sicp-concurrency-core.scm">As implemented</a>, this is a safe change to make; <code>dynamic-wind</code> will
take care of the details.
</p>
</div>
</div>
<div id="outline-container-sec-3-43" class="outline-3">
<h3 id="sec-3-43"><span class="section-number-3">3.43</span> <span class="done DONE">DONE</span> 3.43</h3>
<div class="outline-text-3" id="text-3-43">
<p>
The only source of indeterminate results would be concurrent access
followed by out-of-order operations; with sequential access, the
balances $10, $20 and $30 should be preserved because access and
mutation are serialized.
</p>

<p>
Imagine something like <code>(exchange a1 a2), =(exchange a2 a3)</code> using
the first version of <code>exchange</code>:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">a1</th>
<th scope="col" class="left">a2</th>
<th scope="col" class="left">a3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">\(access_1\): 10</td>
<td class="left">\(access_1\): 20</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">\(access_2\): 20</td>
<td class="left">\(access_2\):30</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">\(set!_2\): 30</td>
<td class="left">\(set!_2\): 20</td>
</tr>

<tr>
<td class="left">\(set!_1\): 20</td>
<td class="left">\(set!_1\): 20</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
<p>
Since it calculates deltas, it should preserve cash-in, cash-out;
and, therefore, the totals will remain the same.
</p>

<p>
Imagine if it did not serialize the transactions on individual
accounts:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">a1</th>
<th scope="col" class="left">a2</th>
<th scope="col" class="left">a3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">\(access_1\): 10</td>
<td class="left">\(access_1\): 20</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">\(access_2\): 20</td>
<td class="left">\(access_2\):30</td>
</tr>

<tr>
<td class="left">\(set!_1\): 20</td>
<td class="left">\(set!_1\): 10</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">\(set!_2\): 30</td>
<td class="left">\(set!_2\): 20</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-sec-3-44" class="outline-3">
<h3 id="sec-3-44"><span class="section-number-3">3.44</span> <span class="done DONE">DONE</span> 3.44</h3>
<div class="outline-text-3" id="text-3-44">
<p>
One still has the same problem of interleaved access and setting as
<a href="#sec-3-43">3.43</a>, despite serialized deposit and withdraw; external
serialization is necessary like the implementation of <code>exchange</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3-45" class="outline-3">
<h3 id="sec-3-45"><span class="section-number-3">3.45</span> <span class="done DONE">DONE</span> 3.45</h3>
<div class="outline-text-3" id="text-3-45">
<p>
This results in deadlock: <code>serialized-exchange</code> grabs the mutices,
but so does <code>withdraw</code> and <code>deposit</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use test sicp-concurrency)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-account-and-serializer</span> balance)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">withdraw</span> amount)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt;= balance amount)
        (<span style="color: #00ffff; font-weight: bold;">begin</span> (set! balance (- balance amount)) balance)
        <span style="color: #00ff00;">"Insufficient funds"</span>))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deposit</span> amount)
    (set! balance (+ balance amount)) balance)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((balance-serializer (make-serializer)))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">dispatch</span> m)
      (<span style="color: #00ffff; font-weight: bold;">cond</span> ((eq? m 'withdraw) (balance-serializer withdraw))
            ((eq? m 'deposit) (balance-serializer deposit))
            ((eq? m 'balance) balance)
            ((eq? m 'serializer) balance-serializer)
            (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown request: MAKE-ACCOUNT"</span> m))))
    dispatch))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">exchange</span> account1 account2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((difference (- (account1 'balance)
                       (account2 'balance))))
    ((account1 'withdraw) difference)
    ((account2 'deposit) difference)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">serialized-exchange</span> account1 account2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((serializer1 (account1 'serializer))
        (serializer2 (account2 'serializer)))
    ((serializer1 (serializer2 exchange))
     account1
     account2)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((a1 (make-account-and-serializer 10))
      (a2 (make-account-and-serializer 10)))
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Deadlocks!</span>
  (test-error (serialized-exchange a1 a2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-46" class="outline-3">
<h3 id="sec-3-46"><span class="section-number-3">3.46</span> <span class="done DONE">DONE</span> 3.46</h3>
<div class="outline-text-3" id="text-3-46">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">p1</th>
<th scope="col" class="left">p2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><code>(car cell) =&gt; #t</code></td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left"><code>(car cell) =&gt; #t</code></td>
</tr>

<tr>
<td class="left"><code>(set-car! cell #f)</code></td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left"><code>(set-car! cell #f)</code></td>
</tr>

<tr>
<td class="left"><code>(apply p args)</code></td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left"><code>(apply p args)</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-sec-3-47" class="outline-3">
<h3 id="sec-3-47"><span class="section-number-3">3.47</span> <span class="done DONE">DONE</span> 3.47</h3>
<div class="outline-text-3" id="text-3-47">
<p>
Let’s use a mutex with a condition-variable to wake sleeping threads
(instead of e.g. idling and polling); we did not implement the
<code>test-and-set!</code> version, since we lack the equivalent of
MIT-Scheme’s <code>without-interrupts</code>.
</p>

<p>
The basic idea is that, if the capacity goes to 0, the thread sleeps
on the condition until a condition-variable broadcast wakes it up;
it then tries to re-acquire the semaphore (and so do all other
sleeping threads).<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<p>
If the capacity is positive, it decrements the capacity and proceeds
unhindered.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-concurrency srfi-18 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-semaphore</span> capacity)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((protect-capacity (make-mutex))
        (capacity-increased (make-condition-variable)))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">release!</span>)
      (with-mutex-locked protect-capacity
        (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
          (set! capacity (+ capacity 1))
          (condition-variable-broadcast! capacity-increased))))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">acquire!</span>)
      (mutex-lock! protect-capacity)
      (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? capacity)
          (<span style="color: #00ffff; font-weight: bold;">begin</span>
            (mutex-unlock! protect-capacity capacity-increased)
            (acquire!))
          (<span style="color: #00ffff; font-weight: bold;">begin</span>
            (set! capacity (- capacity 1))
            (mutex-unlock! protect-capacity))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (message)
      (<span style="color: #00ffff; font-weight: bold;">case</span> message
        ((release!) (release!))
        ((acquire!) (acquire!))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown message"</span> message))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">semaphore-acquire!</span> semaphore)
  (semaphore 'acquire!))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">semaphore-release!</span> semaphore)
  (semaphore 'release!))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">with-semaphore-acquired</span> semaphore thunk)
  (dynamic-wind
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (semaphore-acquire! semaphore))
      thunk
      (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (semaphore-release! semaphore))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((semaphore (make-semaphore 2))
      (result '()))
  (parallel-execute
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (with-semaphore-acquired semaphore
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
             (thread-sleep! 0.1)
             (set! result (cons 2 result)))))
   <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This should run last.</span>
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (with-semaphore-acquired semaphore
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
             (thread-sleep! 0.2)
             (test result '(1 2)))))
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (with-semaphore-acquired semaphore
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
             (set! result (cons 1 result)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-48" class="outline-3">
<h3 id="sec-3-48"><span class="section-number-3">3.48</span> <span class="done DONE">DONE</span> 3.48</h3>
<div class="outline-text-3" id="text-3-48">
<p>
There are four cases of locking order, two of which result in
deadlock:
</p>

<table id="tab:deadlock" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Locking order and deadlock</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">Scenario</th>
<th scope="col" class="left">\(Peter_1\)</th>
<th scope="col" class="left">\(Paul_1\)</th>
<th scope="col" class="left">\(Peter_2\)</th>
<th scope="col" class="left">\(Paul_2\)</th>
<th scope="col" class="left">Deadlock?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">\(a1\)</td>
<td class="left">\(a2\)</td>
<td class="left">\(a2\)</td>
<td class="left">\(a1\)</td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">\(a1\)</td>
<td class="left">\(a1\)</td>
<td class="left">\(a2\)</td>
<td class="left">\(a2\)</td>
<td class="left">No</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">\(a2\)</td>
<td class="left">\(a1\)</td>
<td class="left">\(a1\)</td>
<td class="left">\(a2\)</td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">\(a2\)</td>
<td class="left">\(a2\)</td>
<td class="left">\(a1\)</td>
<td class="left">\(a1\)</td>
<td class="left">No</td>
</tr>
</tbody>
</table>

<p>
Enforcing a locking order based on the account number constrains the
locking order to scenarios 2 and 4; we’ve implemented this by
sorting serializers by account number, composing them and finally
applying them to the accounts:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">serialized-exchange</span> account1 account2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((serializers (sort-serializers account1 account2)))
    (((apply compose serializers) exchange)
     account1
     account2)))
</pre>
</div>

<p>
Here is the complete code:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use data-structures sicp-concurrency srfi-95 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">current-account-number</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">exchange</span> account1 account2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((difference (- (account1 'balance)
                       (account2 'balance))))
    ((account1 'withdraw) difference)
    ((account2 'deposit) difference)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-account-and-serializer</span> balance)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">account-number</span>
    (current-account-number (+ (current-account-number) 1)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">withdraw</span> amount)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (&gt;= balance amount)
        (<span style="color: #00ffff; font-weight: bold;">begin</span> (set! balance (- balance amount))
               balance)
        <span style="color: #00ff00;">"Insufficient funds"</span>))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deposit</span> amount)
    (set! balance (+ balance amount))
    balance)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((balance-serializer (make-serializer)))
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">dispatch</span> m)
      (<span style="color: #00ffff; font-weight: bold;">cond</span> ((eq? m 'withdraw) withdraw)
            ((eq? m 'deposit) deposit)
            ((eq? m 'balance) balance)
            ((eq? m 'serializer) balance-serializer)
            ((eq? m 'account-number) account-number)
            (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown request: MAKE-ACCOUNT"</span> m))))
    dispatch))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">deposit</span> account amount)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((s (account 'serializer))
        (d (account 'deposit)))
    ((s d) amount)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">account-number</span> account)
  (account 'account-number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">serializer</span> account)
  (account 'serializer))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sort-accounts</span> accounts)
  (sort accounts &lt; account-number))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sort-serializers</span> . accounts)
  (<span style="color: #00ffff; font-weight: bold;">map</span> serializer (sort-accounts accounts)))

<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This works by sorting the serializers by account-number of the</span>
<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">adherent accounts, composing and finally applying them to the</span>
<span style="color: #ffff00;">;; </span><span style="color: #ffff00;">accounts.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">serialized-exchange</span> account1 account2)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((serializers (sort-serializers account1 account2)))
    (((apply compose serializers) exchange)
     account1
     account2)))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((peter (make-account-and-serializer 100))
      (paul (make-account-and-serializer 10)))
  (exchange peter paul)
  (test 10 (peter 'balance)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-49" class="outline-3">
<h3 id="sec-3-49"><span class="section-number-3">3.49</span> <span class="done DONE">DONE</span> 3.49</h3>
<div class="outline-text-3" id="text-3-49">
<p>
In the <a href="#sec-3-48">implementation above</a>, the account-numbers are constants whose
read-write interlocks are governed by the operating-system itself;
one could imagine a scenario, however, in which the account-numbers
can change and access to them needs to be serialized.
</p>

<p>
In such a scenario, the <a href="#tab:deadlock">deadlock table</a> still applies; but the
problem has been pushed one level higher.
</p>
</div>
</div>
<div id="outline-container-sec-3-50" class="outline-3">
<h3 id="sec-3-50"><span class="section-number-3">3.50</span> <span class="done DONE">DONE</span> 3.50</h3>
<div class="outline-text-3" id="text-3-50">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">stream-map</span> proc . argstreams)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (any stream-null? argstreams)
      stream-null
      (cons-stream
       (apply proc (<span style="color: #00ffff; font-weight: bold;">map</span> stream-car argstreams))
       (apply stream-map
              (cons proc (<span style="color: #00ffff; font-weight: bold;">map</span> stream-cdr argstreams))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((iota (stream-enumerate-interval 0 2))
      (kappa (stream-enumerate-interval 2 4)))
  (test '(0 3 8) (stream-&gt;list (stream-map * iota kappa))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-51" class="outline-3">
<h3 id="sec-3-51"><span class="section-number-3">3.51</span> <span class="done DONE">DONE</span> 3.51</h3>
<div class="outline-text-3" id="text-3-51">
<p>
Because the <code>car</code> of the stream is not lazy, <code>stream-map</code> generates
a 0; <code>(stream-ref x 5)</code> consumes the next four numbers (since 0 was
memoized), plus a non-lazy 5th (the <code>car</code> of the next cell); and
similarly <code>(stream-ref x 7)</code>: 0 through 5 are memoized, it consumes
6 plus the next one.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use ports sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">show</span> x) (display x) x)

(<span style="color: #00ffff; font-weight: bold;">let</span> ((x (make-parameter #f)))
  (test <span style="color: #00ff00;">"0"</span>
        (with-output-to-string
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
            (x (stream-map show (stream-enumerate-interval 0 10))))))
  (test <span style="color: #00ff00;">"12345"</span>
        (with-output-to-string
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (stream-ref (x) 5))))
  (test <span style="color: #00ff00;">"67"</span>
        (with-output-to-string
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (stream-ref (x) 7)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-52" class="outline-3">
<h3 id="sec-3-52"><span class="section-number-3">3.52</span> <span class="done DONE">DONE</span> 3.52</h3>
<div class="outline-text-3" id="text-3-52">
<p>
Since the first element of streams are non-lazy, <code>stream-map</code>
produces 1; <code>stream-filter</code> produces 6, since it eagerly evaluates
to the first even number and then one (i.e., it contains a
<code>cons-stream</code>); the second <code>stream-filter</code> produces 10 and stops
(i.e., it does not contains a <code>cons-stream</code>).
</p>

<p>
<code>(Stream-ref y 7)</code> consumes to 14, ignoring elements already
consumed (i.e., memoized); and <code>display-stream</code> consumes the rest.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sum</span> 0)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">accum</span> x) (set! sum (+ x sum)) sum)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">seq</span>
  (stream-map accum
              (stream-enumerate-interval 1 20)))

(test 1 sum)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (stream-filter even? seq))

(test 6 sum)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">z</span>
  (stream-filter (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (= (remainder x 5) 0))
                 seq))

(test 10 sum)

(stream-ref y 7)

(test 136 sum)

(display-stream z)

(test 210 sum)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-53" class="outline-3">
<h3 id="sec-3-53"><span class="section-number-3">3.53</span> <span class="done DONE">DONE</span> 3.53</h3>
<div class="outline-text-3" id="text-3-53">
<p>
The elements of the stream should be powers of two, e.g. \(1, 2, 4,
  8, ..., n^2\).
</p>

<p>
The first element is one; the second is one plus one; the third, one
plus one plus one plus one; etc.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-streams</span> s1 s2) (stream-map + s1 s2))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">s</span> (cons-stream 1 (add-streams s s)))

(test '(1 2 4 8) (stream-&gt;list s 4))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-54" class="outline-3">
<h3 id="sec-3-54"><span class="section-number-3">3.54</span> <span class="done DONE">DONE</span> 3.54</h3>
<div class="outline-text-3" id="text-3-54">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-streams</span> s1 s2) (stream-map * s1 s2))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">factorial</span>
  (cons-stream 1 (mul-streams factorial integers)))

(test '(1 1 2 6 24 120) (stream-&gt;list factorial 6))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-55" class="outline-3">
<h3 id="sec-3-55"><span class="section-number-3">3.55</span> <span class="done DONE">DONE</span> 3.55</h3>
<div class="outline-text-3" id="text-3-55">
<p>
Interestingly, this is not correct (where the precedence of
<code>partial-sums</code> over <code>add-streams</code> has been swapped in the
recursion):
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">partial-sums</span> stream)
  (cons-stream (stream-car stream)
               (partial-sums (add-streams (stream-cdr stream)
                                          stream))))
</pre>
</div>

<p>
It yields instead <code>(1 3 8 20 48)</code>; why?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">partial-sums</span> stream)
  (cons-stream (stream-car stream)
               (add-streams (stream-cdr stream)
                            (partial-sums stream))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"partial-sums.scm"</span>)

(test '(1 3 6 10 15)
      (stream-&gt;list (partial-sums integers) 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-56" class="outline-3">
<h3 id="sec-3-56"><span class="section-number-3">3.56</span> <span class="done DONE">DONE</span> 3.56</h3>
<div class="outline-text-3" id="text-3-56">
<p>
<a href="http://en.wikipedia.org/wiki/Regular_number">Regular numbers</a>, e.g. Hamming numbers; also \(k\)-smooth, where \(k =
  5\). See <a href="http://www.cs.utexas.edu/users/EWD/ewd07xx/EWD792.PDF">Dijkstra's solution</a>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">hamming-numbers</span>
  (cons-stream 1 (merge (scale-stream hamming-numbers 2)
                        (merge (scale-stream hamming-numbers 3)
                               (scale-stream hamming-numbers 5)))))

(test '(1 2 3 4 5 6 8 9 10 12 15 16 18 20 24 25 27 30 32 36)
      (stream-&gt;list hamming-numbers 20))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-57" class="outline-3">
<h3 id="sec-3-57"><span class="section-number-3">3.57</span> <span class="done DONE">DONE</span> 3.57</h3>
<div class="outline-text-3" id="text-3-57">
<p>
<code>Fibs</code> provides 0 and 1; and every subsequent call thereafter to
<code>add-streams</code> only does one new addition on <code>(stream-cdr fibs)</code>, the
rest are memoized.
</p>

<p>
For the \(n^th\) Fibonacci number, therefore, there are \(n - 1\)
additions; an unmemoized Fibonacci would suffer the same exponential
complexity as the naïve recursive formulation.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">additions</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add</span> x y) (additions (+ (additions) 1))
  (+ x y))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-streams</span> s1 s2) (stream-map add s1 s2))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">fibs</span>
  (cons-stream
   0
   (cons-stream 1 (add-streams (stream-cdr fibs) fibs))))

(stream-&gt;list fibs 10)

(test 9 (additions))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-58" class="outline-3">
<h3 id="sec-3-58"><span class="section-number-3">3.58</span> <span class="done DONE">DONE</span> 3.58</h3>
<div class="outline-text-3" id="text-3-58">
<p>
<code>Expand</code> is the decimal expansion in some radix of
\(\frac{num}{den}\); it works by consing the quotient (like a <code>car</code>)
to the remainder (like a <code>cdr</code>) recursively.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">expand</span> num den radix)
  (cons-stream
   (quotient (* num radix) den)
   (expand (remainder (* num radix) den) den radix)))

(test '(1 4 2 8 5 7 1 4 2 8 5 7)
      (stream-&gt;list (expand 1 7 10) 12))
(test '(3 7 5 0 0 0 0)
      (stream-&gt;list (expand 3 8 10) 7))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-59" class="outline-3">
<h3 id="sec-3-59"><span class="section-number-3">3.59</span> <span class="done DONE">DONE</span> 3.59</h3>
<div class="outline-text-3" id="text-3-59">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integrate-series</span> coefficients)
  (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (integral coefficient)
                (* (/ 1 integral) coefficient))
              integers
              coefficients))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"integrate-series.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">ones</span> (cons-stream 1 ones))

(test '(1 1/2 1/3 1/4 1/5)
      (stream-&gt;list (integrate-series ones) 5))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"integrate-series.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">cosine-series</span>
  (cons-stream 1 (stream-map - (integrate-series sine-series))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sine-series</span>
  (cons-stream 0 (integrate-series cosine-series)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use numbers sicp-streams test)

(include <span style="color: #00ff00;">"trig-series.scm"</span>)

(test '(1 0 -1/2 0 1/24) (stream-&gt;list cosine-series 5))
(test '(0 1 0 -1/6 0) (stream-&gt;list sine-series 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-60" class="outline-3">
<h3 id="sec-3-60"><span class="section-number-3">3.60</span> <span class="done DONE">DONE</span> 3.60</h3>
<div class="outline-text-3" id="text-3-60">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">mul-series</span> s1 s2)
  (cons-stream (* (stream-car s1) (stream-car s2))
               (add-streams
                (scale-stream (stream-cdr s2) (stream-car s1))
                (mul-series (stream-cdr s1) s2))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)
(include <span style="color: #00ff00;">"mul-series.scm"</span>)
(include <span style="color: #00ff00;">"trig-series.scm"</span>)

(test 1.0
      (apply
       +
       (stream-&gt;list
        (add-streams (mul-series sine-series sine-series)
                     (mul-series cosine-series cosine-series))
        10)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-61" class="outline-3">
<h3 id="sec-3-61"><span class="section-number-3">3.61</span> <span class="done DONE">DONE</span> 3.61</h3>
<div class="outline-text-3" id="text-3-61">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"mul-series.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">invert-unit-series</span> series)
  (cons-stream 1 (stream-map - (mul-series (stream-cdr series)
                                           (invert-unit-series series)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"invert-unit-series.scm"</span>)
(include <span style="color: #00ff00;">"mul-series.scm"</span>)
(include <span style="color: #00ff00;">"trig-series.scm"</span>)

(test 1.0
      (apply +
             (stream-&gt;list (mul-series cosine-series
                                       (invert-unit-series cosine-series))
                           5)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-62" class="outline-3">
<h3 id="sec-3-62"><span class="section-number-3">3.62</span> <span class="done DONE">DONE</span> 3.62</h3>
<div class="outline-text-3" id="text-3-62">
<p>
Since \(\tan \theta = \frac{\sin \theta}{\cos \theta}\); and since the
<a href="http://en.wikipedia.org/wiki/Taylor_series#List_of_Maclaurin_series_of_some_common_functions">Maclaurin series of tan</a> is \(x + \frac{x^3}{3} + \frac{2x^5}{15} +
  \dots\):
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"mul-series.scm"</span>)
(include <span style="color: #00ff00;">"invert-unit-series.scm"</span>)
(include <span style="color: #00ff00;">"trig-series.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">div-series</span> s1 s2)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? (stream-car s2))
      (error <span style="color: #00ff00;">"Division by zero: DIV-SERIES"</span>)
      (mul-series s1 (invert-unit-series s2))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">tan-series</span> (div-series sine-series cosine-series))

(parameterize ((current-test-epsilon 0.001))
  (test
   (tan 1)
   (apply + (stream-&gt;list tan-series 16))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-63" class="outline-3">
<h3 id="sec-3-63"><span class="section-number-3">3.63</span> <span class="done DONE">DONE</span> 3.63</h3>
<div class="outline-text-3" id="text-3-63">
<p>
<code>Guesses</code> is a recursive stream that itself depends upon <code>guesses</code>;
this gives <code>memo-proc</code> a chance to reify the stream, which would not
be the case of it called <code>sqrt-stream</code> again.
</p>
</div>
</div>
<div id="outline-container-sec-3-64" class="outline-3">
<h3 id="sec-3-64"><span class="section-number-3">3.64</span> <span class="done DONE">DONE</span> 3.64</h3>
<div class="outline-text-3" id="text-3-64">
<p>
Contrary to the footnote in SICP, it’s possible to use <code>letrec</code>
instead of <code>define</code> in <code>sqrt-stream</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">stream-limit</span> stream tolerance)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((car (stream-car stream))
             (cdr (stream-cdr stream))
             (iterations 0))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((cadr (stream-car cdr)))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (&lt; (abs (- cadr car)) tolerance)
          (values cadr iterations)
          (iter cadr (stream-cdr cdr) (+ iterations 1))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-streams test)

(include <span style="color: #00ff00;">"stream-limit.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-improve</span> guess x)
  (average guess (/ x guess)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sqrt-stream</span> x)
  (<span style="color: #00ffff; font-weight: bold;">letrec</span> ((guesses
            (cons-stream 1.0
                         (stream-map
                          (<span style="color: #00ffff; font-weight: bold;">lambda</span> (guess) (sqrt-improve guess x))
                          guesses))))
    guesses))

(test (sqrt 2) (stream-limit (sqrt-stream 2) 0.001))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-65" class="outline-3">
<h3 id="sec-3-65"><span class="section-number-3">3.65</span> <span class="done DONE">DONE</span> 3.65</h3>
<div class="outline-text-3" id="text-3-65">
<p>
It takes seven iterations to get to within \(10e-14\) of \(\ln 2\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-streams test)

(include <span style="color: #00ff00;">"partial-sums.scm"</span>)
(include <span style="color: #00ff00;">"stream-limit.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">ln2-summands</span> n)
  (cons-stream (/ 1.0 n)
               (stream-map - (ln2-summands (+ n 1)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">ln2-stream</span>
  (partial-sums (ln2-summands 1)))

(receive (ln2 iterations)
  (stream-limit
   (accelerated-sequence euler-transform ln2-stream) 1e-14)
  (test ln2 (log 2))
  (test 7 iterations))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-66" class="outline-3">
<h3 id="sec-3-66"><span class="section-number-3">3.66</span> <span class="todo TODO">TODO</span> 3.66</h3>
<div class="outline-text-3" id="text-3-66">
<p>
Each row \(i\) (\(R_i\)) of the matrix grows by \(\log^i_2 |R_0|\); such
that, for instance, if \(R_0\) grows by \(n\) (i.e., \(\log^0_2 |R_0|\)),
row \(i\) grows by \(\log^i_2 n\).
</p>

<p>
Here are the first fifteen elements up to <code>(3 3)</code>:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />
</colgroup>

<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="right">0</th>
<th scope="col" class="right">1</th>
<th scope="col" class="right">2</th>
<th scope="col" class="right">3</th>
<th scope="col" class="right">4</th>
<th scope="col" class="right">5</th>
<th scope="col" class="right">6</th>
<th scope="col" class="right">7</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">0</td>
<td class="right">1</td>
<td class="right">2</td>
<td class="right">4</td>
<td class="right">6</td>
<td class="right">8</td>
<td class="right">10</td>
<td class="right">12</td>
<td class="right">14</td>
</tr>

<tr>
<td class="right">1</td>
<td class="right">&#xa0;</td>
<td class="right">3</td>
<td class="right">5</td>
<td class="right">9</td>
<td class="right">13</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">7</td>
<td class="right">11</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">15</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="right">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
For a pair \((x, y)\), there are \(\max(x, \log_2 y)\) number of rows;
the total number of elements is at least \(\sum_{i=0}^{\max(x, \log_2
  y) - 1} 2^i\).
</p>

<p>
This is, incidentally, an exact guess for the number of pairs
preceding a diagonal.
</p>

<p>
TODO: It would be nice to get a better bound for non-diagonals!
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams srfi-1 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">stream-index</span> pred . streams)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((index 0)
             (streams streams))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (any stream-null? streams)
        #f
        (<span style="color: #00ffff; font-weight: bold;">if</span> (apply pred (<span style="color: #00ffff; font-weight: bold;">map</span> stream-car streams))
            index
            (iter (+ index 1) (<span style="color: #00ffff; font-weight: bold;">map</span> stream-cdr streams))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pair-index</span> pair stream)
  (stream-index (cute equal? &lt;&gt; pair) stream))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">lower-bound</span> pair)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((x (car pair))
        (y (cadr pair)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((row (- (max x (/ (log y) (log 2))) 1))
               (lower-bound 0))
      (<span style="color: #00ffff; font-weight: bold;">if</span> (<span style="color: #00ffff; font-weight: bold;">or</span> (zero? row) (negative? row))
          (inexact-&gt;exact (floor lower-bound))
          (iter (- row 1) (+ lower-bound (expt 2 row)))))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((integer-pairs (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (pairs integers integers))))
  (test '((1 1) (1 2) (2 2) (1 3) (2 3) (1 4) (3 3) (1 5)
          (2 4) (1 6) (3 4) (1 7) (2 5) (1 8) (4 4))
    (stream-&gt;list (integer-pairs) 15))

  (test <span style="color: #00ff00;">"The lower bound is exact on diagonals"</span>
        (pair-index '(10 10) (integer-pairs))
        (lower-bound '(10 10)))

  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">For the case where y = 10.</span>
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((pair-indexes
         (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (pair-index (list x 10) (integer-pairs)))
              (iota 10 1)))
        (lower-bounds
         (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (lower-bound (list x 10)))
              (iota 10 1))))
    (test
     pair-indexes
     '(17 32 58 102 174 286 446 638 766 1022))

    (test
     lower-bounds
     '(8 8 8 14 30 62 126 254 510 1022))

    (test-assert (every &lt;= lower-bounds pair-indexes))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-67" class="outline-3">
<h3 id="sec-3-67"><span class="section-number-3">3.67</span> <span class="done DONE">DONE</span> 3.67</h3>
<div class="outline-text-3" id="text-3-67">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">all-pairs</span> s t)
  (cons-stream
   (list (stream-car s) (stream-car t))
   (interleave
    (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (list (stream-car s) x))
                (stream-cdr t))
    (interleave
     (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (y) (list (stream-car t) y))
                 (stream-cdr s))
     (all-pairs (stream-cdr s) (stream-cdr t))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">stream-index</span> pred . streams)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((index 0)
             (streams streams))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (any stream-null? streams)
        #f
        (<span style="color: #00ffff; font-weight: bold;">if</span> (apply pred (<span style="color: #00ffff; font-weight: bold;">map</span> stream-car streams))
            index
            (iter (+ index 1) (<span style="color: #00ffff; font-weight: bold;">map</span> stream-cdr streams))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pair-index</span> pair stream)
  (stream-index (cute equal? &lt;&gt; pair) stream))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((pairs (all-pairs integers integers)))
   (test 17 (pair-index '(1 10) pairs))
   (test 64 (pair-index '(2 10) pairs))
   (test 228 (pair-index '(3 10) pairs)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-68" class="outline-3">
<h3 id="sec-3-68"><span class="section-number-3">3.68</span> <span class="done DONE">DONE</span> 3.68</h3>
<div class="outline-text-3" id="text-3-68">
<p>
Louis’s definition of <code>pairs</code> goes into an infinite recursion with
<code>(pairs integers integers)</code>, since the recursive case forces the
streams.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pairs</span> s t)
  (interleave
   (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (list (stream-car s) x))
               t)
   (pairs (stream-cdr s) (stream-cdr t))))

(test-assert (not (terminates? (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (pairs integers integers)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-69" class="outline-3">
<h3 id="sec-3-69"><span class="section-number-3">3.69</span> <span class="done DONE">DONE</span> 3.69</h3>
<div class="outline-text-3" id="text-3-69">
<p>
The third element of the triples is still generated much more
quickly than the first two; is there a way to homogenize them?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp sicp-streams test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">triples</span> s t u)
  (cons-stream (list (stream-car s) (stream-car t) (stream-car u))
               (interleave
                (interleave
                 <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Generate along x.</span>
                 (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (z) (list (stream-car s)
                                          (stream-car t)
                                          z))
                             (stream-cdr u))
                 <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Generate along x and y.</span>
                 (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (pair)
                               (list (stream-car s)
                                     (car pair)
                                     (cadr pair)))
                             (pairs (stream-cdr t)
                                    (stream-cdr u))))
                (triples (stream-cdr s)
                         (stream-cdr t)
                         (stream-cdr u)))))

(test '((3 4 5) (6 8 10) (5 12 13))
      (stream-&gt;list
       (stream-filter
        (bind-lambda (i j k)
                (= (+ (square i) (square j)) (square k)))
        (triples integers integers integers))
       3))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-70" class="outline-3">
<h3 id="sec-3-70"><span class="section-number-3">3.70</span> <span class="done DONE">DONE</span> 3.70</h3>
<div class="outline-text-3" id="text-3-70">
<p>
We borrowed the definition of Hamming numbers from <a href="#sec-3-56">3.56</a>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">weighted-merge</span> weight s1 s2)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((stream-null? s1) s2)
        ((stream-null? s2) s1)
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((s1car (stream-car s1))
               (s2car (stream-car s2)))
           (<span style="color: #00ffff; font-weight: bold;">cond</span> ((&lt; (weight s1car) (weight s2car))
                  (cons-stream
                   s1car
                   (weighted-merge weight (stream-cdr s1) s2)))
                 (<span style="color: #00ffff; font-weight: bold;">else</span>
                  (cons-stream
                   s2car
                   (weighted-merge weight s1 (stream-cdr s2)))))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">weighted-pairs</span> weight s t)
  (cons-stream
   (list (stream-car s) (stream-car t))
   (weighted-merge
    weight
    (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (list (stream-car s) x))
                (stream-cdr t))
    (weighted-pairs weight (stream-cdr s) (stream-cdr t)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp-streams srfi-1 test)

(include <span style="color: #00ff00;">"weighted-pairs.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-weighted-pairs</span> weight pairs)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((pairs (stream-&gt;list pairs 16)))
    (every (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2) (&lt;= (weight p1) (weight p2)))
         pairs
         (cdr pairs))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((addition-weight (cut apply + &lt;&gt;))
       (addition-weighted-integer-pairs
        (weighted-pairs addition-weight integers integers)))
  (test-assert (test-weighted-pairs
                addition-weight
                addition-weighted-integer-pairs))
  (test '((1 1) (1 2) (2 2) (1 3) (2 3) (1 4) (3 3) (2 4) (1 5) (3 4) (2 5)
          (1 6) (4 4) (3 5) (2 6) (1 7))
        (stream-&gt;list addition-weighted-integer-pairs 16)))

(<span style="color: #00ffff; font-weight: bold;">letrec</span> ((hamming-numbers
          (cons-stream 1 (merge (scale-stream hamming-numbers 2)
                                (merge (scale-stream hamming-numbers 3)
                                       (scale-stream hamming-numbers 5))))))
  (<span style="color: #00ffff; font-weight: bold;">let*</span> ((weight (bind-lambda (i j) (+ (* 2 i) (* 3 j) (* 5 i j))))
         (weighted-hamming-pairs
          (weighted-pairs weight hamming-numbers hamming-numbers)))
    (test-assert (test-weighted-pairs weight weighted-hamming-pairs))
    (test '((1 1) (1 2) (1 3) (2 2) (1 4) (1 5) (2 3) (1 6) (2 4) (3 3)
            (1 8) (2 5) (1 9) (3 4) (2 6) (1 10))
          (stream-&gt;list weighted-hamming-pairs 16))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-71" class="outline-3">
<h3 id="sec-3-71"><span class="section-number-3">3.71</span> <span class="done DONE">DONE</span> 3.71</h3>
<div class="outline-text-3" id="text-3-71">
<p>
We had to resort to some type-puns to get around the fact that we
don’t have a multi-value <code>stream-filter</code> (a <code>stream-map</code>, namely,
that either returns the first of equals pairs or <code>#f</code>).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)
(include <span style="color: #00ff00;">"weighted-pairs.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((weight (bind-lambda (i j) (+ (expt i 3) (expt j 3))))
       (weighted-pairs (stream-map weight (weighted-pairs weight integers integers))))
  (test '(1729 4104 13832 20683 32832 39312)
        (stream-&gt;list
         (stream-filter
          identity
          (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (<span style="color: #00ffff; font-weight: bold;">and</span> (= x y) x))
                      weighted-pairs
                      (stream-cdr weighted-pairs)))
         6)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-72" class="outline-3">
<h3 id="sec-3-72"><span class="section-number-3">3.72</span> <span class="done DONE">DONE</span> 3.72</h3>
<div class="outline-text-3" id="text-3-72">
<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)
(include <span style="color: #00ff00;">"weighted-pairs.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square-pair</span> p)
  (+ (square (car p))
     (square (cadr p))))

(<span style="color: #00ffff; font-weight: bold;">let*</span> ((weight (bind-lambda (i j) (+ (expt i 2) (expt j 2))))
       (weighted-pairs (weighted-pairs weight integers integers)))
  (test '(((10 15) (6 17) (1 18))
          ((13 16) (8 19) (5 20))
          ((17 19) (11 23) (5 25))
          ((14 23) (10 25) (7 26))
          ((19 22) (13 26) (2 29))
          ((15 25) (11 27) (3 29)))
        (stream-&gt;list
         (stream-filter
          identity
          (stream-map (<span style="color: #00ffff; font-weight: bold;">lambda</span> (p1 p2 p3)
                        (<span style="color: #00ffff; font-weight: bold;">and</span> (= (square-pair p1)
                                (square-pair p2))
                             (= (square-pair p2)
                                (square-pair p3))
                             (list p1 p2 p3)))
                      weighted-pairs
                      (stream-cdr weighted-pairs)
                      (stream-cdr (stream-cdr weighted-pairs))))
         6)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-73" class="outline-3">
<h3 id="sec-3-73"><span class="section-number-3">3.73</span> <span class="done DONE">DONE</span> 3.73</h3>
<div class="outline-text-3" id="text-3-73">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integral</span> integrand initial-value dt)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">int</span>
    (cons-stream initial-value
                 (add-streams (scale-stream integrand dt)
                              int)))
  int)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">RC</span> R C dt)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i v0)
    (add-streams (scale-stream i R)
                 (integral (scale-stream i (/ 1 C))
                           v0
                           dt))))

(<span style="color: #00ffff; font-weight: bold;">let</span> ((RC1 (RC 5 1 0.5)))
  (test '(5 10.5 16.5 23.0 30.0 37.5)
        (stream-&gt;list (RC1 integers 0) 6)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-74" class="outline-3">
<h3 id="sec-3-74"><span class="section-number-3">3.74</span> <span class="done DONE">DONE</span> 3.74</h3>
<div class="outline-text-3" id="text-3-74">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sign-change-detector</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">or</span> (zero? x)
             (zero? y)
             (= (signum x) (signum y))) 0)
        ((positive? y) 1)
        (<span style="color: #00ffff; font-weight: bold;">else</span> -1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sense-data</span>
  (list-&gt;stream '(1 2 1.5 1 0.5 -0.1 -2 -3 -2 -0.5 0.2 3 4)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">zero-crossings</span>
  (stream-map sign-change-detector sense-data (stream-cdr sense-data)))

(test '(0 0 0 0 -1 0 0 0 0 1 0 0) (stream-&gt;list zero-crossings))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-75" class="outline-3">
<h3 id="sec-3-75"><span class="section-number-3">3.75</span> <span class="done DONE">DONE</span> 3.75</h3>
<div class="outline-text-3" id="text-3-75">
<p>
Let’s use a <a href="http://en.wikipedia.org/wiki/Moving_average#Simple_moving_average">simple</a> moving average with \(n = 2\).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sign-change-detector</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">or</span> (zero? x) (zero? y) (= (signum x) (signum y))) 0)
        ((positive? y) 1)
        (<span style="color: #00ffff; font-weight: bold;">else</span> -1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sense-data</span>
  (list-&gt;stream '(1 2 1.5 1 0.5 -0.1 -2 -3 -2 -0.5 0.2 3 4)))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Using simple moving average</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-zero-crossings</span> input-stream last-value last-last-value)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (stream-null? input-stream)
      stream-null
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((avpt (+ last-value (/ (- (stream-car input-stream) last-last-value) 2))))
        (cons-stream
         (sign-change-detector last-value avpt)
         (make-zero-crossings
          (stream-cdr input-stream)
          avpt
          last-value)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">zero-crossings</span>
  (make-zero-crossings sense-data 0 0))

(test '(0 0 0 0 0 0 -1 0 0 0 0 1 0)
      (stream-&gt;list zero-crossings))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-76" class="outline-3">
<h3 id="sec-3-76"><span class="section-number-3">3.76</span> <span class="done DONE">DONE</span> 3.76</h3>
<div class="outline-text-3" id="text-3-76">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sign-change-detector</span> x y)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((<span style="color: #00ffff; font-weight: bold;">or</span> (zero? x) (zero? y) (= (signum x) (signum y))) 0)
        ((positive? y) 1)
        (<span style="color: #00ffff; font-weight: bold;">else</span> -1)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">sense-data</span>
  (list-&gt;stream '(1 2 1.5 1 0.5 -0.1 -2 -3 -2 -0.5 0.2 3 4)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">smooth</span>
  (case-lambda ((stream) (smooth stream 0 0))
          ((stream last-value last-last-value)
           (<span style="color: #00ffff; font-weight: bold;">if</span> (stream-null? stream)
               stream
               (<span style="color: #00ffff; font-weight: bold;">let</span> ((value (+ last-value (/ (- (stream-car stream) last-last-value) 2))))
                 (cons-stream value
                              (smooth (stream-cdr stream) value last-value)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-zero-crossings</span> sense-data)
  (stream-map sign-change-detector sense-data (stream-cdr sense-data)))

(test '(0 0 0 0 0 -1 0 0 0 0 1 0)
      (stream-&gt;list (make-zero-crossings (smooth sense-data))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-77" class="outline-3">
<h3 id="sec-3-77"><span class="section-number-3">3.77</span> <span class="done DONE">DONE</span> 3.77</h3>
<div class="outline-text-3" id="text-3-77">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integral</span> delayed-integrand initial-value dt)
  (cons-stream
   initial-value
   (<span style="color: #00ffff; font-weight: bold;">let</span> ((integrand (<span style="color: #00ffff; font-weight: bold;">force</span> delayed-integrand)))
     (<span style="color: #00ffff; font-weight: bold;">if</span> (stream-null? integrand)
         stream-null
         (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> (stream-cdr integrand))
                   (+ (* dt (stream-car integrand))
                      initial-value)
                   dt)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">solve</span> f y0 dt)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> dy) y0 dt))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dy</span> (stream-map f y))
  y)

(parameterize ((current-test-epsilon 0.001))
  (test 2.71828 (stream-ref (solve identity 1 0.001) 1000)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-78" class="outline-3">
<h3 id="sec-3-78"><span class="section-number-3">3.78</span> <span class="done DONE">DONE</span> 3.78</h3>
<div class="outline-text-3" id="text-3-78">
<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"add-streams.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">integral</span> delayed-integrand initial-value dt)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">int</span>
    (cons-stream
     initial-value
     (<span style="color: #00ffff; font-weight: bold;">let</span> ((integrand (<span style="color: #00ffff; font-weight: bold;">force</span> delayed-integrand)))
       (add-streams (scale-stream integrand dt) int))))
  int)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)
(include <span style="color: #00ff00;">"integral.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">solve-2nd</span> a b dt y0 dy0)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> dy) y0 dt))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dy</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> ddy) dy0 dt))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">ddy</span> (add-streams (scale-stream dy a)
                           (scale-stream y b)))
  y)

(test
 0.00316658406372682
 (stream-ref (solve-2nd -1 -1 0.001 1 1) 10000))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-79" class="outline-3">
<h3 id="sec-3-79"><span class="section-number-3">3.79</span> <span class="done DONE">DONE</span> 3.79</h3>
<div class="outline-text-3" id="text-3-79">
<div class="org-src-container">

<pre class="src src-scheme">(use sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)
(include <span style="color: #00ff00;">"integral.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">solve-2nd</span> f dt y0 dy0)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> dy) y0 dt))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dy</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> ddy) dy0 dt))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">ddy</span> (stream-map f dy y))
  y)

(test
 -47.2046483923628
 (stream-ref (solve-2nd - 0.001 1 1) 10000))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-80" class="outline-3">
<h3 id="sec-3-80"><span class="section-number-3">3.80</span> <span class="done DONE">DONE</span> 3.80</h3>
<div class="outline-text-3" id="text-3-80">
<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp-streams test)

(include <span style="color: #00ff00;">"add-streams.scm"</span>)
(include <span style="color: #00ff00;">"integral.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">RLC</span> R C L dt)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (vC0 iL0)
    (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">vC</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> dvC) vC0 dt))
    (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">iL</span> (integral (<span style="color: #00ffff; font-weight: bold;">delay</span> diL) iL0 dt))
    (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">diL</span> (add-streams (scale-stream iL (/ (- R) L))
                             (scale-stream vC (/ (- 1) L))))
    (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dvC</span> (scale-stream iL (/ -1 C)))
    (cons vC iL)))

(bind-let (((vC . iL) ((RLC 1 0.2 1 0.1) 10 0)))
          (test 14.6445 (stream-ref vC 5))
          (test -4.5491 (stream-ref iL 5)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-81" class="outline-3">
<h3 id="sec-3-81"><span class="section-number-3">3.81</span> <span class="done DONE">DONE</span> 3.81</h3>
<div class="outline-text-3" id="text-3-81">
<div class="org-src-container">

<pre class="src src-scheme">(use numbers)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">Use Knuth's; see</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;"><a href="http://en.wikipedia.org/wiki/Linear_congruential_generator">&lt;http://en.wikipedia.org/wiki/Linear_congruential_generator&gt;</a>.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">modulus</span> (make-parameter (expt 2 64)))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">multiplier</span> (make-parameter 6364136223846793005))
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">increment</span> (make-parameter 1442695040888963407))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">rand-update</span> x)
  (modulo (+ (* (multiplier) x) (increment)) (modulus)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use numbers sicp-streams test)

(include <span style="color: #00ff00;">"rand-update.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">random-init</span> (make-parameter 0))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">random-number-stream</span>
  (case-lambda
   ((requests) (random-number-stream requests (random-init)))
   ((requests seed)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (stream-null? requests)
        stream-null
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((request (stream-car requests)))
          (bind-case
           request
           ((reset seed)
            (cons-stream
             seed
             (random-number-stream (stream-cdr requests) seed)))
           (generate
            (<span style="color: #00ffff; font-weight: bold;">let</span> ((next (rand-update seed)))
              (cons-stream
               next
               (random-number-stream (stream-cdr requests) next))))))))))

(parameterize ((random-init 5))
  (test '(14816632086413376816
          2587011477941047999
          5
          14816632086413376816
          2587011477941047999)
        (stream-&gt;list
         (random-number-stream
          (list-&gt;stream
           '(generate
             generate
             (reset 5)
             generate
             generate))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-82" class="outline-3">
<h3 id="sec-3-82"><span class="section-number-3">3.82</span> <span class="done DONE">DONE</span> 3.82</h3>
<div class="outline-text-3" id="text-3-82">
<div class="org-src-container">

<pre class="src src-scheme">(use numbers random-bsd sicp sicp-streams test)

(include <span style="color: #00ff00;">"stream-map.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">random-in-range</span> low high)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((range (- high low)))
    (+ low (* (random-real) range))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-random-numbers</span> low high)
  (cons-stream (random-in-range low high)
               (make-random-numbers low high)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">pi-predicate</span> x y)
  (&lt;= (+ (square (- 1 x))
         (square (- 1 y)))
      1))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-integral-stream</span> predicate x1 x2 y1 y2)
  (stream-map
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x y) (predicate x y))
   (make-random-numbers x1 x2)
   (make-random-numbers y1 y2)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">monte-carlo</span> experiment-stream passed failed)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">next</span> passed failed)
    (cons-stream
     (/ passed (+ passed failed))
     (monte-carlo
      (stream-cdr experiment-stream) passed failed)))
  (<span style="color: #00ffff; font-weight: bold;">if</span> (stream-car experiment-stream)
      (next (+ passed 1) failed)
      (next passed (+ failed 1))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">estimate-integral</span> predicate x1 x2 y1 y2)
  (monte-carlo (make-integral-stream predicate x1 x2 y1 y2) 0 0))

(parameterize ((current-test-epsilon 0.01))
  (test
   3.14
   (exact-&gt;inexact
    (* 4 (stream-ref (estimate-integral pi-predicate 0 1 0 1) 10000)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Chapter 4</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> 4.1</h3>
<div class="outline-text-3" id="text-4-1">
<p>
First, let’s come up with a definition of <code>cons-right</code> to test
right-order evaluation; at that point, enforcing the order of
evaluation is possible by touch the first expression (left) or the
rest-expressions (right).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings ports sicp-eval test)

(<span style="color: #00ffff; font-weight: bold;">define-macro</span> (<span style="color: #ffff00;">cons-right</span> a d)
  `(<span style="color: #00ffff; font-weight: bold;">let</span> ((d ,d) (a ,a)) (cons a d)))

(test <span style="color: #00ff00;">"Right-eval cons"</span>
      <span style="color: #00ff00;">"21"</span>
      (with-output-to-string
        (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (cons-right (display 1) (display 2)))))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This enforces left-to-right order.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-of-values</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (no-operands? exps)
      '()
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((value (eval* (first-operand exps) env)))
        (cons-right value
                    (list-of-values (rest-operands exps) env)))))

(parameterize ((primitive-procedures
                (cons (list 'display display) (primitive-procedures))))
  (test <span style="color: #00ff00;">"Left-to-right list-of-values with cons-right"</span>
        <span style="color: #00ff00;">"12"</span>
        (with-output-to-string
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
            (eval* '(cons (display 1) (display 2)) (setup-environment))))))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This enforces right-to-left order.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-of-values</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (no-operands? exps)
      '()
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((rest (list-of-values (rest-operands exps) env)))
        (cons (eval* (first-operand exps) env) rest))))

(with-primitive-procedures `((display ,display))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test <span style="color: #00ff00;">"Right-to-left list-of-values with cons"</span>
        <span style="color: #00ff00;">"21"</span>
        (with-output-to-string
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
            (eval* '(cons (display 1) (display 2)) (setup-environment)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> 4.2</h3>
<div class="outline-text-3" id="text-4-2">
<p>
If application is moved before assignment, <code>apply</code> won’t recognize
the special forms <code>set!</code> and <code>define</code> anymore; since
procedure-application (which is the most general rule), dispatches
on pairs.
</p>

<p>
This will short-circuit <code>eval</code> and try to apply the procedure e.g.
<code>define</code>, which doesn’t exist; we can solve this by specializing
<code>application?</code> to look for a tagged-list starting with <code>call</code> (and
modifying the definitions of <code>operator</code> and <code>operand</code> to ignore
<code>call</code>):
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">application?</span> exp) (tagged-list? exp 'call))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operator</span> exp) (cadr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operands</span> exp) (cddr exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval*</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) exp)
        ((variable? exp) (lookup-variable-value exp env))
        ((quoted? exp) (text-of-quotation exp))
        ((application? exp)
         (apply* (eval* (operator exp) env)
                 (list-of-values (operands exp) env)))
        ((assignment? exp) (eval-assignment exp env))
        ((definition? exp) (eval-definition exp env))
        ((if? exp) (eval-if exp env))
        ((lambda? exp) (make-procedure (lambda-parameters exp)
                                  (lambda-body exp)
                                  env))
        ((begin? exp)
         (eval-sequence (begin-actions exp) env))
        ((cond? exp) (eval* (cond-&gt;if exp) env)) 
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (error <span style="color: #00ff00;">"Unknown expression type: EVAL"</span> exp))))

(with-primitive-procedures `((+ ,+))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test 6 (eval* '(<span style="color: #00ffff; font-weight: bold;">begin</span> (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> 3) (call + x x)) (setup-environment)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> <span class="done DONE">DONE</span> 4.3</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Let’s reuse the same <code>put</code> and <code>get</code> methods from chapter 2 with the
contrived operation <code>eval</code>:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval)

(put 'eval 'quote (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env)
                    (text-of-quotation exp)))
(put 'eval 'set! eval-assignment)
(put 'eval 'define eval-definition)
(put 'eval 'if eval-if)
(put 'eval 'lambda (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env)
                (make-procedure (lambda-parameters exp)
                                (lambda-body exp)
                                env)))
(put 'eval 'begin (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env)
                    (eval-sequence (begin-actions exp) env)))
(put 'eval 'cond (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env)
                   (eval* (cond-&gt;if exp) env)))
(put 'eval 'application (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env)
                          (apply* (eval* (operator exp) env)
                                  (list-of-values (operands exp) env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval*</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) exp)
        ((variable? exp) (lookup-variable-value exp env))
        ((pair? exp)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((dispatch (<span style="color: #00ffff; font-weight: bold;">or</span> (get 'eval (car exp))
                             (get 'eval 'application))))
           (dispatch exp env)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)

(with-primitive-procedures `((= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test <span style="color: #00ff00;">"Self-evaluation"</span> 2 (eval* 2 env))
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> 3) env)
    (test <span style="color: #00ff00;">"Variable-lookup/definition"</span> 3 (eval* 'x env))
    (eval* '(set! x 2) env)
    (test <span style="color: #00ff00;">"Variable-lookup/assignment"</span> 2 (eval* 'x env))
    (test <span style="color: #00ff00;">"If/true"</span> 1 (eval* '(<span style="color: #00ffff; font-weight: bold;">if</span> true 1 2) env))
    (test <span style="color: #00ff00;">"If/false"</span> 2 (eval* '(<span style="color: #00ffff; font-weight: bold;">if</span> false 1 2) env))
    (test <span style="color: #00ff00;">"Lambda"</span> 4 (eval* '((<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) x) 4) env))
    (test <span style="color: #00ff00;">"Begin"</span> 5 (eval* '(<span style="color: #00ffff; font-weight: bold;">begin</span> (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> 5) y) env))
    (test <span style="color: #00ff00;">"Cond"</span> 3 (eval* '(<span style="color: #00ffff; font-weight: bold;">cond</span> ((= 3 3) 3) (<span style="color: #00ffff; font-weight: bold;">else</span> 2)) env))
    (test-assert <span style="color: #00ff00;">"Application"</span> (eval* '(= 3 3) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> <span class="done DONE">DONE</span> 4.4</h3>
<div class="outline-text-3" id="text-4-4">
<p>
We could have used a derived-form (such as nested <code>ifs</code> or <code>cond</code>)
to implement <code>and</code> and <code>or</code>; decided to just iterate through,
though, because it’s straight-forward.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-and</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((exps (operands exp))
             (last (eval* 'true env)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? exps)
        last
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((value (eval* (first-operand exps) env)))
          (<span style="color: #00ffff; font-weight: bold;">if</span> value
              (iter (rest-operands exps) value)
              (eval* 'false env))))))

(put 'eval 'and eval-and)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-or</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((exps (operands exp)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? exps)
        (eval* 'false env)
        (<span style="color: #00ffff; font-weight: bold;">or</span> (eval* (first-operand exps) env)
            (iter (rest-operands exps))))))

(put 'eval 'or eval-or)

(with-primitive-procedures `((= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test-assert (not (eval* '(<span style="color: #00ffff; font-weight: bold;">and</span> true false) env)))
    (test-assert (eval* '(<span style="color: #00ffff; font-weight: bold;">and</span>) env))
    (test-assert (eval* '(<span style="color: #00ffff; font-weight: bold;">and</span> true true) env))
    (test 2 (eval* '(<span style="color: #00ffff; font-weight: bold;">and</span> true 2) env))

    (test-assert (not (eval* '(<span style="color: #00ffff; font-weight: bold;">or</span>) env)))
    (test-assert (eval* '(<span style="color: #00ffff; font-weight: bold;">or</span> false true) env))
    (test 2 (eval* '(<span style="color: #00ffff; font-weight: bold;">or</span> 2 true) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> <span class="done DONE">DONE</span> 4.5</h3>
<div class="outline-text-3" id="text-4-5">
<p>
We produced a new predicate, <code>cond-recipient-clause?</code>, to handle the
recipient-form; it involves evaluating the cond-predicate of the
recipient clause and possibly applying the cond-recipient to the
evaluation of the cond-predicate.
</p>

<p>
We could have alternatively returned a derived expression and
deferred evaluation to the outer <code>eval*</code>; but we’d have to capture
the value of the cond-predicate without <code>let</code> and without <code>gensym</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cond-recipient-clause?</span> clause)
  (eq? (car (cond-actions clause)) '=&gt;))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cond-recipient</span> clause)
  (caddr clause))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">expand-clauses</span> clauses env)
  (<span style="color: #00ffff; font-weight: bold;">and</span> (not (null? clauses))
       (<span style="color: #00ffff; font-weight: bold;">let</span> ((first (car clauses))
             (rest (cdr clauses)))
         (<span style="color: #00ffff; font-weight: bold;">cond</span> ((cond-else-clause? first)
                (<span style="color: #00ffff; font-weight: bold;">if</span> (null? rest)
                    (sequence-&gt;exp (cond-actions first))
                    (error <span style="color: #00ff00;">"ELSE clasue isn't last: COND-&gt;IF"</span>
                           clauses))) 
               ((cond-recipient-clause? first)
                (<span style="color: #00ffff; font-weight: bold;">let</span> ((value (eval* (cond-predicate first) env)))
                  (make-if value
                           (list (cond-recipient first) value)
                           (expand-clauses rest env))))
               (<span style="color: #00ffff; font-weight: bold;">else</span>
                (make-if (cond-predicate first)
                         (sequence-&gt;exp (cond-actions first))
                         (expand-clauses rest env)))))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">cond-&gt;if</span> exp env) (expand-clauses (cond-clauses exp) env))

(put 'eval 'cond (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (cond-&gt;if exp env) env)))

(with-primitive-procedures `((+ ,+))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test 4 (eval* '(<span style="color: #00ffff; font-weight: bold;">cond</span> (2 =&gt; (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (+ x x))) (<span style="color: #00ffff; font-weight: bold;">else</span> 3)) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> <span class="done DONE">DONE</span> 4.6</h3>
<div class="outline-text-3" id="text-4-6">
<p>
We’ll use quasi-quotation to define the syntax-transformation
(including unquote and unquote-splicing); and <code>display</code> to test
multiple expressions in the body.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clauses</span> exp) (cadr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clause-variable</span> clause) (car clause))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clause-expression</span> clause) (cadr clause))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-body</span> exp) (cddr exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-&gt;combination</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((clauses (let-clauses exp)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-variable clauses))
          (expressions (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-expression clauses)))
      `((<span style="color: #00ffff; font-weight: bold;">lambda</span> ,variables ,@(let-body exp)) ,@expressions))))

(put 'eval 'let (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (let-&gt;combination exp) env)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)

(with-primitive-procedures `((display ,display)
                             (+ ,+))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test 10 (eval* '(<span style="color: #00ffff; font-weight: bold;">let</span> ((x (+ 2 2)) (y (+ 3 3))) (display x) (+ x y))
                    env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> <span class="done DONE">DONE</span> 4.7</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Derived expressions should suffice, since the user is intentional
about scope and shadowing; in other words, there shouldn’t be any
unintended scope-pollution because of e.g. intermediate values.
</p>

<p>
The implementation is a little awkward, however, in that we have to
use a combination of <code>unquote-splicing</code>, wrapping lists and <code>car</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This is a little awkward: the bottom line is that the let-body</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">should be unquote-spliced, whereas the nested lets should be</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">simply unquoted; we decided to wrap the nested lets in an</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">additional list to counteract the splice and car the final</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">product.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let*-&gt;nested-lets</span> exp)
  (car (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">iter</span> ((clauses (let-clauses exp)))
         (<span style="color: #00ffff; font-weight: bold;">if</span> (null? clauses)
             (let-body exp)
             `((<span style="color: #00ffff; font-weight: bold;">let</span> (,(car clauses))
                 ,@(iter (cdr clauses))))))))

(put 'eval 'let* (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (let*-&gt;nested-lets exp) env)))

(with-primitive-procedures `((+ ,+) (* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test 39 (eval* '(<span style="color: #00ffff; font-weight: bold;">let*</span> ((x 3) (y (+ x 2)) (z (+ x y 5)))
                       (* x z)) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> <span class="done DONE">DONE</span> 4.8</h3>
<div class="outline-text-3" id="text-4-8">
<p>
Anticipating the implementation of <code>letrec</code> in 4.20, we decided to
implement named <code>let</code> using <code>let</code> with a placeholder (<code>#f</code>, in this
case), calling <code>set</code> to give it a lambda with a body and finally
invoking it.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">named-let?</span> exp)
  (symbol? (let-clauses exp)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">named-let-procedure</span> exp) (cadr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">named-let-clauses</span> exp) (caddr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">named-let-body</span> exp) (cdddr exp))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">We could really use letrec, here; let's use something similar by</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">defining a placeholder for the procedure and setting it down</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">below.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">named-let-&gt;combination</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (named-let? exp)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((procedure (named-let-procedure exp))
            (clauses (named-let-clauses exp)))
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-variable clauses))
              (expressions (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-expression clauses)))
          `(<span style="color: #00ffff; font-weight: bold;">let</span> ((,procedure #f))
             (set! ,procedure (<span style="color: #00ffff; font-weight: bold;">lambda</span> ,variables ,@(named-let-body exp)))
             (,procedure ,@expressions))))
      (let-&gt;combination exp)))

(put 'eval 'let (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (named-let-&gt;combination exp) env)))

(with-primitive-procedures `((= ,=)
                             (+ ,+)
                             (- ,-))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fib</span> n)
              (<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">fib-iter</span> ((a 1)
                             (b 0)
                             (count n))
                (<span style="color: #00ffff; font-weight: bold;">if</span> (= count 0)
                    b
                    (fib-iter (+ a b) a (- count 1)))))
           env)
    (test 55 (eval* '(fib 10) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> <span class="done DONE">DONE</span> 4.9</h3>
<div class="outline-text-3" id="text-4-9">
<p>
We decided to implement <a href="http://www.schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html#%25_idx_138">do</a> as a named <code>let</code>; in order to do so, we
had to resort to <code>gensym</code> to name the outer let so as to avoid
contaminating the environment with shadowing symbols.
</p>

<p>
Something like this, therefore:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">do</span> ((<span style="color: #00ff00;">&lt;variable1&gt;</span> <span style="color: #00ff00;">&lt;init1&gt;</span> <span style="color: #00ff00;">&lt;step1&gt;</span>)
     ...)
    (<span style="color: #00ff00;">&lt;test&gt;</span> <span style="color: #00ff00;">&lt;expression&gt;</span> ...)
  <span style="color: #00ff00;">&lt;command&gt;</span> ...)
</pre>
</div>

<p>
becomes:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">let</span> <span style="color: #0000ff; font-weight: bold;">&lt;name&gt;</span> ((<span style="color: #00ff00;">&lt;variable1&gt;</span> <span style="color: #00ff00;">&lt;init1&gt;</span>) ...)
     (<span style="color: #00ffff; font-weight: bold;">if</span> <span style="color: #00ff00;">&lt;test&gt;</span>
         (<span style="color: #00ffff; font-weight: bold;">begin</span> <span style="color: #00ff00;">&lt;expression&gt;</span> ...)
         (<span style="color: #00ffff; font-weight: bold;">begin</span> <span style="color: #00ff00;">&lt;command&gt;</span> ... (<span style="color: #00ff00;">&lt;name&gt;</span> <span style="color: #00ff00;">&lt;step1&gt;</span> ...))))
</pre>
</div>

<p>
Variables without a step acquire identity as their step.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval srfi-1 test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variables</span> exp) (cadr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-test</span> exp) (caddr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-test-predicate</span> test) (car test))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-test-body</span> test) (cdr test))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-body</span> exp) (cdddr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variable-name</span> variable) (car variable))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variable-init</span> variable) (cadr variable))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variable-has-step?</span> variable) (not (null? (cddr variable))))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variable-step</span> variable)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (do-variable-has-step? variable)
      (caddr variable)
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This amounts to the identity function.</span>
      (do-variable-name variable)))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-variable-names&amp;inits</span> variables)
  (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (variable) (list (do-variable-name variable)
                           (do-variable-init variable)))
       variables))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">do-&gt;named-let</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (do-variables exp))
        <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">We had to resort to gensym here for the outer named let.</span>
        (iter (gensym)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((test (do-test exp)))
      `(<span style="color: #00ffff; font-weight: bold;">let</span> ,iter ,(do-variable-names&amp;inits variables)
            (<span style="color: #00ffff; font-weight: bold;">if</span> ,(do-test-predicate test)
                (<span style="color: #00ffff; font-weight: bold;">begin</span> ,@(do-test-body test))
                (<span style="color: #00ffff; font-weight: bold;">begin</span>
                  ,@(do-body exp)
                  (,iter ,@(<span style="color: #00ffff; font-weight: bold;">map</span> do-variable-step variables))))))))

(put 'eval 'do (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (do-&gt;named-let exp) env)))

(with-primitive-procedures `((make-vector ,make-vector)
                             (+ ,+)
                             (= ,=)
                             (vector-set! ,vector-set!))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test '#(0 1 2 3 4)
          (eval* '(<span style="color: #00ffff; font-weight: bold;">do</span> ((vec (make-vector 5))
                       (i 0 (+ i 1)))
                      ((= i 5) vec)
                    (vector-set! vec i i))
                 env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> <span class="done DONE">DONE</span> 4.10</h3>
<div class="outline-text-3" id="text-4-10">
<p>
One could imagine a post-fix Scheme, for instance, in which the
operator was last and the operands came first.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval srfi-1 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operator</span> exp) (last exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">operands</span> exp) (drop-right exp 1))

(with-primitive-procedures `((+ ,+))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) (test 4 (eval* '(2 2 +) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> <span class="done DONE">DONE</span> 4.11</h3>
<div class="outline-text-3" id="text-4-11">
<p>
Let’s just use <a href="http://api.call-cc.org/doc/srfi-69">hash-tables</a> like god intended.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use debug sicp-eval srfi-69 test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">zip-alist</span> keys values)
  (<span style="color: #00ffff; font-weight: bold;">map</span> cons keys values))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-frame</span> vars vals)
  (alist-&gt;hash-table (zip-alist vars vals)))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">frame-variables</span> frame)
  (hash-table-keys frame))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">frame-values</span> frame)
  (hash-table-values frame))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">add-binding-to-frame!</span> var val frame)
  (hash-table-set! frame var val))

(with-primitive-procedures `((* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> 3) env)
    (test 9 (eval* '(* x x) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> <span class="done DONE">DONE</span> 4.12</h3>
<div class="outline-text-3" id="text-4-12">
<p>
Let’s abstract out <code>scan</code> and <code>env-loop</code> with a few procedures:
<code>finally</code>, <code>equally</code> and <code>fail</code>; that are applied appropriately.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scan</span> vars vals var finally equally)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? vars) (finally))
        ((eq? var (car vars)) (equally vars vals))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (scan (cdr vars) (cdr vals) var finally equally))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">env-loop</span> env var equally fail)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? env the-empty-environment)
      (fail)
      (<span style="color: #00ffff; font-weight: bold;">let</span> ((frame (first-frame env)))
        (scan (frame-variables frame)
              (frame-values frame)
              var
              (<span style="color: #00ffff; font-weight: bold;">lambda</span> ()
                (env-loop (enclosing-environment env) var equally fail))
              equally))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"env-loop+scan.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">lookup-variable-value</span> var env)
  (env-loop
   env
   var
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (vars vals) (car vals))
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (error <span style="color: #00ff00;">"Unbound variable"</span> var))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">set-variable-value!</span> var val env)
  (env-loop
   env
   var
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (vars vals) (set-car! vals val))
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (error <span style="color: #00ff00;">"Unbound variable: SET!"</span> var))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">define-variable!</span> var val env)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((frame (first-frame env)))
    (scan (frame-variables frame)
          (frame-values frame)
          var
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (add-binding-to-frame! var val frame))
          (<span style="color: #00ffff; font-weight: bold;">lambda</span> (vars vals) (set-car! vals val)))))

(with-primitive-procedures `((* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> 3) env)
    (test 9 (eval* '(* x x) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13"><span class="section-number-3">4.13</span> <span class="done DONE">DONE</span> 4.13</h3>
<div class="outline-text-3" id="text-4-13">
<p>
We’re reusing the traversal-abstractions from <a href="#sec-4-12">4.12</a>; this works by
simply setting the matching variable-name to something
undiscoverable via <code>gensym</code> (might as well have been some sentinel
like <code>*deleted*</code>).
</p>

<p>
I’ve decided to remove the most immediate binding (and not traverse
the frame-tree upwards); this gives the user the flexibility to
peel back successive layers of bindings (and implement a
<code>make-recursively-unbound!</code>, if desirable).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)
(include <span style="color: #00ff00;">"env-loop+scan.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-unbound-variable</span> exp) (cadr exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-unbound!</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((var (make-unbound-variable exp)))
    (env-loop
     env
     var
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (vars vals)
       <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Set the matched variable-name to something alien.</span>
       (set-car! vars (gensym)))
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (error <span style="color: #00ff00;">"Unbound variable: MAKE-UNBOUND!"</span> var)))))

(put 'eval 'make-unbound! make-unbound!)

(with-primitive-procedures `((* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">x</span> 3) env)
    (test 3 (eval* 'x env))
    (eval* '(make-unbound! x) env)
    <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">It should be an error to use x.</span>
    (test-error (eval* '(* x x) env))
    <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">It should be an error to try to unbind it again.</span>
    (test-error (eval* '(make-unbound! x) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14"><span class="section-number-3">4.14</span> <span class="done DONE">DONE</span> 4.14</h3>
<div class="outline-text-3" id="text-4-14">
<p>
The reason why using primitive <code>map</code> fails is that the
host-representation of <code>lambda</code> is different than the target one;
the target representation of <code>lambda</code> is just a list tagged with
<code>procedure</code> and containing the parameters, body and environment.
</p>

<p>
The host-Scheme, presumably, has some internal representation for
<code>lambda</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(with-primitive-procedures `((null? ,null?)
                             (cons ,cons)
                             (car ,car)
                             (cdr ,cdr)
                             (* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">map</span> proc items)
              (<span style="color: #00ffff; font-weight: bold;">if</span> (null? items)
                  '()
                  (cons (proc (car items))
                        (<span style="color: #00ffff; font-weight: bold;">map</span> proc (cdr items)))))
           env)
    (test <span style="color: #00ff00;">"Defining a local map works."</span>
          '(1 4 9)
          (eval* '(<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (* x x)) '(1 2 3)) env))))

(with-primitive-procedures `((<span style="color: #00ffff; font-weight: bold;">map</span> ,map)
                             (* ,*))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test-error <span style="color: #00ff00;">"Using built-in map errors out."</span>
                (eval* '(<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (* x x)) '(1 2 3)) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15"><span class="section-number-3">4.15</span> <span class="done DONE">DONE</span> 4.15</h3>
<div class="outline-text-3" id="text-4-15">
<p>
If <code>(try try)</code> halts, it is false (it should run forever); if <code>(try
   try)</code> doesn’t halt, it violates <code>halts?</code> (which should return
false).
</p>
</div>
</div>
<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16"><span class="section-number-3">4.16</span> <span class="done DONE">DONE</span> 4.16</h3>
<div class="outline-text-3" id="text-4-16">
<p>
We preferred <code>make-procedure</code> over <code>procedure-body</code> so that the
transformation doesn’t have to be applied every time the procedure
is executed.
</p>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This is a version of lookup-variable-value that knows about the</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">special value *unassigned* for exercises 4.1{6,8}.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">lookup-variable-value</span> var env)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">env-loop</span> env)
    (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scan</span> vars vals)
      (<span style="color: #00ffff; font-weight: bold;">cond</span> ((null? vars)
             (env-loop (enclosing-environment env)))
            ((eq? var (car vars))
             <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Check for *unassigned* here.</span>
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((val (car vals)))
               (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? val '*unassigned*)
                   (error <span style="color: #00ff00;">"Unassigned variable"</span> var)
                   val)))
            (<span style="color: #00ffff; font-weight: bold;">else</span> (scan (cdr vars) (cdr vals)))))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (eq? env the-empty-environment)
        (error <span style="color: #00ff00;">"Unbound variable"</span> var)
        (<span style="color: #00ffff; font-weight: bold;">let</span> ((frame (first-frame env)))
          (scan (frame-variables frame)
                (frame-values frame)))))
  (env-loop env))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scan-out-defines</span> body)
  (call-with-values (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (partition definition? body))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (definitions body)
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">To avoid pathological recursion, do nothing if there are not</span>
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">any internal definitions.</span>
      (<span style="color: #00ffff; font-weight: bold;">if</span> (null? definitions)
          body
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((bindings
                 (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (definition)
                        `(,(definition-variable definition) '*unassigned*))
                      definitions))
                (sets!
                 (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (definition)
                        `(set!
                          ,(definition-variable definition)
                          ,(definition-value definition)))
                      definitions)))
            <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">We had to add an extra list here to simulate the body.</span>
            `((<span style="color: #00ffff; font-weight: bold;">let</span> ,bindings ,@sets! ,@body)))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval srfi-1 test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)
(include <span style="color: #00ff00;">"lookup-variable-value.scm"</span>)
(include <span style="color: #00ff00;">"scan-out-defines.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters (scan-out-defines body) env))

(with-primitive-procedures `((- ,-) (= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> x)
              (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">even?</span> n) (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0) true (odd? (- n 1))))
              (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">odd?</span> n) (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0) false (even? (- n 1))))
              (odd? x))
           env)
    (test-assert (not (eval* '(f 2) env)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17"><span class="section-number-3">4.17</span> <span class="done DONE">DONE</span> 4.17</h3>
<div class="outline-text-3" id="text-4-17">
<p>
The extra frame results from the <code>let</code> to <code>lambda</code> transformation
that takes place when the inner <code>let</code> is evaluated.
</p>

<p>
This extra frame follows immediately upon the outer frame with no
intervening code and should be invisible to users.
</p>

<p>
One can avoid constructing the additional frame by modifying the
lambda itself to put the variables of the internal definitions in
the variables of the <code>lambda</code> and call the <code>lambda</code> with a
corresponding number of additional <code>*unassigned*</code> values.
</p>

<p>
TODO: Implement this.
</p>


<div class="figure">
<p><img src="./4.17.jpg" alt="4.17.jpg" />   
</p>
<p><span class="figure-number">Figure 36:</span> Environment diagrams for internal definitions and transform</p>
</div>
</div>
</div>
<div id="outline-container-sec-4-18" class="outline-3">
<h3 id="sec-4-18"><span class="section-number-3">4.18</span> <span class="done DONE">DONE</span> 4.18</h3>
<div class="outline-text-3" id="text-4-18">
<p>
We used <code>gensym</code> here to create unique variable-names. Also, in
order to avoid reproducing the entire streams infrastructure; we
decided to use an experiment using <code>delay</code> and <code>force</code> which
resembles some of the mutually recursive stream-definitions.
</p>

<p>
Just like the call to <code>integral</code> delays <code>dy</code> and the call to
<code>stream-map</code> eventually forces <code>y</code> (if at least two elements of the
stream are consumed), we similarly force and delay <code>y</code> and <code>dy</code>;
and should get an endless stream of promises back.
</p>

<p>
In Chicken, for instance, this results in an endless stream of
promises:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">x</span>)
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (<span style="color: #00ffff; font-weight: bold;">delay</span> dy))
  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dy</span> y)
  <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">The first force simulates stream-map; the second, integral.</span>
  (<span style="color: #00ffff; font-weight: bold;">force</span> (<span style="color: #00ffff; font-weight: bold;">force</span> y)))

(x)
</pre>
</div>

<p>
The <a href="#sec-4-16">4.16</a>-method for scanning out defines results in:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">let</span> ((y '*unassigned*) (dy '*unassigned*))
  (set! y (<span style="color: #00ffff; font-weight: bold;">delay</span> dy))
  (set! dy y)
  (<span style="color: #00ffff; font-weight: bold;">force</span> y))
</pre>
</div>

<p>
whereas the <a href="#sec-4-18">4.18</a>-method results in e.g.:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">let</span> ((y '*unassigned*) (dy '*unassigned*))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((g3965 (<span style="color: #00ffff; font-weight: bold;">delay</span> dy)) (g3964 y))
    (set! y g3965)
    (set! dy g3964))
  (<span style="color: #00ffff; font-weight: bold;">force</span> y))
</pre>
</div>

<p>
If this is a good analogy of <code>integral</code> and <code>stream-map</code>, the
latter will not work; in our primitive simulation, for instance,
<code>y</code> is still <code>*unassigned*</code> when the <code>gensym</code> corresponding to <code>dy</code>
tries to force it.
</p>

<p>
In the previous version, however, there is still an implicit
linearity such that this works.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)
(put 'eval 'delay (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* `(<span style="color: #00ffff; font-weight: bold;">lambda</span> () ,(cadr exp)) env)))
(put 'eval 'force (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (cdr exp) env)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(with-primitive-procedures '()
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p</span>) (p)) env)
    (test <span style="color: #00ff00;">"Delay and force a scalar"</span> 2 (eval* '(<span style="color: #00ffff; font-weight: bold;">force</span> (<span style="color: #00ffff; font-weight: bold;">delay</span> 2)) env))
    (test-assert <span style="color: #00ff00;">"Delay the application of an infinitely recursing procedure"</span>
                 (compound-procedure? (eval* '(<span style="color: #00ffff; font-weight: bold;">delay</span> (p)) env)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-simultaneous-scope</span> variables values body)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((gensyms (list-tabulate (length variables) (<span style="color: #00ffff; font-weight: bold;">lambda</span> (i) (gensym)))))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((variable-bindings
           (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (variable) `(,variable '*unassigned*)) variables))
          (gensym-bindings
           (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (gensym value) `(,gensym ,value)) gensyms values))
          (sets!
           (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (variable gensym) `(set! ,variable ,gensym)) variables gensyms)))
      `(<span style="color: #00ffff; font-weight: bold;">let</span> ,variable-bindings (<span style="color: #00ffff; font-weight: bold;">let</span> ,gensym-bindings ,@sets!) ,@body))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(include <span style="color: #00ff00;">"make-simultaneous-scope.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">scan-out-defines-alternatively</span> body)
  (call-with-values (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (partition definition? body))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (definitions body)
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">To avoid pathological recursion, do nothing if there are</span>
      <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">not any internal definitions.</span>
      (<span style="color: #00ffff; font-weight: bold;">if</span> (null? definitions)
          body
          (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (<span style="color: #00ffff; font-weight: bold;">map</span> definition-variable definitions))
                (values (<span style="color: #00ffff; font-weight: bold;">map</span> definition-value definitions)))
            <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">We had to add an extra list here to simulate the body.</span>
            (list (make-simultaneous-scope variables values body)))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)
(include <span style="color: #00ff00;">"force-and-delay.scm"</span>)
(include <span style="color: #00ff00;">"eval-let.scm"</span>)
(include <span style="color: #00ff00;">"lookup-variable-value.scm"</span>)
(include <span style="color: #00ff00;">"scan-out-defines.scm"</span>)
(include <span style="color: #00ff00;">"scan-out-defines-alternatively.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-mutual-recursion</span>)
  (with-primitive-procedures '()
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">x</span>)
                (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">y</span> (<span style="color: #00ffff; font-weight: bold;">delay</span> dy))
                (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">dy</span> y)
                <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">This force simulates the evaluation by stream-map when</span>
                <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">the second element is consumed; but before calculating</span>
                <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">the second element of the integral.</span>
                (<span style="color: #00ffff; font-weight: bold;">force</span> y)) env)
      (eval* '(x) env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters (scan-out-defines body) env))

(test-assert <span style="color: #00ff00;">"Delayed mutual recursion with scan-out-defines"</span>
             (compound-procedure? (eval-mutual-recursion)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters (scan-out-defines-alternatively body) env))

(with-primitive-procedures `((- ,-) (= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> x)
              (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">even?</span> n) (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0) true (odd? (- n 1))))
              (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">odd?</span> n) (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 0) false (even? (- n 1))))
              (odd? x))
           env)
    (test-assert <span style="color: #00ff00;">"Mutual recursion with alternative scan-out-defines"</span>
                 (not (eval* '(f 2) env)))))

(test-error <span style="color: #00ff00;">"Delayed mutual recursion with alternative scan-out-defines is unassigned"</span>
            (eval-mutual-recursion))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-19" class="outline-3">
<h3 id="sec-4-19"><span class="section-number-3">4.19</span> <span class="done DONE">DONE</span> 4.19</h3>
<div class="outline-text-3" id="text-4-19">
<p>
The simultaneous scope from <a href="#sec-4-16">4.16</a> results in:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">let</span> ((a 1))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((f '*unassigned*))
    (set! f (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
              (<span style="color: #00ffff; font-weight: bold;">let</span> ((b '*unassigned*) (a '*unassigned*))
                (set! b (+ a x))
                (set! a 5)
                (+ a b))))
    (f 10)))
</pre>
</div>

<p>
whereas the one from <a href="#sec-4-18">4.18</a> results in:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">let</span> ((a 1))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((f '*unassigned*))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((g2608
           (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x)
             (<span style="color: #00ffff; font-weight: bold;">let</span> ((b '*unassigned*) (a '*unassigned*))
               (<span style="color: #00ffff; font-weight: bold;">let</span> ((g3553 (+ a x)) (g3552 5))
                 (set! b g3553)
                 (set! a g3552))
               (+ a b)) (+ a b))))
      (set! f g2608))
    (f 10)))
</pre>
</div>

<p>
They both result in an error, since the original value of <code>a</code> is
over-shadowed by <code>*unassigned*</code> during addition.
</p>

<p>
In order to implement Eva’s suggestion, a form of selective
sequential evaluation would have to be performed; in which the
expressions were scanned and variables topologically sorted by
dependency on other variables (and evaluated accordingly).
</p>

<p>
This does not solve the problem in general, however, since it is
still possible to have viciously circular dependencies between
variables.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)
(include <span style="color: #00ff00;">"lookup-variable-value.scm"</span>)
(include <span style="color: #00ff00;">"scan-out-defines.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-expression</span>)
  (with-primitive-procedures `((+ ,+))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">let</span> ((a 1))
                (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> x)
                  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">b</span> (+ a x))
                  (<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">a</span> 5)
                  (+ a b))
                (f 10))
             env))))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This is the default implementation of make-procedure.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters body env))

(test <span style="color: #00ff00;">"Sequential scope"</span> 16 (eval-expression))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This implementation of make-procedure activates the</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">define--out-scanning.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters (scan-out-defines body) env))

(test-error <span style="color: #00ff00;">"Simultaneous scope"</span> (eval-expression))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This implementation of make-procedure activates the</span>
<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">alternative define--out-scanning.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">make-procedure</span> parameters body env)
  (list 'procedure parameters (scan-out-defines-alternatively body) env))

(test-error <span style="color: #00ff00;">"Alternative simultaneous scope"</span> (eval-expression))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-20" class="outline-3">
<h3 id="sec-4-20"><span class="section-number-3">4.20</span> <span class="done DONE">DONE</span> 4.20</h3>
<div class="outline-text-3" id="text-4-20">
<p>
Let’s use the simultaneous scope from <a href="#sec-4-18">4.18</a>; the environment
diagrams look something like:
</p>


<div class="figure">
<p><img src="./4.20.jpg" alt="4.20.jpg" />
</p>
<p><span class="figure-number">Figure 37:</span> Environment diagram for <code>let</code> vs. <code>letrec</code></p>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"eval-let.scm"</span>)
(include <span style="color: #00ff00;">"data-directed-eval.scm"</span>)
(include <span style="color: #00ff00;">"make-simultaneous-scope.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">letrec-&gt;let</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((clauses (let-clauses exp)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-variable clauses))
          (values (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-expression clauses)))
      (make-simultaneous-scope variables values (let-body exp)))))

(put 'eval 'letrec (<span style="color: #00ffff; font-weight: bold;">lambda</span> (exp env) (eval* (letrec-&gt;let exp) env)))

(with-primitive-procedures `((* ,*)
                             (- ,-)                             
                             (= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test <span style="color: #00ff00;">"Factorial with letrec"</span>
          3628800
          (eval* '(<span style="color: #00ffff; font-weight: bold;">letrec</span> ((fact
                            (<span style="color: #00ffff; font-weight: bold;">lambda</span> (n) (<span style="color: #00ffff; font-weight: bold;">if</span> (= n 1) 1 (* n (fact (- n 1)))))))
                    (fact 10))
                 env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-21" class="outline-3">
<h3 id="sec-4-21"><span class="section-number-3">4.21</span> <span class="done DONE">DONE</span> 4.21</h3>
<div class="outline-text-3" id="text-4-21">
<div class="org-src-container">

<pre class="src src-scheme">(use test)

(test
 <span style="color: #00ff00;">"Factorial with Y-combinator"</span>
 3628800
 ((<span style="color: #00ffff; font-weight: bold;">lambda</span> (n)
    ((<span style="color: #00ffff; font-weight: bold;">lambda</span> (fact) (fact fact n))
     (<span style="color: #00ffff; font-weight: bold;">lambda</span> (ft k) (<span style="color: #00ffff; font-weight: bold;">if</span> (= k 1) 1 (* k (ft ft (- k 1)))))))
  10))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">f</span> x)
  ((<span style="color: #00ffff; font-weight: bold;">lambda</span> (even? odd?) (even? even? odd? x))
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (ev? od? n)
     (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? n) #t (od? ev? od? (- n 1))))
   (<span style="color: #00ffff; font-weight: bold;">lambda</span> (ev? od? n)
     (<span style="color: #00ffff; font-weight: bold;">if</span> (zero? n) #f (ev? ev? od? (- n 1))))))

(test-assert <span style="color: #00ff00;">"Odd? with Y-combinator"</span> (not (f 15)))
(test-assert <span style="color: #00ff00;">"Even? with Y-combinator"</span> (f 16))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-22" class="outline-3">
<h3 id="sec-4-22"><span class="section-number-3">4.22</span> <span class="done DONE">DONE</span> 4.22</h3>
<div class="outline-text-3" id="text-4-22">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">anal-eval*</span> exp env)
  ((analyze exp) env))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) (analyze-self-evaluating exp))
        ((quoted? exp) (analyze-quoted exp))
        ((variable? exp) (analyze-variable exp))
        ((assignment? exp) (analyze-assignment exp))
        ((definition? exp) (analyze-definition exp))
        ((if? exp) (analyze-if exp))
        ((lambda? exp) (analyze-lambda exp))
        ((begin? exp) (analyze-sequence (begin-actions exp)))
        ((cond? exp) (analyze (cond-&gt;if exp)))
        ((application? exp) (analyze-application exp))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown expression type: ANALYZE"</span> exp))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-self-evaluating</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-quoted</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((qval (text-of-quotation exp)))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) qval)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-variable</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) (lookup-variable-value exp env)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-assignment</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((var (assignment-variable exp))
        (vproc (analyze (assignment-value exp))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (set-variable-value! var (vproc env) env)
      'ok)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-definition</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((var (definition-variable exp))
        (vproc (analyze (definition-value exp))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (define-variable! var (vproc env) env)
      'ok)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-if</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((pproc (analyze (if-predicate exp)))
        (cproc (analyze (if-consequent exp)))
        (aproc (analyze (if-alternative exp))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (<span style="color: #00ffff; font-weight: bold;">if</span> (true? (pproc env))
          (cproc env)
          (aproc env)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-lambda</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((vars (lambda-parameters exp))
        (bproc (analyze-sequence (lambda-body exp))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) (make-procedure vars bproc env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-sequence</span> exps)
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">sequentially</span> proc1 proc2)
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env) (proc1 env) (proc2 env)))
  (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">loop</span> first-proc rest-procs)
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? rest-procs)
        first-proc
        (loop (sequentially first-proc (car rest-procs))
              (cdr rest-procs))))
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((procs (<span style="color: #00ffff; font-weight: bold;">map</span> analyze exps)))
    (<span style="color: #00ffff; font-weight: bold;">if</span> (null? procs) (error <span style="color: #00ff00;">"Empty sequence: ANALYZE"</span>))
    (loop (car procs) (cdr procs))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-application</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((fproc (analyze (operator exp)))
        (aprocs (<span style="color: #00ffff; font-weight: bold;">map</span> analyze (operands exp))))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (execute-application
       (fproc env)
       (<span style="color: #00ffff; font-weight: bold;">map</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (aproc) (aproc env)) aprocs)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">execute-application</span> proc args)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((primitive-procedure? proc)
         (apply-primitive-procedure proc args))
        ((compound-procedure? proc)
         ((procedure-body proc)
          (extend-environment
           (procedure-parameters proc)
           args
           (procedure-environment proc))))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (error <span style="color: #00ff00;">"Unknown procedure type: EXECUTE-APPLICATION"</span> proc))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"analyze.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clause?</span> exp) (tagged-list? exp 'let))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clauses</span> exp) (cadr exp))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clause-variable</span> clause) (car clause))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-clause-expression</span> clause) (cadr clause))
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-body</span> exp) (cddr exp))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">let-&gt;combination</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((clauses (let-clauses exp)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((variables (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-variable clauses))
          (expressions (<span style="color: #00ffff; font-weight: bold;">map</span> let-clause-expression clauses)))
      `((<span style="color: #00ffff; font-weight: bold;">lambda</span> ,variables ,@(let-body exp)) ,@expressions))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze-let</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((combination (let-&gt;combination exp)))
    (analyze combination)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">analyze</span> exp)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) (analyze-self-evaluating exp))
        ((quoted? exp) (analyze-quoted exp))
        ((variable? exp) (analyze-variable exp))
        ((definition? exp) (analyze-assignment exp))
        <span style="color: #ffff00;">;; </span><span style="color: #ff0000; font-weight: bold;">TODO</span><span style="color: #ffff00;">: A generic syntactic-transformation form instead of</span>
        <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">this ad-hocery?</span>
        ((let-clause? exp) (analyze-let exp))
        ((if? exp) (analyze-if exp))
        ((lambda? exp) (analyze-lambda exp))
        ((begin? exp) (analyze-sequence (begin-actions exp)))
        ((cond? exp) (analyze (cond-&gt;if exp)))
        ((application? exp) (analyze-application exp))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown expression type: ANALYZE"</span> exp))))

(with-primitive-procedures `((+ ,+))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test <span style="color: #00ff00;">"Analyzing let"</span> 4 (anal-eval* '(<span style="color: #00ffff; font-weight: bold;">let</span> ((x 2)) (+ x x)) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-23" class="outline-3">
<h3 id="sec-4-23"><span class="section-number-3">4.23</span> <span class="done DONE">DONE</span> 4.23</h3>
<div class="outline-text-3" id="text-4-23">
<p>
The version in the text reifies a sequence of analyses in
<code>sequentially</code> whereas Alyssa’s version reëstablishes the
sequence every time.
</p>

<p>
With one procedure, the amount of work is the same: they both have
a fast-track; with two procedures, however, the book version has
already analyzed the sequence of procedures and Alyssa’s version
must reëstablish it.
</p>
</div>
</div>
<div id="outline-container-sec-4-24" class="outline-3">
<h3 id="sec-4-24"><span class="section-number-3">4.24</span> <span class="todo TODO">TODO</span> 4.24</h3>
<div class="outline-text-3" id="text-4-24">
<p>
In this case, we have the counter-intuitive result that
analyzing-eval takes four times longer than non-analyzing-eval;
why?
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use debug sicp-eval test)

(include <span style="color: #00ff00;">"analyze.scm"</span>)

(with-primitive-procedures `((- ,-)
                             (= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">iter</span> x) (<span style="color: #00ffff; font-weight: bold;">if</span> (= x 0) x (iter (- x 1)))) env)
    (time (eval* '(iter 10000) env))))

(with-primitive-procedures `((- ,-)
                             (= ,=))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (anal-eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">iter</span> x) (<span style="color: #00ffff; font-weight: bold;">if</span> (= x 0) x (iter (- x 1)))) env)
    (time (anal-eval* '(iter 10000) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-25" class="outline-3">
<h3 id="sec-4-25"><span class="section-number-3">4.25</span> <span class="done DONE">DONE</span> 4.25</h3>
<div class="outline-text-3" id="text-4-25">
<p>
In the applicative case, factorial will attempt to recurse
regardless of the condition and will result in an infinite
recursion; in the normal-order case, it will return the base-case
when the condition holds and not attempt to recurse: it will
terminate with the correct answer.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings debug sicp test)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">unless*</span> condition usual-value exceptional-value)
  (<span style="color: #00ffff; font-weight: bold;">if</span> condition exceptional-value usual-value))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">factorial</span> n)
  (unless* (= n 1)
    (* n (factorial (- n 1)))
    1))

(test-assert <span style="color: #00ff00;">"Greedy unless doesn't terminate."</span> (not (terminates? (<span style="color: #00ffff; font-weight: bold;">lambda</span> () (factorial 5)))))

(<span style="color: #00ffff; font-weight: bold;">define-macro</span> (<span style="color: #ffff00;">unless*</span> condition usual-value exceptional-value)
  `(<span style="color: #00ffff; font-weight: bold;">if</span> ,condition ,exceptional-value ,usual-value))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">factorial</span> n)
  (unless* (= n 1)
    (* n (factorial (- n 1)))
    1))

(test <span style="color: #00ff00;">"Lazy unless does terminate."</span> 120 (factorial 5))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-26" class="outline-3">
<h3 id="sec-4-26"><span class="section-number-3">4.26</span> <span class="done DONE">DONE</span> 4.26</h3>
<div class="outline-text-3" id="text-4-26">
<p>
On the one hand, it is possible to implement <code>unless</code> as a special
form (see below); on the other hand, one could see implementing a
test-framework with table-driven tests (à la <a href="https://code.google.com/p/go-wiki/wiki/TableDrivenTests">Go</a>) with custom
failure and success values.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use bindings sicp test)

(<span style="color: #00ffff; font-weight: bold;">define-macro</span> (<span style="color: #ffff00;">unless*</span> condition usual-value exceptional-value)
  `(<span style="color: #00ffff; font-weight: bold;">if</span> ,condition ,exceptional-value ,usual-value))

(test-error <span style="color: #00ff00;">"Unless* is not a procedure"</span>
            (<span style="color: #00ffff; font-weight: bold;">map</span> unless*
                 (list (even? 2)
                       (odd? 3))
                 (list <span style="color: #00ff00;">"Even failure"</span>
                       <span style="color: #00ff00;">"Odd failure"</span>)
                 (list <span style="color: #00ff00;">"Even success"</span>
                       <span style="color: #00ff00;">"Odd success"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-27" class="outline-3">
<h3 id="sec-4-27"><span class="section-number-3">4.27</span> <span class="done DONE">DONE</span> 4.27</h3>
<div class="outline-text-3" id="text-4-27">
<p>
The inner <code>id</code> has been called, incrementing <code>count</code> to 1,
returning 10 and defining <code>w</code>; forcing <code>w</code> calls the outer <code>id</code>,
however, and increments <code>count</code> to 2.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval*</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) exp)
        ((variable? exp) (lookup-variable-value exp env))
        ((quoted? exp) (text-of-quotation exp))
        ((assignment? exp) (eval-assignment exp env))
        ((definition? exp) (eval-definition exp env))
        ((if? exp) (eval-if exp env))
        ((lambda? exp) (make-procedure (lambda-parameters exp)
                                  (lambda-body exp)
                                  env))
        ((begin? exp)
         (eval-sequence (begin-actions exp) env))
        ((cond? exp) (eval* (cond-&gt;if exp) env))
        ((application? exp)
         (apply* (actual-value (operator exp) env)
                      (operands exp)
                      env))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (error <span style="color: #00ff00;">"Unknown expression type: EVAL*"</span> exp))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">actual-value</span> exp env)
  (force-it (eval* exp env)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">apply*</span> procedure arguments env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((primitive-procedure? procedure)
         (apply-primitive-procedure
          procedure
          (list-of-arg-values arguments env)))
        ((compound-procedure? procedure)
         (eval-sequence
          (procedure-body procedure)
          (extend-environment
           (procedure-parameters procedure)
           (list-of-delayed-args arguments env)
           (procedure-environment procedure))))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (error <span style="color: #00ff00;">"Unknown procedure type: APPLY*"</span>
                     procedure))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-of-arg-values</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (no-operands? exps)
      '()
      (cons (actual-value (first-operand exps) env)
            (list-of-arg-values (rest-operands exps) env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">list-of-delayed-args</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (no-operands? exps)
      '()
      (cons (delay-it (first-operand exps) env)
            (list-of-delayed-args (rest-operands exps) env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-if</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (true? (actual-value (if-predicate exp) env))
      (eval* (if-consequent exp) env)
      (eval* (if-alternative exp) env)))

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">input-prompt</span> <span style="color: #00ff00;">";;; L-Eval input:"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">output-prompt</span> <span style="color: #00ff00;">";;; L-Eval value:"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">driver-loop</span>)
  (prompt-for-input input-prompt)
  (<span style="color: #00ffff; font-weight: bold;">let</span> ((input (read)))
    (<span style="color: #00ffff; font-weight: bold;">let</span> ((output (actual-value input the-global-environment)))
      (announce-output output-prompt)
      (user-print output)))
  (driver-loop))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">delay-it</span> exp env)
  (list 'thunk exp env))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">thunk?</span> obj)
  (tagged-list? obj 'thunk))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">thunk-exp</span> thunk) (cadr thunk))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">thunk-env</span> thunk) (caddr thunk))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">evaluated-thunk?</span> obj)
  (tagged-list? obj 'evaluated-thunk))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">thunk-value</span> evaluated-thunk)
  (cadr evaluated-thunk))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">force-it</span> obj)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((thunk? obj)
         (<span style="color: #00ffff; font-weight: bold;">let</span> ((result (actual-value (thunk-exp obj)
                                     (thunk-env obj))))
           (set-car! obj 'evaluated-thunk)
           (set-car! (cdr obj) result)
           (set-cdr! (cdr obj) '())
           result))
        ((evaluated-thunk? obj) (thunk-value obj))
        (<span style="color: #00ffff; font-weight: bold;">else</span> obj)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"lazy-eval.scm"</span>)

(with-primitive-procedures `((+ ,+)
                             (values ,values))
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> 0) env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">id</span> x) (set! count (+ count 1)) x) env)
    (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">w</span> (id (id 10))) env)
    (test <span style="color: #00ff00;">"Id has been called once."</span> 1 (eval* 'count env))
    <span style="color: #ffff00;">;; </span><span style="color: #ffff00;">Have to force the evaluation of w with values?</span>
    (test <span style="color: #00ff00;">"W is 10."</span> 10 (eval* '(values w) env))
    (test <span style="color: #00ff00;">"Id has been called twice."</span> 2 (eval* 'count env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-28" class="outline-3">
<h3 id="sec-4-28"><span class="section-number-3">4.28</span> <span class="done DONE">DONE</span> 4.28</h3>
<div class="outline-text-3" id="text-4-28">
<p>
We need to force things like e.g. delayed procedures.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp-eval test)

(include <span style="color: #00ff00;">"lazy-eval.scm"</span>)

(with-primitive-procedures `()
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test <span style="color: #00ff00;">"Apply* with a delayed procedure and actual-value works."</span> 3
          (eval* '((<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (x)) (<span style="color: #00ffff; font-weight: bold;">lambda</span> () 3)) env))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval*</span> exp env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((self-evaluating? exp) exp)
        ((variable? exp) (lookup-variable-value exp env))
        ((quoted? exp) (text-of-quotation exp))
        ((assignment? exp) (eval-assignment exp env))
        ((definition? exp) (eval-definition exp env))
        ((if? exp) (eval-if exp env))
        ((lambda? exp) (make-procedure (lambda-parameters exp)
                                  (lambda-body exp)
                                  env))
        ((begin? exp)
         (eval-sequence (begin-actions exp) env))
        ((cond? exp) (eval* (cond-&gt;if exp) env))
        ((application? exp)
         (apply* (eval* (operator exp) env)
                 (operands exp)
                 env))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (error <span style="color: #00ff00;">"Unknown expression type: EVAL*"</span> exp))))

(with-primitive-procedures `()
  (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
    (test-error <span style="color: #00ff00;">"Apply* with a delayed procedure and eval* errors out."</span>
                (eval* '((<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (x)) (<span style="color: #00ffff; font-weight: bold;">lambda</span> () 3)) env))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-29" class="outline-3">
<h3 id="sec-4-29"><span class="section-number-3">4.29</span> <span class="done DONE">DONE</span> 4.29</h3>
<div class="outline-text-3" id="text-4-29">
<p>
Naïve Fibonacci is an example of something that will run slower
without memoization.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use sicp sicp-eval test)

(include <span style="color: #00ff00;">"lazy-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-interaction</span> name expected-value)
  (with-primitive-procedures `((+ ,+)
                               (* ,*))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">square</span> x) (* x x)) env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">count</span> 0) env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">id</span> x) (set! count (+ count 1)) x) env)
      (eval* '(square (id 10)) env)
      (test name expected-value (eval* 'count env)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fib</span> n)
  (with-primitive-procedures `((+ ,+)
                               (- ,-)
                               (= ,=))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">fib</span> n)
                (<span style="color: #00ffff; font-weight: bold;">cond</span> ((= n 0) 0)
                      ((= n 1) 1)
                      (<span style="color: #00ffff; font-weight: bold;">else</span> (+ (fib (- n 1))
                               (fib (- n 2))))))
             env)
      (eval* `(fib ,n) env))))

(test-interaction <span style="color: #00ff00;">"With memoization, count is 1."</span> 1)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">memoized-fib</span> (time+values (fib 15)))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">force-it</span> obj)
  (<span style="color: #00ffff; font-weight: bold;">if</span> (thunk? obj)
      (actual-value (thunk-exp obj) (thunk-env obj))
      obj))

(test-interaction <span style="color: #00ff00;">"Without memoization, count is 2."</span> 2)
(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">non-memoized-fib</span> (time+values (fib 15)))

(test-assert <span style="color: #00ff00;">"Memoized-fib is quicker than non-memoized-fib."</span> (&lt; memoized-fib non-memoized-fib))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-30" class="outline-3">
<h3 id="sec-4-30"><span class="section-number-3">4.30</span> <span class="done DONE">DONE</span> 4.30</h3>
<div class="outline-text-3" id="text-4-30">
<p>
For Ben’s example, a <code>force-it</code> is not required; because it’s the
last expression in the sequence.
</p>

<p>
<code>(p1 1)</code> is the same for Ben and Cy: the list <code>(1 2)</code>; whereas <code>(p2
   1)</code> is <code>1</code> in Ben’s case, but <code>(1 2)</code> in Cy’s.
</p>

<p>
This is because Ben’s <code>eval-sequence</code> never forces the evaluation
of <code>e</code> but only returns <code>x</code>.
</p>

<p>
Cy’s approach seems intuitive, but Ben’s approach seems more
rigorously lazy.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(use debug sicp-eval test)

(include <span style="color: #00ff00;">"lazy-eval.scm"</span>)

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-for-each</span> name)
  (with-primitive-procedures `()
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">for-each</span> proc items)
                (<span style="color: #00ffff; font-weight: bold;">if</span> (null? items)
                    'done
                    (<span style="color: #00ffff; font-weight: bold;">begin</span> (proc (car items))
                           (<span style="color: #00ffff; font-weight: bold;">for-each</span> proc (cdr items)))))
             env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> <span style="color: #0000ff; font-weight: bold;">values</span> '()) env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">for-each</span> (<span style="color: #00ffff; font-weight: bold;">lambda</span> (x) (set! values (cons x values))) '(57 321 88)) env)
      (test name '(88 321 57) (eval* 'values env)))))

(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">test-p1-p2</span> p1-name p2-name p2-value)
  (with-primitive-procedures `((values ,values))
    (<span style="color: #00ffff; font-weight: bold;">lambda</span> (env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p1</span> x)
                (set! x (cons x '(2)))
                x)
             env)
      (eval* '(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p2</span> x)
                (<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">p</span> e) e x)
                (p (set! x (cons x '(2)))))
             env)
      (test p1-name '(1 2) (eval* '(p1 1) env))
      (test p2-name p2-value (eval* '(values (p2 1)) env)))))

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This is the original eval-sequence.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-sequence</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((last-exp? exps)
         (eval* (first-exp exps) env))
        (<span style="color: #00ffff; font-weight: bold;">else</span>
         (eval* (first-exp exps) env)
         (eval-sequence (rest-exps exps) env))))

(test-for-each <span style="color: #00ff00;">"For-each with original eval-sequence works."</span>)

(test-p1-p2
 <span style="color: #00ff00;">"P1 evaluates with original eval-sequence."</span>
 <span style="color: #00ff00;">"P2 with original eval-sequence is 1."</span>
 1)

<span style="color: #ffff00;">;;; </span><span style="color: #ffff00;">This is the new eval-sequence.</span>
(<span style="color: #00ffff; font-weight: bold;">define</span> (<span style="color: #0000ff; font-weight: bold;">eval-sequence</span> exps env)
  (<span style="color: #00ffff; font-weight: bold;">cond</span> ((last-exp? exps) (eval* (first-exp exps) env))
        (<span style="color: #00ffff; font-weight: bold;">else</span> (actual-value (first-exp exps) env)
              (eval-sequence (rest-exps exps) env))))

(test-for-each <span style="color: #00ff00;">"For-each with new eval-sequence works."</span>)

(test-p1-p2
 <span style="color: #00ff00;">"P1 evaluates with new eval-sequence."</span>
 <span style="color: #00ff00;">"P2 with new eval-sequence is (1 2)."</span>
 '(1 2))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-31" class="outline-3">
<h3 id="sec-4-31"><span class="section-number-3">4.31</span> <span class="todo TODO">TODO</span> 4.31</h3>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Notes</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 1</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Scheme: <code>chicken-bin</code>, <code>racket</code>, <code>mit-scheme</code>.
</li>
<li>“Conjure the spirits of the computer with our spells.”
</li>
<li>Procedures as data
</li>
<li>Prefix notation: convention of placing the operator to the left
of the operands
</li>
<li>Evaluate a combination
<ul class="org-ul">
<li>Evaluate subexpressions of the combination
</li>
<li>Apply the operator to the operands
</li>
</ul>
</li>
<li>Tree accumulation, percolate values upward
</li>
<li>Special forms
</li>
<li><code>(define (square x) (* x x)</code>
</li>
<li>Substitution model
<ul class="org-ul">
<li>Evaluate the body of the procedure with each formal parametr
replaced by the corresponding argument.
</li>
</ul>
</li>
<li>Applicative vs. normal order
<ul class="org-ul">
<li>Applicative: evaluate the arguments then apply (greedy)
</li>
<li>Normal: fully expand, then reduce (lazy, macros, streams)
</li>
</ul>
</li>
<li>Expansion occurs as the process bulids up a chain of deferred
operations; the contraction occurs as the operations are actually
performed.
</li>
<li>Process, characterized by a chain of deferred operations:
recursive process.
</li>
<li>Recursive process, recursive procedure
</li>
<li>In general, the number of steps required by a tree-recursive
process will be proportional to the number of nodes in the tree,
whil the space required will be proportional to the maximum depth
of the tree.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> 2</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>It would be much better if we could “glue together” a numerator
and denominator to from a pair—a compound data object–that our
programs could manipulate in a way that would be consistent with
regarding a rational number as a single conceptual unit.
</li>
<li>Isolating how data objects are represented: data abstraction.
</li>
<li>Data abstraction enables us to erect suitable abstraction
barriers between different parts of a program.
</li>
<li>Data-directed programming
</li>
<li>Data abstraction enables us to isolate how a compound data object
is used from the details of how it is constructed.
</li>
<li>We are using here a powerful strategy of synthesis: wishful
thinking.
</li>
<li>List-structured data
</li>
<li>Data abstraction is to identify for each type of data object a
basic set of operations in terms of which all manipulations of
data objects of that type will be expressed.
</li>
<li>The closure property of cons
</li>
<li>See <a href="./papers/waters-method-for-analyzing-loop-programs.pdf">Water's paper</a> on analyzing loops: “plan building methods.”
</li>
<li>In building up a complex image in this manner we are exploiting
the fact that painters are closed under the language’s means of
combination.
</li>
<li>In general, if we want to distinguish \(n\) different symbols, we
will need to use \(log_2n\) bits per symbol.
</li>
<li>Variable vs. fixed-length codes
</li>
<li>At each non-leaf node of the tree there is a set containing all
the symbols in the leaves that lie below.
</li>
<li>Each symbol at a leaf is assigned a weight (which is its relative
frequency).
</li>
<li>Each time we move down a left branch we add a 0; right branch, 1.
</li>
<li>Abstraction barrier
<ul class="org-ul">
<li>Procedures that perform e.g. arithmetic from the procedures
that use e.g. rational numbers.
</li>
</ul>
</li>
<li>Controlling complexity
</li>
<li>Type-tags
</li>
<li>Data-directed programming
</li>
<li>When a generic selector operates on thee e.g. polar type, it
strips off the tag.
</li>
<li>Conversely, when .. constructs a number for general use, .. tag     
it with a type.
</li>
<li>Dispatch on type has each operation takes care of own dispatching,
decomposing the operation-and-type table into rows, with each
generic operation procedure representing a row of the table.
</li>
<li>Alternatively, organize into columns and, instead of using
“intelligent operations” that dispatch on data types, work with
“intelligent data objects” that dispatch on names.
</li>
<li>We can get by with fewer than \(n^2\) coercion procedures. If we
are willing to build the required amount of sophistication into
our system, we can have it search the “graph” of relations among
types and automatically generate those coercion procedures that
can be inferred from the ones that are supplied explicitly.
</li>
<li>Sum of terms: either a coefficint, power of indeterminate,
product of coefficient and power of indeterminate.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> 3</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>The language must provide an assignment operator.
</li>
<li>Bang for mutation; quiz for predicates.
</li>
<li>As soon as we introduce assignment into our language, substitution
is no longuer an adequate model of procedure application.
</li>
<li>Environment is a sequence of frames; frame is a table of
bindings.
</li>
<li>Value of variable: value given by the binding of the variable in
the first frame in the environment that contains a binding.
</li>
<li>Unbound: no binding.
</li>
<li>Environmental model: replaces substitution model in specifying
what it means to apply a compound procedure to arguments.
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
This is an alternative to wastefully idling and polling, for
instance.
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Peter Danenberg</p>
<p class="email">Email: <a href="mailto:pcd@roxygen.org">pcd@roxygen.org</a></p>
<p class="date">Created: 2015-04-14 Tue 14:41</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
